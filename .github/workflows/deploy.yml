name: Deploy to Digital Ocean

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v1
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Run tests (–µ—Å–ª–∏ –µ—Å—Ç—å)
        run: bun test --if-present

      - name: Deploy to Digital Ocean
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          port: ${{ secrets.DO_PORT }}
          script: |
            set -euo pipefail
            echo "üöÄ Starting deployment..."

            # –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–∫—Ä—É–∂–µ–Ω–∏—è
            source /etc/environment || true
            export PATH=$PATH:/usr/local/bin:/usr/bin:/var/www/.bun/bin

            # –ü–µ—Ä–µ—Ö–æ–¥ –≤ –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—é –ø—Ä–æ–µ–∫—Ç–∞
            cd /var/www/psy_froggy_bot

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ PM2
            which pm2 || echo "‚ùå PM2 –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ PATH: $PATH"

            # –û—Å—Ç–∞–Ω–æ–≤–∫–∞ —Ç–µ–∫—É—â–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
            pm2 stop psy_froggy_bot || true

            # Backup –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö (–±–µ–∑ sudo)
            cp /var/www/databases/psy_froggy_bot/froggy.db /var/www/databases/psy_froggy_bot/froggy.db.backup.$(date +%Y%m%d_%H%M%S) || true

            # –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–æ–¥–∞
            git fetch origin
            git reset --hard origin/main

            # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π
            bun install --frozen-lockfile

            # –ó–∞–ø—É—Å–∫ –º–∏–≥—Ä–∞—Ü–∏–π
            bun run knex migrate:latest --knexfile knexfile.cjs

            # –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è —á–µ—Ä–µ–∑ PM2
            # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Å—É—â–µ—Å—Ç–≤—É–µ—Ç –ª–∏ –ø—Ä–æ—Ü–µ—Å—Å
            if pm2 describe psy_froggy_bot > /dev/null 2>&1; then
              echo "üîÑ –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –ø—Ä–æ—Ü–µ—Å—Å..."
              pm2 restart psy_froggy_bot
            else
              echo "üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º –Ω–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å..."
              pm2 start ecosystem.config.js --name psy_froggy_bot
            fi

            # –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—é PM2
            pm2 save

            # –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ Caddy (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)
            systemctl reload caddy || true

            # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—Ç–∞—Ç—É—Å–∞
            echo "üìä –°—Ç–∞—Ç—É—Å PM2:"
            pm2 status
            echo "üìä –°—Ç–∞—Ç—É—Å –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è:"
            pm2 describe psy_froggy_bot || true

            echo "‚úÖ Deployment completed!"

      - name: Notify on success
        if: success()
        run: |
          echo "üéâ Deployment successful!"

      - name: Notify on failure
        if: failure()
        run: |
          echo "‚ùå Deployment failed!"
