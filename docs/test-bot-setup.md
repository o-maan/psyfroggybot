# Настройка тестового бота

## Концепция разделения

✅ **Одна БД (`froggy.db`)** - все данные в одной базе
✅ **Разделение по CHANNEL_ID и CHAT_ID** - каждый бот работает со своим каналом/группой
✅ **Автоматическое разделение данных** - сообщения, посты, joy_sources привязаны к chat_id

## Структура

```
froggy.db (одна БД для всех)
├── users (chat_id: 476561547, -1002496122257, -1002798126153, ...)
├── messages (привязаны к user_id/chat_id)
├── joy_sources (привязаны к chat_id пользователя)
├── morning_posts (привязаны к chat_id канала)
└── forwardedMessages (привязаны к channelMessageId)
```

## Как работает разделение

### Основной бот (production)
- **CHANNEL_ID**: `-1002405993986` (основной канал)
- **CHAT_ID**: `-1002496122257` (основная группа комментариев)
- **Работает с**: пользователями и постами в основном канале

### Тестовый бот
- **CHANNEL_ID**: `-1002798126153` (тестовый канал/группа)
- **CHAT_ID**: `-1002798126153` (та же группа для комментариев)
- **Работает с**: пользователями и постами в тестовом канале

## Настройка для тестового бота

### Вариант 1: Использовать другой токен бота

```bash
# Запуск тестового бота с другим токеном
TELEGRAM_BOT_TOKEN=<тестовый_токен> \
CHANNEL_ID=-1002798126153 \
CHAT_ID=-1002798126153 \
bun run src/bot.ts
```

### Вариант 2: Создать .env.test

```bash
# .env.test
TELEGRAM_BOT_TOKEN=<тестовый_бот_токен>
CHANNEL_ID=-1002798126153
CHAT_ID=-1002798126153
ADMIN_CHAT_ID=476561547
# ... остальные переменные
```

```bash
# Запуск с .env.test
bun run --env-file=.env.test src/bot.ts
```

## Как данные разделяются

### 1. Посты и сообщения
- `forwardedMessages` Map хранит: `channelMessageId → forwardedMessageId`
- Каждый пост в своем канале имеет уникальный `channelMessageId`
- Боты не видят посты друг друга, т.к. работают с разными каналами

### 2. Joy-источники радости
```sql
-- Основной бот видит только свои источники
SELECT * FROM joy_sources WHERE chat_id = 476561547;

-- Даже если тестовый бот создаст источники для того же пользователя,
-- они привязаны к chat_id, поэтому разделены
```

### 3. Сообщения пользователей
```sql
-- Все сообщения хранятся в одной таблице messages
-- но привязаны к user_id и chat_id
-- Поэтому боты работают независимо
```

## Пример работы

### Основной бот (22:00 в воскресенье)
1. Создает пост в канале `-1002405993986`
2. Пересылает в группу `-1002496122257`
3. Сохраняет `forwardedMessages[625] = 5020`
4. Работает с пользователем `476561547` в контексте поста `625`

### Тестовый бот (ручной запуск /joy)
1. Создает пост в группе `-1002798126153`
2. Получает ID поста (например `5186`)
3. Сохраняет `forwardedMessages[629] = 5186`
4. Работает с тем же пользователем `476561547`, но в контексте поста `629`

### Результат
- ✅ Данные в одной БД
- ✅ Боты не пересекаются (разные channelMessageId)
- ✅ История сообщений разделена по постам
- ✅ Joy-источники привязаны к chat_id пользователя

## Миграции

При добавлении новых таблиц/колонок:

```bash
# Создаем миграцию
bun run knex migrate:make название_миграции

# Применяем к общей БД
bun run migrate

# Миграция автоматически применится к froggy.db
# Оба бота увидят новую структуру
```

## Проверка разделения

```bash
# Проверить пользователей
sqlite3 froggy.db "SELECT DISTINCT chat_id FROM users;"

# Проверить посты
sqlite3 froggy.db "SELECT channel_message_id, chat_id FROM morning_posts ORDER BY created_at DESC LIMIT 10;"

# Проверить joy-источники по пользователю
sqlite3 froggy.db "SELECT chat_id, COUNT(*) FROM joy_sources GROUP BY chat_id;"
```

## Важно

⚠️ **НЕ удалять данные в production БД** - все тесты делаем в тестовом канале/группе
⚠️ **Тестовый бот должен иметь свой TELEGRAM_BOT_TOKEN** - иначе конфликт
⚠️ **CHANNEL_ID и CHAT_ID должны быть разные** - иначе боты будут писать в один канал
