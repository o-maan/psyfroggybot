# –ü–ª–∞–Ω —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ "–°–ø–∏—Å–æ–∫ —Ä–∞–¥–æ—Å—Ç–∏ –≤ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ"

## üìã –û–ë–©–ê–Ø –õ–û–ì–ò–ö–ê

### –ß—Ç–æ –¥–µ–ª–∞–µ–º:
1. **–°–æ–±–∏—Ä–∞–µ–º –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è** –∏–∑ —É—Ç—Ä–µ–Ω–Ω–µ–π –∏ –≤–µ—á–µ—Ä–Ω–µ–π –ª—è–≥—É—à–∫–∏ –≤ —Ç–µ—á–µ–Ω–∏–µ –Ω–µ–¥–µ–ª–∏
2. **–í –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ** –≤–º–µ—Å—Ç–æ –æ–±—ã—á–Ω–æ–≥–æ –≤–µ—á–µ—Ä–Ω–µ–≥–æ –ø–æ—Å—Ç–∞ ‚Üí –ø–æ–∫–∞–∑—ã–≤–∞–µ–º /joy —Å –ø—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä–æ–º —Å–æ–±—ã—Ç–∏–π
3. **–ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è /joy** ‚Üí –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º –≤ —Ç–æ–º –∂–µ —Ç—Ä–µ–¥–µ —Å –æ–±—ã—á–Ω–æ–π –ª–æ–≥–∏–∫–æ–π –≤–µ—á–µ—Ä–Ω–µ–≥–æ –ø–æ—Å—Ç–∞
4. **–°–±—Ä–æ—Å —Å—á–µ—Ç—á–∏–∫–∞** –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø—Ä–∏ –ª—é–±–æ–º –∏–∑–º–µ–Ω–µ–Ω–∏–∏ —Å–ø–∏—Å–∫–∞ —Ä–∞–¥–æ—Å—Ç–∏

---

## üóÑÔ∏è –°–¢–†–£–ö–¢–£–†–ê –ë–î

### –¢–∞–±–ª–∏—Ü–∞ `positive_events`
```sql
CREATE TABLE positive_events (
  id INTEGER PRIMARY KEY,
  user_id INTEGER NOT NULL,
  event_text TEXT NOT NULL,           -- –¢–µ–∫—Å—Ç —Å–æ–±—ã—Ç–∏—è
  emotions_text TEXT,                  -- –¢–µ–∫—Å—Ç —ç–º–æ—Ü–∏–π (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º)
  created_at TEXT NOT NULL,            -- ISO timestamp
  post_type TEXT NOT NULL,             -- 'morning' –∏–ª–∏ 'evening'
  cycle_identifier TEXT,               -- ID —Ü–∏–∫–ª–∞ (channel_message_id)
  FOREIGN KEY (user_id) REFERENCES users(id)
)
```

### –¢–∞–±–ª–∏—Ü–∞ `joy_list_checkpoints`
```sql
CREATE TABLE joy_list_checkpoints (
  id INTEGER PRIMARY KEY,
  user_id INTEGER NOT NULL UNIQUE,
  checkpoint_time TEXT NOT NULL,       -- ISO timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Å–ø–∏—Å–∫–∞ —Ä–∞–¥–æ—Å—Ç–∏
  FOREIGN KEY (user_id) REFERENCES users(id)
)
```

---

## üîç –õ–û–ì–ò–ö–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø –ü–û–ó–ò–¢–ò–í–ù–´–• –°–û–ë–´–¢–ò–ô

### 1. –£–¢–†–ï–ù–ù–Ø–Ø –õ–Ø–ì–£–®–ö–ê

**–ì–¥–µ:** `src/handlers/callbacks/morning_respond.ts` ‚Üí –≤ –º–µ—Ç–æ–¥–µ `handleMorningRespond`

**–ú–æ–º–µ–Ω—Ç:** –ü–æ—Å–ª–µ —Ñ–∏–Ω–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ (–∫–æ–≥–¥–∞ `emotions_count >= 3`)

**–£—Å–ª–æ–≤–∏–µ:**
```typescript
if (analysisData.sentiment === 'positive' && analysisData.emotions_count >= 1) {
  // –°–æ—Ö—Ä–∞–Ω—è–µ–º
}
```

**–ß—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å:**
- `event_text` = `newCycleUserMessages` (–≤—Å–µ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –¢–ï–ö–£–©–ï–ú —Ü–∏–∫–ª–µ)
- `emotions_text` = –ø—É—Å—Ç–æ (—ç–º–æ—Ü–∏–∏ —É–∂–µ –≤ event_text, LLM —Å–∞–º –≤—ã—Ç–∞—â–∏—Ç –ø—Ä–∏ –ø–æ–∫–∞–∑–µ)
- `post_type` = `'morning'`
- `cycle_identifier` = `channelMessageId.toString()`

**–ö–æ–¥ (–ø—Ä–∏–º–µ—Ä–Ω–æ):**
```typescript
// –í handleMorningRespond –ø–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 169 (–ø–æ—Å–ª–µ fin–∞–ª—å–Ω–æ–≥–æ –æ—Ç–≤–µ—Ç–∞ —Å 3+ —ç–º–æ—Ü–∏—è–º–∏)
if (analysisData.sentiment === 'positive' && analysisData.emotions_count >= 1) {
  const { savePositiveEvent } = await import('../../db');
  savePositiveEvent(
    userId,
    newCycleUserMessages,
    '',
    'morning',
    channelMessageId.toString()
  );

  botLogger.info({ userId, channelMessageId }, '‚úÖ –ü–æ–∑–∏—Ç–∏–≤–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ (—É—Ç—Ä–æ)');
}
```

---

### 2. –í–ï–ß–ï–†–ù–Ø–Ø –õ–Ø–ì–£–®–ö–ê

**–ì–¥–µ:** `src/scheduler.ts` ‚Üí –º–µ—Ç–æ–¥ `handleInteractiveUserResponse`

**–ú–æ–º–µ–Ω—Ç:** –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –ø–ª—é—à–∫–∏

**–î–≤–∞ –º–µ—Å—Ç–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è:**

#### –ê) –ì–ª—É–±–æ–∫–∏–π —Å—Ü–µ–Ω–∞—Ä–∏–π (deep_waiting_positive)
**–°—Ç—Ä–æ–∫–∞:** ~4353

**–ü–æ—Å–ª–µ:** –ö–æ–≥–¥–∞ –æ–±—Ä–∞–±–æ—Ç–∞–ª–∏ –æ—Ç–≤–µ—Ç –∏ –∏–¥–µ–º –∫ –¥—ã—Ö–∞—Ç–µ–ª—å–Ω–æ–π –ø—Ä–∞–∫—Ç–∏–∫–µ

```typescript
// –ü–æ—Å–ª–µ —Å—Ç—Ä–æ–∫–∏ 4432 (–ø–æ—Å–ª–µ updateTaskStatus)
const { savePositiveEvent } = await import('./db');
savePositiveEvent(
  userId,
  messageText, // —Ç–µ–∫—Å—Ç –ø–ª—é—à–µ–∫
  '',
  'evening',
  channelMessageId.toString()
);

schedulerLogger.info({ userId, channelMessageId }, '‚úÖ –ü–æ–∑–∏—Ç–∏–≤–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–æ (–≤–µ—á–µ—Ä, –≥–ª—É–±–æ–∫–∏–π)');
```

#### –ë) –£–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π (waiting_positive)
**–ù–∞–π—Ç–∏ –≥–¥–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è –æ—Ç–≤–µ—Ç –Ω–∞ –ø–ª—é—à–∫–∏ –≤ —É–ø—Ä–æ—â–µ–Ω–Ω–æ–º —Å—Ü–µ–Ω–∞—Ä–∏–∏**

–ù—É–∂–Ω–æ –Ω–∞–π—Ç–∏ –º–µ—Å—Ç–æ –≥–¥–µ:
- `currentStep === 'waiting_positive'`
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–ø–∏—Å–∞–ª –æ—Ç–≤–µ—Ç
- –ë–æ—Ç –ø–µ—Ä–µ—Ö–æ–¥–∏—Ç –∫ —Å–ª–µ–¥—É—é—â–µ–º—É —ç—Ç–∞–ø—É

---

## üéØ –õ–û–ì–ò–ö–ê –í–û–°–ö–†–ï–°–ï–ù–¨–Ø

### –í –º–µ—Ç–æ–¥–µ `sendDailyMessage`

**–ò–∑–º–µ–Ω–µ–Ω–∏–µ (–ø—Ä–∏–º–µ—Ä–Ω–æ –Ω–∞ —Å—Ç—Ä–æ–∫–µ 1388):**

```typescript
async sendDailyMessage(chatId: number) {
  try {
    schedulerLogger.debug({ chatId }, '–ù–∞—á–∞–ª–æ –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏—è');

    const dayOfWeek = new Date().getDay();

    // –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ
    if (dayOfWeek === 0) {  // –í–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ
      await this.sendJoyPostWithWeeklySummary(chatId);
      return; // –í–ê–ñ–ù–û: –Ω–µ –ø—Ä–æ–¥–æ–ª–∂–∞–µ–º —Å –æ–±—ã—á–Ω—ã–º –ø–æ—Å—Ç–æ–º
    }

    // ... –¥–∞–ª–µ–µ –æ–±—ã—á–Ω–∞—è –ª–æ–≥–∏–∫–∞ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö –¥–Ω–µ–π
  } catch (error) {
    // ...
  }
}
```

---

## üìù –ù–û–í–´–ô –ú–ï–¢–û–î: sendJoyPostWithWeeklySummary

**–ì–¥–µ:** `src/scheduler.ts`

**–°—Ç—Ä—É–∫—Ç—É—Ä–∞:**

```typescript
async sendJoyPostWithWeeklySummary(userId: number) {
  try {
    schedulerLogger.info({ userId }, 'üåü –ù–∞—á–∞–ª–æ –≤–æ—Å–∫—Ä–µ—Å–Ω–æ–π –ª–æ–≥–∏–∫–∏ —Å–æ —Å–ø–∏—Å–∫–æ–º —Ä–∞–¥–æ—Å—Ç–∏');

    // 1. –ü–æ–ª—É—á–∞–µ–º timestamp –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ checkpoint
    const { getJoyCheckpoint } = await import('./db');
    const checkpoint = getJoyCheckpoint(userId);
    const checkpointTime = checkpoint?.checkpoint_time || new Date(0).toISOString();

    // 2. –ü–æ–ª—É—á–∞–µ–º –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ checkpoint
    const { getPositiveEventsSinceCheckpoint } = await import('./db');
    const events = getPositiveEventsSinceCheckpoint(userId, checkpointTime);

    schedulerLogger.info(
      { userId, eventsCount: events.length, checkpointTime },
      'üìä –ü–æ–∑–∏—Ç–∏–≤–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ checkpoint'
    );

    // 3. –ï—Å–ª–∏ —Å–æ–±—ã—Ç–∏–π –ù–ï–¢ ‚Üí –ø—Ä–æ–ø—É—Å–∫–∞–µ–º /joy –∏ —Å—Ä–∞–∑—É –∫ –æ–±—ã—á–Ω–æ–º—É –ø–æ—Å—Ç—É
    if (events.length === 0) {
      schedulerLogger.info({ userId }, '‚è≠Ô∏è –ù–µ—Ç –ø–æ–∑–∏—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π, –ø—Ä–æ–ø—É—Å–∫–∞–µ–º /joy');

      // –í—ã–∑—ã–≤–∞–µ–º –æ–±—ã—á–Ω—É—é –ª–æ–≥–∏–∫—É –≤–µ—á–µ—Ä–Ω–µ–≥–æ –ø–æ—Å—Ç–∞
      // –ù–û –ë–ï–ó –ø—Ä–æ–≤–µ—Ä–∫–∏ –Ω–∞ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ (–∏–Ω–∞—á–µ –∑–∞—Ü–∏–∫–ª–∏–º—Å—è)
      await this.sendDailyMessageRegular(userId);
      return;
    }

    // 4. –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–æ—Å—Ç /joy –≤ –∫–∞–Ω–∞–ª (–∫–∞–∫ —Å–µ–π—á–∞—Å)
    const fallbackImagePath = this.getNextImage(userId);
    const postText = '–î–∞–≤–∞–π —Å–æ–±–µ—Ä–µ–º —Ç–≤–æ–π –ª–∏—á–Ω—ã–π —Å–ø–∏—Å–æ–∫ —Ç–æ–≥–æ, —á—Ç–æ –ø—Ä–∏–Ω–æ—Å–∏—Ç —Ç–µ–±–µ —Ä–∞–¥–æ—Å—Ç—å –∏ –∑–∞—Ä—è–∂–∞–µ—Ç —ç–Ω–µ—Ä–≥–∏–µ–π ‚ö°Ô∏è\n\n–ü–µ—Ä–µ—Ö–æ–¥–∏ –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∏ –ø—Ä–æ–¥–æ–ª–∂–∏–º ü§ó';

    const imageBuffer = fs.readFileSync(fallbackImagePath);
    const channelMessage = await this.bot.telegram.sendPhoto(
      this.CHANNEL_ID,
      { source: imageBuffer },
      { caption: postText, parse_mode: 'HTML' }
    );

    const channelMessageId = channelMessage.message_id;

    // 5. –°–æ—Ö—Ä–∞–Ω—è–µ–º —Å–µ—Å—Å–∏—é /joy
    const commentsChatId = this.getChatId();
    this.joySessions.set(userId, {
      channelMessageId,
      userId,
      chatId: commentsChatId
    });

    // 6. –í –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è—Ö: –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è —á–µ—Ä–µ–∑ LLM
    const formattedEvents = await this.formatEventsWithLLM(events);

    const summaryText = `–ó–∞ —ç—Ç–æ –≤—Ä–µ–º—è —Ç—ã –¥–µ–ª–∏–ª—Å—è —Ç–∞–∫–∏–º–∏ –ø—Ä–∏—è—Ç–Ω—ã–º–∏ –º–æ–º–µ–Ω—Ç–∞–º–∏:\n\n${formattedEvents}\n\n<b>–•–æ—á–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å —á—Ç–æ-—Ç–æ –≤ —Å–≤–æ–π —Å–ø–∏—Å–æ–∫ —Ä–∞–¥–æ—Å—Ç–∏?</b> üíö`;

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–∏ –∫ –ø–æ—Å—Ç—É
    await this.sendJoyFirstMessageWithSummary(
      channelMessageId,
      userId,
      commentsChatId,
      summaryText
    );

    schedulerLogger.info({ userId, channelMessageId }, '‚úÖ –í–æ—Å–∫—Ä–µ—Å–Ω—ã–π –ø–æ—Å—Ç —Å–æ —Å–ø–∏—Å–∫–æ–º —Ä–∞–¥–æ—Å—Ç–∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');

    // 7. –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è /joy –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º ‚Üí –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–æ–ª–∂–∏–º —Å –≤–µ—á–µ—Ä–Ω–∏–º –ø–æ—Å—Ç–æ–º
    // –≠—Ç–æ –±—É–¥–µ—Ç –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è /joy

  } catch (error) {
    schedulerLogger.error({ error, userId }, '–û—à–∏–±–∫–∞ –≤–æ—Å–∫—Ä–µ—Å–Ω–æ–π –ª–æ–≥–∏–∫–∏ —Å–æ —Å–ø–∏—Å–∫–æ–º —Ä–∞–¥–æ—Å—Ç–∏');
    throw error;
  }
}
```

---

## üé® –§–û–†–ú–ê–¢–ò–†–û–í–ê–ù–ò–ï –°–û–ë–´–¢–ò–ô –ß–ï–†–ï–ó LLM

**–ú–µ—Ç–æ–¥:** `formatEventsWithLLM`

**–ü—Ä–æ–º–ø—Ç:** `assets/prompts/format-weekly-events.md`

```markdown
# –ü—Ä–æ–º–ø—Ç –¥–ª—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –ø–æ–∑–∏—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –Ω–µ–¥–µ–ª–∏

–¢—ã –ª—è–≥—É—à–∫–∞-–ø—Å–∏—Ö–æ–ª–æ–≥ (–º—É–∂—Å–∫–æ–≥–æ —Ä–æ–¥–∞). –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤ —Ç–µ—á–µ–Ω–∏–µ –≤—Ä–µ–º–µ–Ω–∏ –¥–µ–ª–∏–ª—Å—è —Å —Ç–æ–±–æ–π –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏ –∏ —ç–º–æ—Ü–∏—è–º–∏.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –∫—Ä–∞—Å–∏–≤–æ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ –æ—Ñ–æ—Ä–º–∏—Ç—å —ç—Ç–∏ —Å–æ–±—ã—Ç–∏—è –¥–ª—è –ø–æ–∫–∞–∑–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é.

–°–æ–±—ã—Ç–∏—è (–≤ —Ö—Ä–æ–Ω–æ–ª–æ–≥–∏—á–µ—Å–∫–æ–º –ø–æ—Ä—è–¥–∫–µ):
{{EVENTS}}

–¢–†–ï–ë–û–í–ê–ù–ò–Ø:
1. –°–≥—Ä—É–ø–ø–∏—Ä—É–π –ø–æ—Ö–æ–∂–∏–µ —Å–æ–±—ã—Ç–∏—è (–µ—Å–ª–∏ –µ—Å—Ç—å –ø–æ–≤—Ç–æ—Ä–µ–Ω–∏—è)
2. –û—Ñ–æ—Ä–º–∏ —Å–ø–∏—Å–∫–æ–º —Å —ç–º–æ–¥–∂–∏
3. –°–æ—Ö—Ä–∞–Ω–∏ —Å—É—Ç—å –∏ —ç–º–æ—Ü–∏–∏, –Ω–æ —Å–¥–µ–ª–∞–π —Ç–µ–∫—Å—Ç –ª–∞–∫–æ–Ω–∏—á–Ω—ã–º
4. –ú–∞–∫—Å–∏–º—É–º 10 –ø—É–Ω–∫—Ç–æ–≤ (–µ—Å–ª–∏ –±–æ–ª—å—à–µ - –æ–±—ä–µ–¥–∏–Ω–∏ –ø–æ—Ö–æ–∂–∏–µ)
5. –ò—Å–ø–æ–ª—å–∑—É–π HTML —Ä–∞–∑–º–µ—Ç–∫—É (<b>, <i>)
6. –ù–ï –¥–æ–±–∞–≤–ª—è–π –≤–≤–æ–¥–Ω—ã–µ —Ñ—Ä–∞–∑—ã —Ç–∏–ø–∞ "–í–æ—Ç —á—Ç–æ —Ç—ã –ø–∏—Å–∞–ª"
7. –¢–û–õ–¨–ö–û —Å–ø–∏—Å–æ–∫ —Å–æ–±—ã—Ç–∏–π

–ü—Ä–∏–º–µ—Ä —Ñ–æ—Ä–º–∞—Ç–∞:
‚Ä¢ üéâ <b>–£—Å–ø–µ—à–Ω–æ –∑–∞–≤–µ—Ä—à–∏–ª –ø—Ä–æ–µ–∫—Ç –Ω–∞ —Ä–∞–±–æ—Ç–µ</b> - —Ä–∞–¥–æ—Å—Ç—å, –≥–æ—Ä–¥–æ—Å—Ç—å
‚Ä¢ ‚òï <b>–£—Ç—Ä–µ–Ω–Ω–∏–π –∫–æ—Ñ–µ —Å –¥—Ä—É–≥–æ–º</b> - —Ç–µ–ø–ª–æ, —Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ
‚Ä¢ üéµ <b>–ö–æ–Ω—Ü–µ—Ä—Ç –ª—é–±–∏–º–æ–π –≥—Ä—É–ø–ø—ã</b> - –≤–æ—Å—Ç–æ—Ä–≥, –≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ

–í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Å–ø–∏—Å–æ–∫ –±–µ–∑ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤.
```

---

## üîÑ –°–ë–†–û–° –°–ß–ï–¢–ß–ò–ö–ê (CHECKPOINT)

**–ì–¥–µ:** –í `joy-handler.ts` ‚Üí –º–µ—Ç–æ–¥ `saveJoySources`

**–ü–æ—Å–ª–µ:** –°—Ç—Ä–æ–∫–∞ –≥–¥–µ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –∏—Å—Ç–æ—á–Ω–∏–∫–∏ —Ä–∞–¥–æ—Å—Ç–∏ –≤ –ë–î

```typescript
// –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ joy_sources
const { updateJoyCheckpoint } = await import('./db');
updateJoyCheckpoint(this.userId, new Date().toISOString());

botLogger.info({ userId: this.userId }, 'üîÑ Checkpoint —Å–ø–∏—Å–∫–∞ —Ä–∞–¥–æ—Å—Ç–∏ –æ–±–Ω–æ–≤–ª–µ–Ω');
```

**–¢–∞–∫–∂–µ:** –ü—Ä–∏ —Ä—É—á–Ω–æ–º –≤—ã–∑–æ–≤–µ `/joy` –∏ —É—Å–ø–µ—à–Ω–æ–º —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏

---

## üîó –ü–†–û–î–û–õ–ñ–ï–ù–ò–ï –° –í–ï–ß–ï–†–ù–ò–ú –ü–û–°–¢–û–ú

**–ì–¥–µ:** –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –ª–æ–≥–∏–∫–∏ /joy

**–í –º–µ—Ç–æ–¥–µ `saveJoySources` (joy-handler.ts):**

```typescript
// –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∏ –ø–æ–∫–∞–∑–∞ —Å–ø–∏—Å–∫–∞
// –ü—Ä–æ–≤–µ—Ä—è–µ–º: –µ—Å–ª–∏ —ç—Ç–æ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –ò –ø–æ—Å—Ç –∏–∑ –≤–æ—Å–∫—Ä–µ—Å–Ω–æ–π –ª–æ–≥–∏–∫–∏
const dayOfWeek = new Date().getDay();
if (dayOfWeek === 0) {
  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–≤—è–∑—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
  const transitionText = '–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π —Ä–∞–∑–±–µ—Ä–µ–º—Å—è —Å –¥–Ω–µ–º üí≠';

  await this.sendMessage(transitionText, this.lastButtonMessageId.get(sessionKey));

  // –ó–∞–ø—É—Å–∫–∞–µ–º –æ–±—ã—á–Ω—É—é –ª–æ–≥–∏–∫—É –≤–µ—á–µ—Ä–Ω–µ–≥–æ –ø–æ—Å—Ç–∞ –í –¢–û–ú –ñ–ï –¢–†–ï–î–ï
  const { Scheduler } = await import('./scheduler');
  // ... –≤—ã–∑–≤–∞—Ç—å –º–µ—Ç–æ–¥ –¥–ª—è –ø—Ä–æ–¥–æ–ª–∂–µ–Ω–∏—è –≤–µ—á–µ—Ä–Ω–µ–π –ª–æ–≥–∏–∫–∏
}
```

---

## üìä –§–£–ù–ö–¶–ò–ò –í db.ts

```typescript
// –°–æ—Ö—Ä–∞–Ω–∏—Ç—å –ø–æ–∑–∏—Ç–∏–≤–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ
export const savePositiveEvent = (
  userId: number,
  eventText: string,
  emotionsText: string,
  postType: 'morning' | 'evening',
  cycleIdentifier?: string
) => {
  const stmt = db.query(`
    INSERT INTO positive_events (user_id, event_text, emotions_text, created_at, post_type, cycle_identifier)
    VALUES (?, ?, ?, ?, ?, ?)
  `);

  stmt.run(userId, eventText, emotionsText, new Date().toISOString(), postType, cycleIdentifier || null);
};

// –ü–æ–ª—É—á–∏—Ç—å —Å–æ–±—ã—Ç–∏—è —Å –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ checkpoint
export const getPositiveEventsSinceCheckpoint = (userId: number, checkpointTime: string) => {
  const stmt = db.query(`
    SELECT * FROM positive_events
    WHERE user_id = ? AND created_at > ?
    ORDER BY created_at ASC
  `);

  return stmt.all(userId, checkpointTime) as any[];
};

// –ü–æ–ª—É—á–∏—Ç—å checkpoint –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
export const getJoyCheckpoint = (userId: number) => {
  const stmt = db.query(`
    SELECT * FROM joy_list_checkpoints WHERE user_id = ?
  `);

  return stmt.get(userId) as { checkpoint_time: string } | null;
};

// –û–±–Ω–æ–≤–∏—Ç—å checkpoint
export const updateJoyCheckpoint = (userId: number, checkpointTime: string) => {
  const stmt = db.query(`
    INSERT INTO joy_list_checkpoints (user_id, checkpoint_time)
    VALUES (?, ?)
    ON CONFLICT(user_id) DO UPDATE SET checkpoint_time = ?
  `);

  stmt.run(userId, checkpointTime, checkpointTime);
};
```

---

## ‚úÖ –ü–û–†–Ø–î–û–ö –†–ï–ê–õ–ò–ó–ê–¶–ò–ò

1. ‚úÖ –ú–∏–≥—Ä–∞—Ü–∏—è –ë–î (—Å–æ–∑–¥–∞—Ç—å —Ç–∞–±–ª–∏—Ü—ã)
2. ‚úÖ –§—É–Ω–∫—Ü–∏–∏ –≤ db.ts
3. ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –≤ —É—Ç—Ä–µ–Ω–Ω–µ–π –ª—è–≥—É—à–∫–µ
4. ‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–æ–±—ã—Ç–∏–π –≤ –≤–µ—á–µ—Ä–Ω–µ–π –ª—è–≥—É—à–∫–µ (–æ–±–∞ —Å—Ü–µ–Ω–∞—Ä–∏—è)
5. ‚úÖ –ü—Ä–æ–º–ø—Ç –¥–ª—è LLM —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
6. ‚úÖ –ú–µ—Ç–æ–¥ sendJoyPostWithWeeklySummary
7. ‚úÖ –ò–∑–º–µ–Ω–µ–Ω–∏–µ –ª–æ–≥–∏–∫–∏ –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å—è –≤ sendDailyMessage
8. ‚úÖ –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ checkpoint –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –≤ /joy
9. ‚úÖ –°–≤—è–∑—É—é—â–∞—è –ª–æ–≥–∏–∫–∞ –ø–æ—Å–ª–µ /joy ‚Üí –≤–µ—á–µ—Ä–Ω–∏–π –ø–æ—Å—Ç

---

## ‚ö†Ô∏è –í–ê–ñ–ù–´–ï –ù–Æ–ê–ù–°–´

1. **–ù–ï –¢–†–û–ì–ê–¢–¨** —Å—É—â–µ—Å—Ç–≤—É—é—â—É—é –ª–æ–≥–∏–∫—É /joy –∫–Ω–æ–ø–æ–∫
2. **–°–û–•–†–ê–ù–Ø–¢–¨** –ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ —Å —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–º –∫–æ–¥–æ–º
3. **–ò–°–ü–û–õ–¨–ó–û–í–ê–¢–¨** —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã –æ—Ç–ø—Ä–∞–≤–∫–∏ (reply_parameters –¥–ª—è —Ç–µ–∫—Å—Ç–∞)
4. **–ù–ï –î–û–ë–ê–í–õ–Ø–¢–¨** –Ω–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –º–µ—Ç–æ–¥—ã
5. **–¢–ï–°–¢–ò–†–û–í–ê–¢–¨** –∫–∞–∂–¥—ã–π —à–∞–≥ –æ—Ç–¥–µ–ª—å–Ω–æ

---

## üß™ –ö–ê–ö –¢–ï–°–¢–ò–†–û–í–ê–¢–¨

1. –°–æ–∑–¥–∞—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —É—Ç—Ä–µ–Ω–Ω–∏—Ö –ø–æ—Å—Ç–æ–≤ —Å –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏
2. –°–æ–∑–¥–∞—Ç—å –≤–µ—á–µ—Ä–Ω–∏–π –ø–æ—Å—Ç —Å –ø–ª—é—à–∫–∞–º–∏
3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Å–æ–±—ã—Ç–∏—è —Å–æ—Ö—Ä–∞–Ω–∏–ª–∏—Å—å –≤ –ë–î:
   ```sql
   SELECT * FROM positive_events WHERE user_id = [USER_ID];
   ```
4. –í –≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ –ø—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ:
   - –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è /joy –≤–º–µ—Å—Ç–æ –æ–±—ã—á–Ω–æ–≥–æ –ø–æ—Å—Ç–∞
   - –°–æ–±—ã—Ç–∏—è –∫—Ä–∞—Å–∏–≤–æ –æ—Ç—Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω—ã
   - –ü–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è /joy –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç—Å—è –≤–µ—á–µ—Ä–Ω–∏–π –ø–æ—Å—Ç
5. –ü–æ—Å–ª–µ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ /joy –ø—Ä–æ–≤–µ—Ä–∏—Ç—å checkpoint:
   ```sql
   SELECT * FROM joy_list_checkpoints WHERE user_id = [USER_ID];
   ```
6. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –Ω–æ–≤—ã–µ —Å–æ–±—ã—Ç–∏—è —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ü–û–°–õ–ï checkpoint

---

## üìù –î–û–ü–û–õ–ù–ò–¢–ï–õ–¨–ù–û

### –°–≤—è–∑—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (–ø—Ä–æ–¥—É–º–∞–µ–º –ø–æ–∑–∂–µ)
–ú–µ–∂–¥—É –∑–∞–≤–µ—Ä—à–µ–Ω–∏–µ–º /joy –∏ –Ω–∞—á–∞–ª–æ–º –≤–µ—á–µ—Ä–Ω–µ–≥–æ –ø–æ—Å—Ç–∞ –Ω—É–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –ø–ª–∞–≤–Ω—ã–π –ø–µ—Ä–µ—Ö–æ–¥.

–í–∞—Ä–∏–∞–Ω—Ç—ã:
- "–û—Ç–ª–∏—á–Ω–æ! –¢–µ–ø–µ—Ä—å –¥–∞–≤–∞–π —Ä–∞–∑–±–µ—Ä–µ–º—Å—è —Å –¥–Ω–µ–º üí≠"
- "–•–æ—Ä–æ—à–æ! –ê —Ç–µ–ø–µ—Ä—å –ø–æ–¥–µ–ª–∏—Å—å, –∫–∞–∫ –ø—Ä–æ—à–µ–ª –¥–µ–Ω—å ü§ó"
- "–ó–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ! –¢–µ–ø–µ—Ä—å –∫ –æ—Å–Ω–æ–≤–Ω–æ–º—É üê∏"

### –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–ø—É—Å—Ç–∏–ª /joy
–í –ª–æ–≥–∏–∫–µ JoyHandler –µ—Å—Ç—å –∫–Ω–æ–ø–∫–∏ –ø—Ä–æ–ø—É—Å–∫–∞ - —Ç–∞–º —Ç–æ–∂–µ –Ω—É–∂–Ω–æ –ø—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å –≤–µ—á–µ—Ä–Ω–∏–º –ø–æ—Å—Ç–æ–º.
