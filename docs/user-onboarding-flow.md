# –ü–æ—Ç–æ–∫ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞

## üéØ –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∏ –≤–∞–∂–Ω–∞—è –ª–æ–≥–∏–∫–∞

**–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –¢–û–õ–¨–ö–û –ø–æ—Å–ª–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞!**

## üìã –ü–æ–ª–Ω—ã–π –ø–æ—Ç–æ–∫ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:

### 1. –ö–æ–º–∞–Ω–¥–∞ `/start`

**–§–∞–π–ª:** [src/commands/user/start.ts](../src/commands/user/start.ts)

```typescript
// –î–æ–±–∞–≤–ª—è–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏
scheduler.addUser(chatId);

// üÜï –í–∫–ª—é—á–∞–µ–º —Ä–µ–∂–∏–º –ª–∏—á–Ω—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (–õ–°) –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
enableDMMode(chatId);
botLogger.info({ userId, chatId }, '‚úÖ –†–µ–∂–∏–º –õ–° –≤–∫–ª—é—á–µ–Ω –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
```

**–ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç:**
- –°–æ–∑–¥–∞–µ—Ç—Å—è –∑–∞–ø–∏—Å—å –≤ –ë–î: `dm_enabled=0, channel_enabled=0`
- –ó–∞—Ç–µ–º –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è `enableDMMode(chatId)`: `dm_enabled=1`
- **–ò—Ç–æ–≥:** `dm_enabled=1, channel_enabled=0` ‚úÖ

### 2. –û–Ω–±–æ—Ä–¥–∏–Ω–≥ (—Å–±–æ—Ä –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ)

**–§–∞–π–ª—ã:**
- [src/handlers/callbacks/onboarding.ts](../src/handlers/callbacks/onboarding.ts)
- [src/handlers/messages/onboarding.ts](../src/handlers/messages/onboarding.ts)

**–®–∞–≥–∏:**
1. –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∫–Ω–æ–ø–∫–æ–π "–í–ø–µ—Ä–µ–¥ üöÄ"
2. –ó–∞–ø—Ä–æ—Å –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
3. –ó–∞–ø—Ä–æ—Å –ø–æ–ª–∞ (–º—É–∂—Å–∫–æ–π/–∂–µ–Ω—Å–∫–∏–π)
4. –ó–∞–ø—Ä–æ—Å –≥–æ—Ä–æ–¥–∞ (–¥–ª—è –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–∏—è timezone)
5. –ó–∞–ø—Ä–æ—Å —Ü–µ–ª–µ–π/–∑–∞–ø—Ä–æ—Å–∞ (—Å –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å—é –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å)

**–°–æ—Å—Ç–æ—è–Ω–∏—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞ –≤ –ë–î:**
- `waiting_start` ‚Üí `waiting_name` ‚Üí `waiting_gender` ‚Üí `waiting_city` ‚Üí `waiting_request` ‚Üí `null` (–∑–∞–≤–µ—Ä—à–µ–Ω)

### 3. –ó–∞–≤–µ—Ä—à–µ–Ω–∏–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞

**–§–∞–π–ª:** [src/handlers/messages/onboarding.ts:189-222](../src/handlers/messages/onboarding.ts#L189-L222)

```typescript
// –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–Ω–±–æ—Ä–¥–∏–Ω–≥
updateOnboardingState(chatId, null);

// –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
const finalMessage = generateOnboardingFinalMessage(userName, userTimezone, userTimezoneOffset);

// –û—Ç–ø—Ä–∞–≤–ª—è–µ–º "–í—Å–µ –≥–æ—Ç–æ–≤–æ, —É—Ä–∞ üéâ..."
await ctx.reply(finalMessage.text, finalMessage.buttons);
```

**–§–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ:**

```
–í—Å–µ –≥–æ—Ç–æ–≤–æ, —É—Ä–∞ üéâ
–í—Å—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–µ–±–µ –º–æ–∂–Ω–æ –∏–∑–º–µ–Ω–∏—Ç—å –ø–æ –∫–æ–º–∞–Ω–¥–µ /me

–†–∞–¥, —á—Ç–æ —Ç—ã –Ω–∞ —ç—Ç–æ–º –ø—É—Ç–∏ üë£ –Ø –±—É–¥—É —Ä—è–¥–æ–º! ü§ó

[–î–∞–ª–µ–µ —Ç–µ–∫—Å—Ç –∑–∞–≤–∏—Å–∏—Ç –æ—Ç –≤—Ä–µ–º–µ–Ω–∏ —Å—É—Ç–æ–∫...]
```

### 4. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Ä–∞—Å—Å—ã–ª–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è!

**–ö–æ–≥–¥–∞:** –ü—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞ ([scheduler.ts:9063-9103](../src/scheduler.ts#L9063-L9103))

**–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç —Ñ–∏–ª—å—Ç—Ä:**

```typescript
const allUsers = getAllUsers();

// ‚úÖ –§–ò–õ–¨–¢–†–£–ï–ú: —Ç–æ–ª—å–∫–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –≤–∫–ª—é—á–µ–Ω–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–æ–π
const users = allUsers.filter(user => {
  const isRealUser = user.chat_id > 0; // –ù–ï –≥—Ä—É–ø–ø–∞
  const hasDeliveryEnabled = user.dm_enabled === 1 || user.channel_enabled === 1;
  return isRealUser && hasDeliveryEnabled;
});
```

**–†–µ–∑—É–ª—å—Ç–∞—Ç:**
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å `dm_enabled=1` –ø–æ–ø–∞–¥–∞–µ—Ç –≤ —Å–ø–∏—Å–æ–∫ —Ä–∞—Å—Å—ã–ª–∫–∏
- –î–ª—è –Ω–µ–≥–æ —Å–æ–∑–¥–∞—é—Ç—Å—è cron jobs –ø–æ timezone
- –ü–æ—Å—Ç—ã –Ω–∞—á–∏–Ω–∞—é—Ç –ø—Ä–∏—Ö–æ–¥–∏—Ç—å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏

## üïê –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ —Ä–∞—Å—Å—ã–ª–∫–∏

### –í–µ—á–µ—Ä–Ω–∏–µ –ø–æ—Å—Ç—ã (20:00 –ø–æ timezone –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):
- –ò–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–π –ø–æ—Å—Ç —Å –∑–∞–¥–∞–Ω–∏—è–º–∏
- –û—Ç–ø—Ä–∞–≤–∫–∞ –≤ –∫–∞–Ω–∞–ª (–µ—Å–ª–∏ `channel_enabled=1`) –∏–ª–∏ –õ–° (–µ—Å–ª–∏ `dm_enabled=1`)

### –£—Ç—Ä–µ–Ω–Ω–∏–µ –ø–æ—Å—Ç—ã (9:00 –ø–æ timezone –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):
- –ü—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏–µ –∏ –∑–∞–¥–∞–Ω–∏—è –Ω–∞ –¥–µ–Ω—å
- –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ –æ—Ç–≤–µ—Ç–∞ –Ω–∞ –≤–µ—á–µ—Ä–Ω–∏–π –ø–æ—Å—Ç

### –ó–ª—ã–µ –ø–æ—Å—Ç—ã (8:00 –ø–æ timezone –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è):
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ù–ï –æ—Ç–≤–µ—Ç–∏–ª –Ω–∞ –≤–µ—á–µ—Ä–Ω–∏–π –ø–æ—Å—Ç
- –ú–æ—Ç–∏–≤–∏—Ä—É—é—â–µ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ

### JOY –ø–æ—Å—Ç—ã (–≤–æ—Å–∫—Ä–µ—Å–µ–Ω—å–µ, 20:00):
- –í–º–µ—Å—Ç–æ –æ–±—ã—á–Ω–æ–≥–æ –≤–µ—á–µ—Ä–Ω–µ–≥–æ –ø–æ—Å—Ç–∞
- –†–∞–±–æ—Ç–∞ —Å–æ —Å–ø–∏—Å–∫–æ–º –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤ —Ä–∞–¥–æ—Å—Ç–∏

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç–∏ —Ä–∞–±–æ—Ç—ã

### –¢–µ—Å—Ç—ã:

```bash
# –¢–µ—Å—Ç —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
bun test src/user-registration.test.ts

# –¢–µ—Å—Ç –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
bun test src/scheduler-initialization.test.ts
```

### –†—É—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î:

```sql
-- –ü–æ—Å–º–æ—Ç—Ä–µ—Ç—å –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è —Ä–∞—Å—Å—ã–ª–∫–∏
SELECT chat_id, username, name, dm_enabled, channel_enabled, timezone
FROM users
WHERE chat_id > 0
  AND (dm_enabled = 1 OR channel_enabled = 1);
```

### –õ–æ–≥–∏ –ø—Ä–∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞:

```
üåç –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è timezone-based –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫–∞
üë• –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π (—Ç–æ–ª—å–∫–æ —Å –≤–∫–ª—é—á–µ–Ω–Ω–æ–π –¥–æ—Å—Ç–∞–≤–∫–æ–π)
   - totalUsersInDb: 7
   - actualUsers: 5
   - filteredGroups: 2
   - filteredNoDelivery: 0
üìä –†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø–æ timezone
   - uniqueTimezones: 2
   - timezones: ["Europe/Moscow", "Europe/Belgrade"]
‚úÖ Timezone-based –ø–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω
```

## üö® –í–∞–∂–Ω—ã–µ –º–æ–º–µ–Ω—Ç—ã

1. **–†–∞—Å—Å—ã–ª–∫–∞ –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –ü–û–°–õ–ï –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞**, –ù–ï —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ `/start`
2. **–§–ª–∞–≥ `dm_enabled=1` —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç—Å—è –ø—Ä–∏ `/start`, –ù–ï –ø–æ—Å–ª–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞**
3. **–ü–ª–∞–Ω–∏—Ä–æ–≤—â–∏–∫ —Ñ–∏–ª—å—Ç—Ä—É–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å `dm_enabled=1 –ò–õ–ò channel_enabled=1`**
4. **–ì—Ä—É–ø–ø—ã (`chat_id < 0`) –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∏—Å–∫–ª—é—á–∞—é—Ç—Å—è –∏–∑ —Ä–∞—Å—Å—ã–ª–∫–∏**
5. **Timezone –æ–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –ø–æ –≥–æ—Ä–æ–¥—É –≤–æ –≤—Ä–µ–º—è –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞**

## üìä –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞

**–¢–µ–∫—É—â–∏–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –≤ –ë–î:**
- –ì—Ä—É–ø–ø—ã: 2 (–∏—Å–∫–ª—é—á–µ–Ω—ã –∏–∑ —Ä–∞—Å—Å—ã–ª–∫–∏)
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ —Å –¥–æ—Å—Ç–∞–≤–∫–æ–π: 5
- –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ –±–µ–∑ –¥–æ—Å—Ç–∞–≤–∫–∏: 0

**–†–∞—Å–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –ø–æ —Ä–µ–∂–∏–º–∞–º –¥–æ—Å—Ç–∞–≤–∫–∏:**
- `dm_enabled=1, channel_enabled=1`: 2 (—Ü–µ–ª–µ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)
- `dm_enabled=1, channel_enabled=0`: 3 (–æ–±—ã—á–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏)
- `dm_enabled=0, channel_enabled=0`: 0 (–Ω–µ –ø–æ–ª—É—á–∞—é—Ç —Ä–∞—Å—Å—ã–ª–∫—É)

## üîß –ö–æ–º–∞–Ω–¥—ã –¥–ª—è —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –¥–æ—Å—Ç–∞–≤–∫–æ–π

### –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –õ–°:
```typescript
import { enableDMMode, disableDMMode } from './db';

enableDMMode(chatId);   // –í–∫–ª—é—á–∏—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É –≤ –õ–°
disableDMMode(chatId);  // –í—ã–∫–ª—é—á–∏—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É –≤ –õ–°
```

### –í–∫–ª—é—á–∏—Ç—å/–≤—ã–∫–ª—é—á–∏—Ç—å –∫–∞–Ω–∞–ª:
```typescript
import { enableChannelMode, disableChannelMode } from './db';

enableChannelMode(chatId);   // –í–∫–ª—é—á–∏—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É –≤ –∫–∞–Ω–∞–ª
disableChannelMode(chatId);  // –í—ã–∫–ª—é—á–∏—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É –≤ –∫–∞–Ω–∞–ª
```

### SQL –∫–æ–º–∞–Ω–¥—ã:
```sql
-- –í–∫–ª—é—á–∏—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É –≤ –õ–°
UPDATE users SET dm_enabled = 1 WHERE chat_id = 123456;

-- –í–∫–ª—é—á–∏—Ç—å –¥–æ—Å—Ç–∞–≤–∫—É –≤ –∫–∞–Ω–∞–ª (–¥–ª—è —Ü–µ–ª–µ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π)
UPDATE users SET channel_enabled = 1 WHERE chat_id = 476561547;
```
