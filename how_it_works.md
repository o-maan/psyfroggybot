# Как работает система интерактивных заданий

## ВАЖНО: Автоматическое восстановление после сбоев

При запуске бота автоматически проверяются все незавершенные задания за последние 7 дней. Если пользователь уже ответил, но не получил следующее задание из-за технических проблем, бот автоматически отправит недостающий ответ!

## Архитектура

1. **Хранение данных** - все состояния хранятся в БД в таблице `interactive_posts`
2. **Идентификация постов** - используется `channel_message_id` (ID сообщения в канале)
3. **Кнопки** - в callback_data передается `channel_message_id`
4. **Сессии в памяти** - БОЛЬШЕ НЕ ИСПОЛЬЗУЮТСЯ!

## Сценарии работы

### 1. Новый пост отправлен
1. Пост публикуется в канал
2. Первое задание отправляется в комментарии с кнопкой
3. Данные сохраняются в БД: `saveInteractivePost(messageId, userId, json, relaxationType)`

### 2. Пользователь отвечает на задание (даже через несколько дней!)
1. Бот получает сообщение с `messageThreadId` (это ID треда комментариев)
2. `handleInteractiveUserResponse` вызывается
3. Бот пытается найти пост:
   - Сначала по `messageThreadId` через `getInteractivePost(messageThreadId)`
   - Если не нашел - берет последний незавершенный через `getUserIncompletePosts(userId)`
4. Определяет текущий шаг через состояние в БД
5. Отправляет ответ в тот же тред используя `message_thread_id`

### 3. Пользователь нажимает кнопку (даже через неделю!)
1. Из callback_data извлекается `channel_message_id`
2. Данные загружаются из БД: `getInteractivePost(channelMessageId)`
3. Выполняется действие и обновляется БД

## Важные моменты

1. **messageThreadId = channelMessageId** - в Telegram ID треда комментариев совпадает с ID поста в канале
2. **Работает для ЛЮБЫХ старых постов** - данные хранятся в БД постоянно
3. **Нет таймаутов** - пользователь может выполнить задание в любое время
4. **reply_to_message_id vs message_thread_id**:
   - `reply_to_message_id` - для ответа на конкретное сообщение
   - `message_thread_id` - для отправки в конкретный тред комментариев

## Состояния заданий в БД

- `task1_completed` - выполнено первое задание (выгрузка негатива)
- `task2_completed` - выполнено второе задание (плюшки)
- `task3_completed` - выполнено третье задание (практика)
- `trophy_set` - установлен трофей на пост

## Определение текущего шага

```typescript
if (!task1_completed) return 'waiting_negative';
if (task1_completed && !task2_completed) return 'waiting_positive';
if (task2_completed && !task3_completed) return 'waiting_practice';
return 'finished';
```