import { Telegraf } from 'telegraf';
import { Scheduler } from '../../scheduler';
import { botLogger } from '../../logger';

/**
 * –ö–æ–º–∞–Ω–¥–∞ /joy_1 - —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –û–°–ù–û–í–ù–û–ì–û —Å—Ü–µ–Ω–∞—Ä–∏—è Joy (–≤–æ—Å–∫—Ä–µ—Å–Ω—ã–π –ø–æ—Å—Ç)
 * –ê–î–ú–ò–ù–°–ö–ê–Ø –ö–û–ú–ê–ù–î–ê
 *
 * –¢—Ä–µ–±–æ–≤–∞–Ω–∏—è –¥–ª—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–π —Ä–∞–±–æ—Ç—ã:
 * 1. –°–ø–∏—Å–æ–∫ —Ä–∞–¥–æ—Å—Ç–∏ –¥–æ–ª–∂–µ–Ω –±—ã—Ç—å –ù–ï –ø—É—Å—Ç—ã–º (—Ö–æ—Ç—è –±—ã 1 –ø—É–Ω–∫—Ç)
 * 2. –ñ–µ–ª–∞—Ç–µ–ª—å–Ω–æ –Ω–∞–ª–∏—á–∏–µ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π –≤ –ë–î (–Ω–æ –Ω–µ –æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)
 */
export function registerJoy1Command(bot: Telegraf, scheduler: Scheduler) {
  bot.command('joy_1', async ctx => {
    const userId = ctx.from?.id;
    const adminChatId = parseInt(process.env.ADMIN_CHAT_ID || '0');

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –∫–æ–º–∞–Ω–¥—É –≤—ã–∑—ã–≤–∞–µ—Ç –∞–¥–º–∏–Ω
    if (userId !== adminChatId) {
      botLogger.warn({ userId, adminChatId }, '‚õî –ü–æ–ø—ã—Ç–∫–∞ –≤—ã–∑–≤–∞—Ç—å –∞–¥–º–∏–Ω—Å–∫—É—é –∫–æ–º–∞–Ω–¥—É /joy_1 –Ω–µ –∞–¥–º–∏–Ω–æ–º');
      await ctx.reply('‚ùå –≠—Ç–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞ —Ç–æ–ª—å–∫–æ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä—É');
      return;
    }

    try {
      botLogger.info({ userId }, 'üß™ –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –û–°–ù–û–í–ù–û–ì–û —Å—Ü–µ–Ω–∞—Ä–∏—è Joy (–∫–æ–º–∞–Ω–¥–∞ /joy_1)');

      await ctx.reply('üß™ –¢–µ—Å—Ç–∏—Ä—É–µ–º —Å—Ü–µ–Ω–∞—Ä–∏–π Joy...');

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –Ω–µ –ø—É—Å—Ç–æ–π –ª–∏ —Å–ø–∏—Å–æ–∫ —Ä–∞–¥–æ—Å—Ç–∏
      const { isJoyListEmpty } = await import('../../db');
      const isEmpty = isJoyListEmpty(userId);

      if (isEmpty) {
        await ctx.reply('‚ÑπÔ∏è –°–ø–∏—Å–æ–∫ —Ä–∞–¥–æ—Å—Ç–∏ –ø—É—Å—Ç–æ–π - –≤–≤–æ–¥–Ω–∞—è –ª–æ–≥–∏–∫–∞ Joy');
      } else {
        await ctx.reply('‚ÑπÔ∏è –°–ø–∏—Å–æ–∫ —Ä–∞–¥–æ—Å—Ç–∏ –∑–∞–ø–æ–ª–Ω–µ–Ω - –æ—Å–Ω–æ–≤–Ω–∞—è –ª–æ–≥–∏–∫–∞ Joy');
      }

      // –í—ã–∑—ã–≤–∞–µ–º –º–µ—Ç–æ–¥ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤–æ—Å–∫—Ä–µ—Å–Ω–æ–≥–æ –ø–æ—Å—Ç–∞ –° –ü–†–û–ü–£–°–ö–û–ú –ø—Ä–æ–≤–µ—Ä–∫–∏ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π
      await scheduler.sendJoyPostWithWeeklySummary(userId, true);

      await ctx.reply('–°—Ü–µ–Ω–∞—Ä–∏–π Joy –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω! ‚òëÔ∏è');

      botLogger.info({ userId }, '–¢–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –û–°–ù–û–í–ù–û–ì–û —Å—Ü–µ–Ω–∞—Ä–∏—è Joy –∑–∞–≤–µ—Ä—à–µ–Ω–æ ‚òëÔ∏è');
    } catch (error) {
      const err = error as Error;
      botLogger.error(
        {
          error: err.message,
          stack: err.stack,
          userId,
        },
        '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –û–°–ù–û–í–ù–û–ì–û —Å—Ü–µ–Ω–∞—Ä–∏—è Joy'
      );
      await ctx.reply(`‚ùå –û—à–∏–±–∫–∞: ${err.message}`);
    }
  });
}
