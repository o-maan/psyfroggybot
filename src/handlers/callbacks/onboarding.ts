import { Telegraf, Markup } from 'telegraf';
import { botLogger } from '../../logger';
import { getUserByChatId, updateOnboardingState, updateUserGender, updateUserRequest } from '../../db';

/**
 * –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–í–ø–µ—Ä–µ–¥ üöÄ" –≤ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–µ–Ω–Ω–æ–º —Å–æ–æ–±—â–µ–Ω–∏–∏
 */
export function registerOnboardingStartCallback(bot: Telegraf) {
  bot.action('onboarding_start', async ctx => {
    const chatId = ctx.chat?.id;
    if (!chatId) {
      botLogger.error({}, '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å chatId –∏–∑ callback');
      return;
    }

    const userId = ctx.from?.id || 0;
    botLogger.info({ userId, chatId }, 'üöÄ –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–∞–∂–∞–ª –∫–Ω–æ–ø–∫—É "–í–ø–µ—Ä–µ–¥"');

    try {
      // –£–¥–∞–ª—è–µ–º –∫–Ω–æ–ø–∫—É –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–µ–≥–æ —Å–æ–æ–±—â–µ–Ω–∏—è (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º caption)
      await ctx.editMessageCaption(
        `–ö–≤–∞–∫! üê∏
–Ø —Ç–≤–æ–π –ª—è–≥—É—à–∫–∞-–ø—Å–∏—Ö–æ–ª–æ–≥

–Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã –ø–æ–º–æ–≥–∞—Ç—å —Ç–µ–±–µ –±—ã—Ç—å —á—É—Ç—å –±–ª–∏–∂–µ –∫ —Å–µ–±–µ, –∑–∞–º–µ—á–∞—Ç—å —Å–≤–æ–∏ —á—É–≤—Å—Ç–≤–∞ –∏ –¥–µ–ª–∞—Ç—å –∂–∏–∑–Ω—å –ª—É—á—à–µ üí´

–í–µ—Å—å –¥–µ–Ω—å —è –±—É–¥—É —Ä—è–¥–æ–º, —á—Ç–æ–±—ã –≤—ã—Å–ª—É—à–∞—Ç—å, –∞ –∫–∞–∂–¥—ã–π –≤–µ—á–µ—Ä ‚Äì –ø—Ä–∏—Å—ã–ª–∞—Ç—å –Ω–µ–±–æ–ª—å—à–∏–µ –∑–∞–¥–∞–Ω–∏—è. –†–∞–±–æ—Ç–∞ —Å–æ —Å–≤–æ–∏–º –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º –º–∏—Ä–æ–º –º–æ–∂–µ—Ç –∏–∑–º–µ–Ω–∏—Ç—å –º–Ω–æ–≥–æ–µ üòä`
      );
    } catch (error) {
      botLogger.warn({ error }, '‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ (–≤–æ–∑–º–æ–∂–Ω–æ, –æ–Ω–æ —É–∂–µ –∏–∑–º–µ–Ω–µ–Ω–æ)');
    }

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –∏–º–µ–Ω–∏
    await ctx.reply(
      `–ö–∞–∫ –º–Ω–µ —Ç–µ–±—è –Ω–∞–∑—ã–≤–∞—Ç—å?
<b>–ù–∞–ø–∏—à–∏ —Å–≤–æ–µ –∏–º—è</b> –∏–ª–∏ –º–æ–∂–µ—à—å –ø—Ä–∏–¥—É–º–∞—Ç—å –ø—Ä–æ–∑–≤–∏—â–µ üôÉ`,
      { parse_mode: 'HTML' }
    );

    // –û–±–Ω–æ–≤–ª—è–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ –æ–Ω–±–æ—Ä–¥–∏–Ω–≥–∞
    updateOnboardingState(chatId, 'waiting_name');
    botLogger.info({ userId, chatId }, '‚úÖ –û–∂–∏–¥–∞–µ–º –≤–≤–æ–¥ –∏–º–µ–Ω–∏ –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è');
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ –ø–æ–ª–∞ - –ú—É–∂—Å–∫–æ–π
  bot.action('onboarding_gender_male', async ctx => {
    const chatId = ctx.chat?.id;
    if (!chatId) {
      botLogger.error({}, '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å chatId –∏–∑ callback');
      return;
    }

    const userId = ctx.from?.id || 0;
    botLogger.info({ userId, chatId }, 'üë® –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –º—É–∂—Å–∫–æ–π –ø–æ–ª');

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª –≤ –ë–î
    updateUserGender(chatId, 'male');

    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∑–∞–ø—Ä–æ—Å—É —Ü–µ–ª–µ–π
    updateOnboardingState(chatId, 'waiting_request');

    // –û—Ç–≤–µ—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await ctx.answerCbQuery('–û—Ç–ª–∏—á–Ω–æ! üôãüèª');

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –æ —Ü–µ–ª—è—Ö —Å –∫–Ω–æ–ø–∫–æ–π "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å"
    await ctx.reply(
      `–ê —Ä–∞—Å—Å–∫–∞–∂–∏ –º–Ω–µ –æ —Å–≤–æ–µ–º –∑–∞–ø—Ä–æ—Å–µ, —á—Ç–æ —Ç–µ–±—è –±–µ—Å–ø–æ–∫–æ–∏—Ç, —á—Ç–æ —Ö–æ—á–µ—à—å —É–ª—É—á—à–∏—Ç—å, –∫ —á–µ–º—É –ø—Ä–∏–π—Ç–∏?\n\n<i>–ú–æ–∂–µ—Ç –ª—É—á—à–µ –ø–æ–Ω–∏–º–∞—Ç—å —Å–µ–±—è, —Å–Ω–∏–∑–∏—Ç—å —Å—Ç—Ä–µ—Å—Å –∏–ª–∏ –ø—Ä–∏–π—Ç–∏ –∫ –±–∞–ª–∞–Ω—Å—É –≤ –∂–∏–∑–Ω–∏</i>`,
      {
        parse_mode: 'HTML',
        ...Markup.inlineKeyboard([
          [Markup.button.callback('–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å', 'onboarding_skip_request')]
        ])
      }
    );

    botLogger.info({ userId, chatId, gender: 'male' }, '‚úÖ –ó–∞–ø—Ä–æ—Å —Ü–µ–ª–µ–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ –≤—ã–±–æ—Ä–∞ –ø–æ–ª–∞ - –ñ–µ–Ω—Å–∫–∏–π
  bot.action('onboarding_gender_female', async ctx => {
    const chatId = ctx.chat?.id;
    if (!chatId) {
      botLogger.error({}, '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å chatId –∏–∑ callback');
      return;
    }

    const userId = ctx.from?.id || 0;
    botLogger.info({ userId, chatId }, 'üë© –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–ª –∂–µ–Ω—Å–∫–∏–π –ø–æ–ª');

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–æ–ª –≤ –ë–î
    updateUserGender(chatId, 'female');

    // –ü–µ—Ä–µ—Ö–æ–¥–∏–º –∫ –∑–∞–ø—Ä–æ—Å—É —Ü–µ–ª–µ–π
    updateOnboardingState(chatId, 'waiting_request');

    // –û—Ç–≤–µ—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await ctx.answerCbQuery('–û—Ç–ª–∏—á–Ω–æ! üôãüèª‚Äç‚ôÄÔ∏è');

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –æ —Ü–µ–ª—è—Ö —Å –∫–Ω–æ–ø–∫–æ–π "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å"
    await ctx.reply(
      `–ê —Ä–∞—Å—Å–∫–∞–∂–∏ –º–Ω–µ –æ —Å–≤–æ–µ–º –∑–∞–ø—Ä–æ—Å–µ, —á—Ç–æ —Ç–µ–±—è –±–µ—Å–ø–æ–∫–æ–∏—Ç, —á—Ç–æ —Ö–æ—á–µ—à—å —É–ª—É—á—à–∏—Ç—å, –∫ —á–µ–º—É –ø—Ä–∏–π—Ç–∏?\n\n<i>–ú–æ–∂–µ—Ç –ª—É—á—à–µ –ø–æ–Ω–∏–º–∞—Ç—å —Å–µ–±—è, —Å–Ω–∏–∑–∏—Ç—å —Å—Ç—Ä–µ—Å—Å –∏–ª–∏ –ø—Ä–∏–π—Ç–∏ –∫ –±–∞–ª–∞–Ω—Å—É –≤ –∂–∏–∑–Ω–∏</i>`,
      {
        parse_mode: 'HTML',
        ...Markup.inlineKeyboard([
          [Markup.button.callback('–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å', 'onboarding_skip_request')]
        ])
      }
    );

    botLogger.info({ userId, chatId, gender: 'female' }, '‚úÖ –ó–∞–ø—Ä–æ—Å —Ü–µ–ª–µ–π –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω');
  });

  // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–Ω–æ–ø–∫–∏ "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç—å" –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞ —Ü–µ–ª–µ–π
  bot.action('onboarding_skip_request', async ctx => {
    const chatId = ctx.chat?.id;
    if (!chatId) {
      botLogger.error({}, '‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å chatId –∏–∑ callback');
      return;
    }

    const userId = ctx.from?.id || 0;
    botLogger.info({ userId, chatId }, '‚è≠Ô∏è –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ–ø—É—Å—Ç–∏–ª –∑–∞–ø—Ä–æ—Å —Ü–µ–ª–µ–π');

    // –°–æ—Ö—Ä–∞–Ω—è–µ–º null –¥–ª—è user_request
    updateUserRequest(chatId, null);

    // –ó–∞–≤–µ—Ä—à–∞–µ–º –æ–Ω–±–æ—Ä–¥–∏–Ω–≥
    updateOnboardingState(chatId, null);

    // –ü–æ–ª—É—á–∞–µ–º –∏–º—è –∏ –ø–æ–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
    const user = getUserByChatId(chatId);
    const userName = user?.name!;
    const userGender = user?.gender;

    // –û—Ç–≤–µ—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
    await ctx.answerCbQuery('–•–æ—Ä–æ—à–æ!');

    // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∏–Ω–∞–ª—å–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ (—Å —É—á—ë—Ç–æ–º –ø–æ–ª–∞)
    const readyText = userGender === 'male' ? '–≥–æ—Ç–æ–≤' : '–≥–æ—Ç–æ–≤–∞';
    await ctx.reply(
      `–ü—Ä–∏—è—Ç–Ω–æ –ø–æ–∑–Ω–∞–∫–æ–º–∏—Ç—å—Å—è, ${userName}! ü§ó

–¢–µ–ø–µ—Ä—å —Ç—ã ${readyText} –∫ —Ä–∞–±–æ—Ç–µ. –ö–∞–∂–¥—ã–π –≤–µ—á–µ—Ä –≤ 22:00 –±—É–¥—É –æ—Ç–ø—Ä–∞–≤–ª—è—Ç—å —Ç–µ–±–µ –∑–∞–¥–∞–Ω–∏—è –¥–ª—è —Ä–∞–∑–º—ã—à–ª–µ–Ω–∏–π –∏ —Ä–∞–±–æ—Ç—ã –Ω–∞–¥ —Å–æ–±–æ–π.

–ï—Å–ª–∏ —Ö–æ—á–µ—à—å –Ω–∞—á–∞—Ç—å –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å - –ø—Ä–æ—Å—Ç–æ –Ω–∞–ø–∏—à–∏ –º–Ω–µ –æ —Ç–æ–º, —á—Ç–æ —Å–µ–π—á–∞—Å —á—É–≤—Å—Ç–≤—É–µ—à—å –∏–ª–∏ —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Ç–≤–æ–µ–π –∂–∏–∑–Ω–∏. –Ø –±—É–¥—É —Ä–∞–¥ –≤—ã—Å–ª—É—à–∞—Ç—å üíö`
    );

    botLogger.info({ userId, chatId }, '‚úÖ –û–Ω–±–æ—Ä–¥–∏–Ω–≥ –∑–∞–≤–µ—Ä—à–µ–Ω (–∑–∞–ø—Ä–æ—Å –ø—Ä–æ–ø—É—â–µ–Ω)');
  });
}
