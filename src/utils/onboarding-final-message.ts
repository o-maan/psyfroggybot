import { Markup } from 'telegraf';
import { botLogger } from '../logger';

/**
 * Ð“ÐµÐ½ÐµÑ€Ð¸Ñ€ÑƒÐµÑ‚ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ Ð¾Ð½Ð±Ð¾Ñ€Ð´Ð¸Ð½Ð³Ð° Ñ ÑƒÑ‡ÐµÑ‚Ð¾Ð¼ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð´Ð¾ Ð²ÐµÑ‡ÐµÑ€Ð½ÐµÐ¹ Ð»ÑÐ³ÑƒÑ…Ð¸
 * Ð’ÐÐ–ÐÐž: Ð’Ñ€ÐµÐ¼Ñ Ñ€Ð°ÑÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÑ‚ÑÑ Ð¿Ð¾ timezone Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ!
 */
export function generateOnboardingFinalMessage(
  userName: string,
  userTimezone: string,
  userTimezoneOffset: number
): { text: string; buttons?: any } {
  // ÐŸÐ¾Ð»ÑƒÑ‡Ð°ÐµÐ¼ Ñ‚ÐµÐºÑƒÑ‰ÐµÐµ Ð²Ñ€ÐµÐ¼Ñ Ð² timezone Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
  const now = new Date();
  const userLocalTime = new Date(now.getTime() + userTimezoneOffset * 60 * 1000);
  const currentHour = userLocalTime.getHours();

  botLogger.info(
    {
      userName,
      userTimezone,
      userTimezoneOffset,
      userLocalTime: userLocalTime.toISOString(),
      currentHour
    },
    'â° ÐžÐ¿Ñ€ÐµÐ´ÐµÐ»ÐµÐ½Ð¸Ðµ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð´Ð»Ñ Ñ„Ð¸Ð½Ð°Ð»ÑŒÐ½Ð¾Ð³Ð¾ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ Ð¾Ð½Ð±Ð¾Ñ€Ð´Ð¸Ð½Ð³Ð°'
  );

  // Ð‘Ð°Ð·Ð¾Ð²Ð¾Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ðµ
  let message = `Ð’ÑÐµ Ð³Ð¾Ñ‚Ð¾Ð²Ð¾, ÑƒÑ€Ð° ðŸŽ‰
Ð’ÑÑŽ Ð¸Ð½Ñ„Ð¾Ñ€Ð¼Ð°Ñ†Ð¸ÑŽ Ð¾ ÑÐµÐ±Ðµ Ð¼Ð¾Ð¶Ð½Ð¾ Ð¸Ð·Ð¼ÐµÐ½Ð¸Ñ‚ÑŒ Ð¿Ð¾ ÐºÐ¾Ð¼Ð°Ð½Ð´Ðµ /me

Ð Ð°Ð´, Ñ‡Ñ‚Ð¾ Ñ‚Ñ‹ Ð½Ð° ÑÑ‚Ð¾Ð¼ Ð¿ÑƒÑ‚Ð¸ ðŸ‘£ Ð¯ Ð±ÑƒÐ´Ñƒ Ñ€ÑÐ´Ð¾Ð¼! ðŸ¤—

`;

  // ÐŸÑ€Ð¾Ð²ÐµÑ€ÑÐµÐ¼, Ð½Ð¾Ñ‡Ð½Ð¾Ðµ Ð»Ð¸ Ð²Ñ€ÐµÐ¼Ñ (Ð¿Ð¾ÑÐ»Ðµ 20:00 Ð¸Ð»Ð¸ Ð´Ð¾ 9:00)
  if (currentHour >= 20 || currentHour < 9) {
    // ÐÐ¾Ñ‡Ð½Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ - Ð¿Ð¾Ñ€Ð° Ð¾Ñ‚Ð´Ñ‹Ñ…Ð°Ñ‚ÑŒ
    message += `Ð£Ð¶Ðµ Ð¿Ð¾Ð·Ð´Ð½Ð¾, Ð¿Ð¾Ñ€Ð° Ð¾Ñ‚Ð´Ñ‹Ñ…Ð°Ñ‚ÑŒ ðŸŒ™
Ð’ 9:00 Ð¿Ñ€Ð¸Ð´ÐµÑ‚ Ð¿ÐµÑ€Ð²Ð°Ñ ÑƒÑ‚Ñ€ÐµÐ½Ð½ÑÑ Ð»ÑÐ³ÑƒÑ…Ð° â€“ Ñ‚Ñ‹ ÑÐ¼Ð¾Ð¶ÐµÑˆÑŒ Ð¿Ð¸ÑÐ°Ñ‚ÑŒ Ð¼Ð½Ðµ Ð² Ñ‚ÐµÑ‡ÐµÐ½Ð¸Ðµ Ð²ÑÐµÐ³Ð¾ Ð´Ð½Ñ Ð¿Ð¾ Ð¶ÐµÐ»Ð°Ð½Ð¸ÑŽ
ÐžÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð·Ð°Ð´Ð°Ð½Ð¸Ñ Ñ Ð¿Ñ€Ð¸ÑˆÐ»ÑŽ Ð² 20:00, Ð¸Ñ… Ð½Ðµ Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°Ð¹ ðŸ“
Ð”Ð¾ Ð·Ð°Ð²Ñ‚Ñ€Ð° ðŸ¸`;

    return { text: message }; // Ð‘ÐµÐ· ÐºÐ½Ð¾Ð¿Ð¾Ðº
  }

  // Ð”Ð½ÐµÐ²Ð½Ð¾Ðµ Ð²Ñ€ÐµÐ¼Ñ - Ñ€Ð°ÑÑÑ‡Ð¸Ñ‚Ñ‹Ð²Ð°ÐµÐ¼ Ð²Ñ€ÐµÐ¼Ñ Ð´Ð¾ Ð²ÐµÑ‡ÐµÑ€Ð½ÐµÐ¹ Ð»ÑÐ³ÑƒÑ…Ð¸
  // Ð’Ñ€ÐµÐ¼Ñ Ð²ÐµÑ‡ÐµÑ€Ð½ÐµÐ¹ Ð»ÑÐ³ÑƒÑ…Ð¸ - 20:00 Ð¿Ð¾ Ð¼ÐµÑÑ‚Ð½Ð¾Ð¼Ñƒ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»Ñ
  const eveningFrogTime = new Date(userLocalTime);
  eveningFrogTime.setHours(20, 0, 0, 0);

  // Ð Ð°Ð·Ð½Ð¸Ñ†Ð° Ð² Ñ‡Ð°ÑÐ°Ñ… Ð´Ð¾ Ð²ÐµÑ‡ÐµÑ€Ð½ÐµÐ¹ Ð»ÑÐ³ÑƒÑ…Ð¸
  const hoursUntilEvening = (eveningFrogTime.getTime() - userLocalTime.getTime()) / (1000 * 60 * 60);

  botLogger.info(
    {
      eveningFrogTime: eveningFrogTime.toISOString(),
      hoursUntilEvening
    },
    'â° Ð Ð°ÑÑ‡ÐµÑ‚ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð´Ð¾ Ð²ÐµÑ‡ÐµÑ€Ð½ÐµÐ¹ Ð»ÑÐ³ÑƒÑ…Ð¸'
  );

  // Ð”Ð¾Ð±Ð°Ð²Ð»ÑÐµÐ¼ Ñ‚ÐµÐºÑÑ‚ Ð² Ð·Ð°Ð²Ð¸ÑÐ¸Ð¼Ð¾ÑÑ‚Ð¸ Ð¾Ñ‚ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð¸ Ð´Ð¾ Ð²ÐµÑ‡ÐµÑ€Ð½ÐµÐ¹ Ð»ÑÐ³ÑƒÑ…Ð¸
  if (hoursUntilEvening < 1) {
    // ÐœÐµÐ½ÑŒÑˆÐµ Ñ‡Ð°ÑÐ°
    message += `Ð£Ð²Ð¸Ð´Ð¸Ð¼ÑÑ Ð¼ÐµÐ½ÑŒÑˆÐµ Ñ‡ÐµÐ¼ Ñ‡ÐµÑ€ÐµÐ· Ñ‡Ð°Ñ ðŸ˜‰`;
    return { text: message };
  } else if (hoursUntilEvening < 3) {
    // ÐœÐµÐ½ÑŒÑˆÐµ 3 Ñ‡Ð°ÑÐ¾Ð² (Ð½Ð¾ Ð±Ð¾Ð»ÑŒÑˆÐµ 1 Ñ‡Ð°ÑÐ°)
    message += `Ð’ÐµÑ‡ÐµÑ€Ð½ÐµÐµ Ð·Ð°Ð´Ð°Ð½Ð¸Ðµ Ñ Ð¿Ñ€Ð¸ÑˆÐ»ÑŽ Ð² 20:00 â€“ ÑÑ‚Ð¾ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð·Ð°Ð´Ð°Ð½Ð¸Ñ, Ð½Ðµ Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°Ð¹ ðŸ“
Ð•ÑÐ»Ð¸ Ð½Ðµ Ñ‚ÐµÑ€Ð¿Ð¸Ñ‚ÑÑ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ â€“ Ð¼Ð¾Ð¶ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð´Ð½ÐµÐ²Ð½ÑƒÑŽ Ð»ÑÐ³ÑƒÑ…Ñƒ. Ð›ÑƒÑ‡ÑˆÐµ Ð¿Ð¾Ð´Ð¾Ð¶Ð´Ð¸ Ð²ÐµÑ‡ÐµÑ€Ð° ðŸ™ƒ`;

    return {
      text: message,
      buttons: Markup.inlineKeyboard([
        [Markup.button.callback('Ð¥Ð¾Ñ‡Ñƒ ÑÐµÐ¹Ñ‡Ð°Ð°Ð°Ð°Ð°Ñ ðŸ˜', 'onboarding_start_morning')],
        [Markup.button.callback('Ð–Ð´ÐµÐ¼ Ð²ÐµÑ‡ÐµÑ€Ð°', 'onboarding_wait_evening')]
      ])
    };
  } else {
    // Ð‘Ð¾Ð»ÑŒÑˆÐµ 3 Ñ‡Ð°ÑÐ¾Ð²
    message += `Ð’ÐµÑ‡ÐµÑ€Ð½ÐµÐµ Ð·Ð°Ð´Ð°Ð½Ð¸Ðµ Ñ Ð¿Ñ€Ð¸ÑˆÐ»ÑŽ Ð² 20:00 â€“ ÑÑ‚Ð¾ Ð¾ÑÐ½Ð¾Ð²Ð½Ñ‹Ðµ Ð·Ð°Ð´Ð°Ð½Ð¸Ñ, Ð½Ðµ Ð¿Ñ€Ð¾Ð¿ÑƒÑÐºÐ°Ð¹ ðŸ“
Ð•ÑÐ»Ð¸ Ð½Ðµ Ñ‚ÐµÑ€Ð¿Ð¸Ñ‚ÑÑ Ð½Ð°Ñ‡Ð°Ñ‚ÑŒ â€“ Ð¼Ð¾Ð¶ÐµÐ¼ Ð·Ð°Ð¿ÑƒÑÑ‚Ð¸Ñ‚ÑŒ Ð´Ð½ÐµÐ²Ð½ÑƒÑŽ Ð»ÑÐ³ÑƒÑ…Ñƒ`;

    return {
      text: message,
      buttons: Markup.inlineKeyboard([
        [Markup.button.callback('Ð¥Ð¾Ñ‡Ñƒ ÑÐµÐ¹Ñ‡Ð°Ð°Ð°Ð°Ð°Ñ ðŸ˜', 'onboarding_start_morning')],
        [Markup.button.callback('Ð–Ð´ÐµÐ¼ Ð²ÐµÑ‡ÐµÑ€Ð°', 'onboarding_wait_evening')]
      ])
    };
  }
}
