import { generateMessage } from '../llm';
import { botLogger } from '../logger';
import { db } from '../db';

interface DayRatingSupportWords {
  rating1: string; // üò≠
  rating2: string; // üò©
  rating3: string; // ü´§
  rating4: string; // üòä
  rating5: string; // ü§©
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –ø–æ–º–µ—Ç–æ–∫
function cleanSupportText(text: string): string {
  let cleaned = text.trim();
  // –£–¥–∞–ª—è–µ–º —Ç–µ–≥–∏ think –µ—Å–ª–∏ –µ—Å—Ç—å
  const lastThinkClose = cleaned.lastIndexOf('</think>');
  if (lastThinkClose !== -1 && cleaned.trim().startsWith('<think>')) {
    cleaned = cleaned.substring(lastThinkClose + 8).trim();
  }
  // –£–¥–∞–ª—è–µ–º –ª—é–±—ã–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –ø–æ–º–µ—Ç–∫–∏ –≤ —Å–∫–æ–±–∫–∞—Ö
  cleaned = cleaned.replace(/\s*\([^)]*—Å–∏–º–≤–æ–ª[^)]*\)/gi, '');
  cleaned = cleaned.replace(/\s*\(\d+[^)]*\)/g, '');
  cleaned = cleaned.replace(/\s*\([^)]*\)/g, '');
  // –£–¥–∞–ª—è–µ–º –∫–∞–≤—ã—á–∫–∏ –≤ –Ω–∞—á–∞–ª–µ –∏ –∫–æ–Ω—Ü–µ
  cleaned = cleaned.replace(/^["']|["']$/g, '').trim();
  return cleaned;
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª–æ–≤ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –¥–ª—è –≤—Å–µ—Ö –æ—Ü–µ–Ω–æ–∫
export async function generateDayRatingSupportWords(): Promise<DayRatingSupportWords> {
  const supportWords: DayRatingSupportWords = getDefaultSupportWords();

  // –ü—Ä–æ–º–ø—Ç—ã –¥–ª—è –∫–∞–∂–¥–æ–π –æ—Ü–µ–Ω–∫–∏
  const prompts = {
    rating1: `–ß–µ–ª–æ–≤–µ–∫ –æ—Ü–µ–Ω–∏–ª —Å–≤–æ–π –¥–µ–Ω—å –∫–∞–∫ —É–∂–∞—Å–Ω—ã–π (üò≠). –ù–∞–ø–∏—à–∏ 1-2 —Ç–µ–ø–ª—ã—Ö —Ñ—Ä–∞–∑—ã (–¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤ –≤–º–µ—Å—Ç–µ) —Å —ç–º–æ–¥–∑–∏. –ü–æ–¥–≤–µ–¥–∏ –∏—Ç–æ–≥ –¥–Ω—è –∏ –ø–æ–¥–¥–µ—Ä–∂–∏. –ë—É–¥—å —á–µ–ª–æ–≤–µ—á–Ω—ã–º –∏ –∏—Å–∫—Ä–µ–Ω–Ω–∏–º.

–ü—Ä–∏–º–µ—Ä—ã:
- –°–ª–æ–∂–Ω—ã–π –¥–µ–Ω—å –ø–æ–∑–∞–¥–∏. –û–±–Ω–∏–º–∞—é –∫—Ä–µ–ø–∫–æ ü´Ç
- –°–µ–≥–æ–¥–Ω—è –±—ã–ª–æ —Ç—è–∂–µ–ª–æ. –Ø —Å —Ç–æ–±–æ–π üíö
- –ù–µ–ø—Ä–æ—Å—Ç–æ–π –¥–µ–Ω—å. –ó–∞–≤—Ç—Ä–∞ –±—É–¥–µ—Ç –ª—É—á—à–µ üå±
- –¢—Ä—É–¥–Ω—ã–π –¥–µ–Ω—å. –î–µ—Ä–∂–∏—Å—å, —Ç—ã —Å–ø—Ä–∞–≤–∏—à—å—Å—è ü§ó

–ù–∞–ø–∏—à–∏ 1-2 —Ñ—Ä–∞–∑—ã, –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—è –ø—Ä–∏–º–µ—Ä—ã. –ë–µ–∑ –∫–∞–≤—ã—á–µ–∫, —Å–∫–æ–±–æ–∫, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –¢—ã - –ª—è–≥—É—à–∫–∞ –º—É–∂—Å–∫–æ–≥–æ —Ä–æ–¥–∞, –∏—Å–ø–æ–ª—å–∑—É–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≥–ª–∞–≥–æ–ª–æ–≤.`,
    
    rating2: `–ß–µ–ª–æ–≤–µ–∫ –æ—Ü–µ–Ω–∏–ª —Å–≤–æ–π –¥–µ–Ω—å –∫–∞–∫ –ø–ª–æ—Ö–æ–π (üò©). –ù–∞–ø–∏—à–∏ 1-2 —Ç–µ–ø–ª—ã—Ö —Ñ—Ä–∞–∑—ã (–¥–æ 100 —Å–∏–º–≤–æ–ª–æ–≤ –≤–º–µ—Å—Ç–µ) —Å —ç–º–æ–¥–∑–∏. –ü–æ–¥–≤–µ–¥–∏ –∏—Ç–æ–≥ –¥–Ω—è –∏ –ø–æ–¥–±–æ–¥—Ä–∏.

–ü—Ä–∏–º–µ—Ä—ã:
- –°–µ–≥–æ–¥–Ω—è –±—ã–ª–æ —Ç—è–∂–µ–ª–æ. –ó–∞–≤—Ç—Ä–∞ –±—É–¥–µ—Ç –ª—É—á—à–µ üíö
- –ù–µ–ø—Ä–æ—Å—Ç–æ–π –¥–µ–Ω—å –ø–æ–∑–∞–¥–∏. –¢—ã —Å–ø—Ä–∞–≤–∏–ª—Å—è üåø
- –î–µ–Ω—å –Ω–µ –∑–∞–¥–∞–ª—Å—è. –í—Å–µ –Ω–∞–ª–∞–¥–∏—Ç—Å—è üå∏
- –¢—Ä—É–¥–Ω—ã–π –¥–µ–Ω—å. –í–µ—Ä—é –≤ —Ç–µ–±—è üí™

–ù–∞–ø–∏—à–∏ 1-2 —Ñ—Ä–∞–∑—ã, –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—è –ø—Ä–∏–º–µ—Ä—ã. –ë–µ–∑ –∫–∞–≤—ã—á–µ–∫, —Å–∫–æ–±–æ–∫, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏. –¢—ã - –ª—è–≥—É—à–∫–∞ –º—É–∂—Å–∫–æ–≥–æ —Ä–æ–¥–∞, –∏—Å–ø–æ–ª—å–∑—É–π —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –æ–∫–æ–Ω—á–∞–Ω–∏—è –≥–ª–∞–≥–æ–ª–æ–≤.`,
    
    rating3: `–ß–µ–ª–æ–≤–µ–∫ –æ—Ü–µ–Ω–∏–ª —Å–≤–æ–π –¥–µ–Ω—å –∫–∞–∫ –Ω–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π (ü´§). –ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫—É—é —Ç–µ–ø–ª—É—é —Ñ—Ä–∞–∑—É (–¥–æ 50 —Å–∏–º–≤–æ–ª–æ–≤) —Å —ç–º–æ–¥–∑–∏.

–ü—Ä–∏–º–µ—Ä—ã:
- –ò —Ç–∞–∫–∏–µ –¥–Ω–∏ –Ω—É–∂–Ω—ã üåø
- –í—Å–µ –≤ –ø–æ—Ä—è–¥–∫–µ ü§ç
- –û—Ç–¥–æ—Ö–Ω–∏ —Å–µ–≥–æ–¥–Ω—è üåô
- –¢—ã –º–æ–ª–æ–¥–µ—Ü üíõ

–ù–∞–ø–∏—à–∏ –û–î–ù–£ —Ñ—Ä–∞–∑—É, –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—è –ø—Ä–∏–º–µ—Ä—ã. –ë–µ–∑ –∫–∞–≤—ã—á–µ–∫, —Å–∫–æ–±–æ–∫, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.`,
    
    rating4: `–ß–µ–ª–æ–≤–µ–∫ –æ—Ü–µ–Ω–∏–ª —Å–≤–æ–π –¥–µ–Ω—å –∫–∞–∫ —Ö–æ—Ä–æ—à–∏–π (üòä). –ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫—É—é —Ç–µ–ø–ª—É—é —Ñ—Ä–∞–∑—É —Ä–∞–¥–æ—Å—Ç–∏ (–¥–æ 50 —Å–∏–º–≤–æ–ª–æ–≤) —Å —ç–º–æ–¥–∑–∏.

–ü—Ä–∏–º–µ—Ä—ã:
- –†–∞–¥ –∑–∞ —Ç–µ–±—è üå∏
- –¢–∞–∫ –¥–µ—Ä–∂–∞—Ç—å! üåü
- –¢—ã –º–æ–ª–æ–¥–µ—Ü üíö
- –°—É–ø–µ—Ä –¥–µ–Ω—å! üéâ

–ù–∞–ø–∏—à–∏ –û–î–ù–£ —Ñ—Ä–∞–∑—É, –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—è –ø—Ä–∏–º–µ—Ä—ã. –ë–µ–∑ –∫–∞–≤—ã—á–µ–∫, —Å–∫–æ–±–æ–∫, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.`,
    
    rating5: `–ß–µ–ª–æ–≤–µ–∫ –æ—Ü–µ–Ω–∏–ª —Å–≤–æ–π –¥–µ–Ω—å –∫–∞–∫ –æ—Ç–ª–∏—á–Ω—ã–π (ü§©). –ù–∞–ø–∏—à–∏ –∫–æ—Ä–æ—Ç–∫—É—é –≤–æ—Å—Ç–æ—Ä–∂–µ–Ω–Ω—É—é —Ñ—Ä–∞–∑—É (–¥–æ 50 —Å–∏–º–≤–æ–ª–æ–≤) —Å —ç–º–æ–¥–∑–∏.

–ü—Ä–∏–º–µ—Ä—ã:
- –¢—ã —Å–∏—è–µ—à—å! ‚ú®
- –í–∞—É, —Å—É–ø–µ—Ä! üéâ
- –ö–æ—Å–º–æ—Å! üöÄ
- –í–æ—Å—Ö–∏—Ç–∏—Ç–µ–ª—å–Ω–æ! üí´

–ù–∞–ø–∏—à–∏ –û–î–ù–£ —Ñ—Ä–∞–∑—É, –Ω–µ –ø–æ–≤—Ç–æ—Ä—è—è –ø—Ä–∏–º–µ—Ä—ã. –ë–µ–∑ –∫–∞–≤—ã—á–µ–∫, —Å–∫–æ–±–æ–∫, —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–π –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏.`
  };

  // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º –¥–ª—è –∫–∞–∂–¥–æ–π –æ—Ü–µ–Ω–∫–∏
  const defaults = getDefaultSupportWords();
  for (const [key, prompt] of Object.entries(prompts)) {
    try {
      const generated = await generateMessage(prompt);
      if (generated !== 'HF_JSON_ERROR') {
        const cleaned = cleanSupportText(generated);
        if (cleaned.length > 0 && cleaned.length <= 100) { // –ª–∏–º–∏—Ç 100 —Å–∏–º–≤–æ–ª–æ–≤ –∫–∞–∫ –ø—Ä–æ—Å–∏–ª–∏
          supportWords[key as keyof DayRatingSupportWords] = cleaned;
        } else {
          // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç –ø—É—Å—Ç–æ–π –∏–ª–∏ —Å–ª–∏—à–∫–æ–º –¥–ª–∏–Ω–Ω—ã–π, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç
          botLogger.warn({ key, cleanedLength: cleaned.length }, '–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –Ω–µ –ø–æ–¥—Ö–æ–¥–∏—Ç, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç');
          supportWords[key as keyof DayRatingSupportWords] = defaults[key as keyof DayRatingSupportWords];
        }
      } else {
        // –ï—Å–ª–∏ LLM –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç
        botLogger.warn({ key }, 'LLM –≤–µ—Ä–Ω—É–ª –æ—à–∏–±–∫—É, –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç');
        supportWords[key as keyof DayRatingSupportWords] = defaults[key as keyof DayRatingSupportWords];
      }
    } catch (error) {
      botLogger.error({ error, rating: key }, '–û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Å–ª–æ–≤ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –¥–ª—è –æ—Ü–µ–Ω–∫–∏ –¥–Ω—è');
      // –í —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –¥–µ—Ñ–æ–ª—Ç
      supportWords[key as keyof DayRatingSupportWords] = defaults[key as keyof DayRatingSupportWords];
    }
  }

  return supportWords;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –¥–µ—Ñ–æ–ª—Ç—ã –¥–ª—è 1-2 —Ñ—Ä–∞–∑
export function getDefaultSupportWords(): DayRatingSupportWords {
  return {
    rating1: '–°–ª–æ–∂–Ω—ã–π –¥–µ–Ω—å –ø–æ–∑–∞–¥–∏. –û–±–Ω–∏–º–∞—é –∫—Ä–µ–ø–∫–æ ü§ó',
    rating2: '–°–µ–≥–æ–¥–Ω—è –±—ã–ª–æ —Ç—è–∂–µ–ª–æ. –ó–∞–≤—Ç—Ä–∞ –±—É–¥–µ—Ç –ª—É—á—à–µ üíö', 
    rating3: '–û–±—ã—á–Ω—ã–π –¥–µ–Ω—å. –ò —Ç–∞–∫–∏–µ –¥–Ω–∏ –Ω—É–∂–Ω—ã üåø',
    rating4: '–•–æ—Ä–æ—à–∏–π –¥–µ–Ω—å! –†–∞–¥ –∑–∞ —Ç–µ–±—è üå∏',
    rating5: '–°—É–ø–µ—Ä –¥–µ–Ω—å! –¢—ã —Å–∏—è–µ—à—å ‚ú®'
  };
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ª–æ–≤ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –æ—Ü–µ–Ω–∫–∏
export async function getDayRatingSupportWord(channelMessageId: number, rating: number): Promise<string> {
  try {
    const query = db.query(`
      SELECT message_data FROM interactive_posts WHERE channel_message_id = ?
    `);
    const post = query.get(channelMessageId) as any;
    
    if (post?.message_data) {
      const messageData = JSON.parse(post.message_data);
      const supportWords = messageData.day_rating_support;
      
      if (supportWords) {
        const key = `rating${rating}` as keyof DayRatingSupportWords;
        return supportWords[key] || getDefaultSupportWord(rating);
      }
    }
  } catch (error) {
    botLogger.error({ error, channelMessageId, rating }, '–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª–æ–≤ –ø–æ–¥–¥–µ—Ä–∂–∫–∏');
  }
  
  return getDefaultSupportWord(rating);
}

// –ü–æ–ª—É—á–µ–Ω–∏–µ —Å–ª–æ–≤ –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–π –æ—Ü–µ–Ω–∫–∏
function getDefaultSupportWord(rating: number): string {
  const defaults = getDefaultSupportWords();
  const key = `rating${rating}` as keyof DayRatingSupportWords;
  return defaults[key] || '–°–ø–∞—Å–∏–±–æ –∑–∞ –æ—Ü–µ–Ω–∫—É üíö';
}