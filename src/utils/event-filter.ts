/**
 * –£—Ç–∏–ª–∏—Ç—ã –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã—Ö —Å–æ–±—ã—Ç–∏–π
 *
 * –¶–µ–ª—å: –£–±—Ä–∞—Ç—å "–º—É—Å–æ—Ä" –∏–∑ —Å–ø–∏—Å–∫–∞ —Å–æ–±—ã—Ç–∏–π:
 * - –û–¥–∏–Ω–æ—á–Ω—ã–µ –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã–µ —ç–º–æ—Ü–∏–∏ ("—Ä–∞–¥–æ—Å—Ç—å", "–ª—é–±–æ–≤—å –∫ —Å–µ–±–µ")
 * - –°–ª—É–∂–µ–±–Ω—ã–µ —Å–∏–º–≤–æ–ª—ã –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫ (-, ‚Äî, ‚Äì)
 */

import { schedulerLogger } from '../logger';

/**
 * –°–ª–æ–≤–∞—Ä—å –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω—ã—Ö —ç–º–æ—Ü–∏–π –∫–æ—Ç–æ—Ä—ã–µ –ù–ï —è–≤–ª—è—é—Ç—Å—è —Å–æ–±—ã—Ç–∏—è–º–∏
 */
const EMOTION_KEYWORDS = [
  '—Ä–∞–¥–æ—Å—Ç—å',
  '–≥—Ä—É—Å—Ç—å',
  '—Å—Ç—Ä–∞—Ö',
  '–≥–Ω–µ–≤',
  '—É–¥–æ–≤–æ–ª—å—Å—Ç–≤–∏–µ',
  '—Å–ø–æ–∫–æ–π—Å—Ç–≤–∏–µ',
  '–≤–æ–≤–ª–µ—á–µ–Ω–Ω–æ—Å—Ç—å',
  '–∏–Ω—Ç–µ—Ä–µ—Å',
  '–Ω–µ—Ç–µ—Ä–ø–µ–Ω–∏–µ',
  '–≤–æ–ª–Ω–µ–Ω–∏–µ',
  '—Ç—Ä–µ–≤–æ–≥–∞',
  '–≤–æ—Å—Ç–æ—Ä–≥',
  '—Å—á–∞—Å—Ç—å–µ',
  '–ø–µ—á–∞–ª—å',
  '—Ä–∞–∑–¥—Ä–∞–∂–µ–Ω–∏–µ',
  '—É–¥–∏–≤–ª–µ–Ω–∏–µ',
  '–≥–æ—Ä–¥–æ—Å—Ç—å',
  '—Å—Ç—ã–¥',
  '–≤–∏–Ω–∞',
  '–∑–∞–≤–∏—Å—Ç—å',
  '–±–ª–∞–≥–æ–¥–∞—Ä–Ω–æ—Å—Ç—å',
  '–ª—é–±–æ–≤—å',
  '–Ω–µ–Ω–∞–≤–∏—Å—Ç—å',
  '–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ',
  '–ø—Ä–µ–∑—Ä–µ–Ω–∏–µ',
  '–∂–∞–ª–æ—Å—Ç—å',
  '—É–º–∏—Ä–æ—Ç–≤–æ—Ä–µ–Ω–∏–µ',
  '—è—Å–Ω–æ—Å—Ç—å',
  '–ª–µ–≥–∫–æ—Å—Ç—å',
  '—Ç—Ä–µ–ø–µ—Ç',
  '–≤–¥–æ—Ö–Ω–æ–≤–µ–Ω–∏–µ',
  '–∞–∑–∞—Ä—Ç',
  '—Ä–∞—Å—Å–ª–∞–±–ª–µ–Ω–∏–µ',
  '–Ω–∞–ø—Ä—è–∂–µ–Ω–∏–µ',
  '—É—Å—Ç–∞–ª–æ—Å—Ç—å',
  '—ç–Ω–µ—Ä–≥–∏—è',
];

export interface FilterResult {
  text: string;
  filtered: boolean;
  reason?: string;
}

/**
 * –£–¥–∞–ª–∏—Ç—å —Å–∏–º–≤–æ–ª—ã —Å–ø–∏—Å–∫–∞ –≤ –Ω–∞—á–∞–ª–µ —Å—Ç—Ä–æ–∫–∏ (-, ‚Äî, ‚Äì, ‚Ä¢, *, –∏ —Ç.–¥.)
 */
export function removeLeadingSymbols(text: string): string {
  // –£–±–∏—Ä–∞–µ–º —Å–∏–º–≤–æ–ª—ã –º–∞—Ä–∫–µ—Ä–æ–≤ —Å–ø–∏—Å–∫–∞ –∏ –ø—Ä–æ–±–µ–ª—ã –≤ –Ω–∞—á–∞–ª–µ
  return text.replace(/^[\s\-‚Äî‚Äì‚Ä¢*]+/, '').trim();
}

/**
 * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Å–ª–æ–≤–æ –≥–ª–∞–≥–æ–ª–æ–º –∏–ª–∏ –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã–º
 * (–ø—Ä–æ—Å—Ç–∞—è —ç–≤—Ä–∏—Å—Ç–∏–∫–∞ –ø–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è–º)
 */
function isVerbOrAdjective(word: string): boolean {
  const lower = word.toLowerCase();

  // –û–∫–æ–Ω—á–∞–Ω–∏—è –≥–ª–∞–≥–æ–ª–æ–≤
  const verbEndings = [
    '–∞—Ç—å', '—è—Ç—å', '–µ—Ç—å', '–∏—Ç—å', '–æ—Ç—å', '—É—Ç—å', // –∏–Ω—Ñ–∏–Ω–∏—Ç–∏–≤
    '–∞–ª', '–∞–ª–∞', '–∞–ª–∏', '–∞–ª–æ', // –ø—Ä–æ—à–µ–¥—à–µ–µ –≤—Ä–µ–º—è
    '–∏–ª', '–∏–ª–∞', '–∏–ª–∏', '–∏–ª–æ',
    '–µ–ª', '–µ–ª–∞', '–µ–ª–∏', '–µ–ª–æ',
    '—é', '–µ—à—å', '–µ—Ç', '–µ–º', '–µ—Ç–µ', '—é—Ç', '—É—Ç', // –Ω–∞—Å—Ç–æ—è—â–µ–µ –≤—Ä–µ–º—è
    '—Ç—å', // –∏–Ω—Ñ–∏–Ω–∏—Ç–∏–≤
  ];

  // –û–∫–æ–Ω—á–∞–Ω–∏—è –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã—Ö
  const adjectiveEndings = [
    '—ã–π', '–∏–π', '–æ–π', '–∞—è', '—è—è', '–æ–µ', '–µ–µ', '—ã–µ', '–∏–µ',
    '–æ–≥–æ', '–µ–≥–æ', '–æ–º—É', '–µ–º—É',
  ];

  const allEndings = [...verbEndings, ...adjectiveEndings];

  return allEndings.some(ending => lower.endsWith(ending) && lower.length > ending.length + 1);
}

/**
 * –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —è–≤–ª—è–µ—Ç—Å—è –ª–∏ —Ç–µ–∫—Å—Ç –¢–û–õ–¨–ö–û –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–æ–π —ç–º–æ—Ü–∏–µ–π –∏–ª–∏ –º—É—Å–æ—Ä–æ–º
 *
 * –ü—Ä–∏–º–µ—Ä—ã:
 * - "—Ä–∞–¥–æ—Å—Ç—å" ‚Üí true (–æ–¥–∏–Ω–æ—á–Ω–∞—è —ç–º–æ—Ü–∏—è)
 * - "–ª—é–±–æ–≤—å –∫ —Å–µ–±–µ" ‚Üí true (—ç–º–æ—Ü–∏—è —Å —É—Ç–æ—á–Ω–µ–Ω–∏–µ–º)
 * - "–ø–æ—Ä–∞–¥–æ–≤–∞–ª–∏" ‚Üí true (–æ–¥–∏–Ω–æ—á–Ω—ã–π –≥–ª–∞–≥–æ–ª - –º—É—Å–æ—Ä)
 * - "–∫—Ä–∞—Å–∏–≤—ã–π" ‚Üí true (–æ–¥–∏–Ω–æ—á–Ω–æ–µ –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–µ - –º—É—Å–æ—Ä)
 * - "—Ç–∞–Ω—Ü—ã" ‚Üí false (—Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–µ - —Å–æ–±—ã—Ç–∏–µ)
 * - "–∑–∞–∫–∞—Ç" ‚Üí false (—Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–µ - —Å–æ–±—ã—Ç–∏–µ)
 * - "–∫—Ä–∞—Å–∏–≤—ã–π –∑–∞–∫–∞—Ç" ‚Üí false (–∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–µ —Å–æ–±—ã—Ç–∏–µ)
 * - "–∏–≥—Ä–∞–ª–∏ —Å —Å–æ–±–∞–∫–æ–π" ‚Üí false (—Å–æ–±—ã—Ç–∏–µ —Å –¥–µ–π—Å—Ç–≤–∏–µ–º)
 */
export function isOnlyEmotion(text: string): boolean {
  const trimmed = text.toLowerCase().trim();

  // –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞
  if (!trimmed) return true;

  const words = trimmed.split(/\s+/);

  // –û–î–ù–û —Å–ª–æ–≤–æ - —Ñ–∏–ª—å—Ç—Ä—É–µ–º:
  // 1. –≠–º–æ—Ü–∏–∏ –∏–∑ —Å–ª–æ–≤–∞—Ä—è
  // 2. –ì–ª–∞–≥–æ–ª—ã
  // 3. –ü—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã–µ
  // –û—Å—Ç–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ
  if (words.length === 1) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —ç–º–æ—Ü–∏—é
    if (EMOTION_KEYWORDS.includes(trimmed)) {
      return true;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –≥–ª–∞–≥–æ–ª/–ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω–æ–µ
    if (isVerbOrAdjective(trimmed)) {
      return true;
    }

    // –û—Å—Ç–∞–ª—å–Ω–æ–µ (—Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ–µ) - –æ—Å—Ç–∞–≤–ª—è–µ–º
    return false;
  }

  // 2-3 —Å–ª–æ–≤–∞ - –ø—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ —ç–º–æ—Ü–∏—è —Å —É—Ç–æ—á–Ω–µ–Ω–∏–µ–º (–Ω–∞–ø—Ä–∏–º–µ—Ä "–ª—é–±–æ–≤—å –∫ —Å–µ–±–µ")
  if (words.length <= 3) {
    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —Ö–æ—Ç—è –±—ã –û–î–ù–û —Å–ª–æ–≤–æ - —ç—Ç–æ —ç–º–æ—Ü–∏—è
    const hasEmotion = words.some(word => EMOTION_KEYWORDS.includes(word));

    if (!hasEmotion) {
      // –ù–µ—Ç —ç–º–æ—Ü–∏–π –≤ —Å–ª–æ–≤–∞—Ö - —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ
      return false;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –ù–ï–¢ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π/–ø—Ä–µ–¥–º–µ—Ç–æ–≤
    // –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–µ–¥–ª–æ–≥–∏ (–∫, –¥–ª—è, –æ, –ø—Ä–æ, —Å) - —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —ç—Ç–æ —É—Ç–æ—á–Ω–µ–Ω–∏–µ —ç–º–æ—Ü–∏–∏
    const prepositions = ['–∫', '–¥–ª—è', '–æ', '–ø—Ä–æ', '—Å', '–ø–æ', '–æ—Ç', '–¥–æ'];
    const hasPreposition = words.some(word => prepositions.includes(word));

    if (hasPreposition) {
      // "–ª—é–±–æ–≤—å –∫ —Å–µ–±–µ" - —ç–º–æ—Ü–∏—è —Å –ø—Ä–µ–¥–ª–æ–≥–æ–º
      return true;
    }

    // –ï—Å–ª–∏ –≤—Å–µ —Å–ª–æ–≤–∞ - —ç—Ç–æ —ç–º–æ—Ü–∏–∏ –∏–ª–∏ –ø—Ä–µ–¥–ª–æ–≥–∏, —Ç–æ —ç—Ç–æ –æ–¥–∏–Ω–æ—á–Ω–∞—è —ç–º–æ—Ü–∏—è
    const allWordsAreEmotionsOrPrepositions = words.every(
      word => EMOTION_KEYWORDS.includes(word) || prepositions.includes(word)
    );

    return allWordsAreEmotionsOrPrepositions;
  }

  // –ë–æ–ª—å—à–µ 3 —Å–ª–æ–≤ - —Å–∫–æ—Ä–µ–µ –≤—Å–µ–≥–æ —ç—Ç–æ —Å–æ–±—ã—Ç–∏–µ
  return false;
}

/**
 * –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å –º–∞—Å—Å–∏–≤ —Å–æ–±—ã—Ç–∏–π
 *
 * @param events - –º–∞—Å—Å–∏–≤ —Ç–µ–∫—Å—Ç–æ–≤ —Å–æ–±—ã—Ç–∏–π
 * @returns –æ–±—ä–µ–∫—Ç —Å –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã–º–∏ –∏ —É–¥–∞–ª—ë–Ω–Ω—ã–º–∏ —Å–æ–±—ã—Ç–∏—è–º–∏
 */
export function filterEvents(events: string[]): {
  kept: string[];
  filtered: Array<{ text: string; reason: string }>;
} {
  const kept: string[] = [];
  const filtered: Array<{ text: string; reason: string }> = [];

  for (const rawEvent of events) {
    // –£–±–∏—Ä–∞–µ–º —Å–∏–º–≤–æ–ª—ã –≤ –Ω–∞—á–∞–ª–µ
    const cleanedEvent = removeLeadingSymbols(rawEvent);

    // –ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –ø–æ—Å–ª–µ –æ—á–∏—Å—Ç–∫–∏
    if (!cleanedEvent) {
      filtered.push({ text: rawEvent, reason: '–ü—É—Å—Ç–∞—è —Å—Ç—Ä–æ–∫–∞ –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è —Å–∏–º–≤–æ–ª–æ–≤' });
      continue;
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ —ç—Ç–æ –Ω–µ –æ–¥–∏–Ω–æ—á–Ω–∞—è —ç–º–æ—Ü–∏—è
    if (isOnlyEmotion(cleanedEvent)) {
      filtered.push({ text: rawEvent, reason: '–û–¥–∏–Ω–æ—á–Ω–∞—è –∞–±—Å—Ç—Ä–∞–∫—Ç–Ω–∞—è —ç–º–æ—Ü–∏—è' });
      continue;
    }

    // –°–æ–±—ã—Ç–∏–µ –ø—Ä–æ—à–ª–æ —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
    kept.push(cleanedEvent);
  }

  return { kept, filtered };
}

/**
 * –§–∏–ª—å—Ç—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç —Å–æ –º–Ω–æ–∂–µ—Å—Ç–≤–æ–º —Å–æ–±—ã—Ç–∏–π (—Ä–∞–∑–¥–µ–ª—ë–Ω–Ω—ã—Ö \n)
 *
 * @param text - —Ç–µ–∫—Å—Ç —Å —Å–æ–±—ã—Ç–∏—è–º–∏ —á–µ—Ä–µ–∑ \n
 * @returns –æ–±—ä–µ–∫—Ç —Å –æ—á–∏—â–µ–Ω–Ω—ã–º —Ç–µ–∫—Å—Ç–æ–º –∏ –ª–æ–≥–æ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏
 */
export function filterEventsText(text: string): {
  cleanedText: string;
  filtered: Array<{ text: string; reason: string }>;
} {
  const lines = text.split('\n').filter(Boolean);
  const result = filterEvents(lines);

  // –õ–æ–≥–∏—Ä—É–µ–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏—é
  if (result.filtered.length > 0) {
    schedulerLogger.info(
      {
        filtered: result.filtered,
        keptCount: result.kept.length,
      },
      'üóëÔ∏è –°–æ–±—ã—Ç–∏—è –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω—ã'
    );
  }

  return {
    cleanedText: result.kept.join('\n'),
    filtered: result.filtered,
  };
}
