/**
 * –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
 *
 * –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –≤–º–µ—Å—Ç–æ bot.telegram.sendMessage()
 * –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ–±—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –ø–æ–¥ –ø–æ–ª
 *
 * –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ê–î–ê–ü–¢–ê–¶–ò–ò:
 * 1. –®–ê–ë–õ–û–ù–´: –ì–æ—Ç–æ–≤—ã–µ —Ç–µ–∫—Å—Ç—ã —Å ${:–∞} ‚Üí –ø–∞—Ä—Å–∏–Ω–≥ ‚Üí –°–¢–û–ü (–ù–ï –ø—Ä–∏–º–µ–Ω—è—Ç—å regex!)
 * 2. –ú–ê–†–ö–ï–† gender:both: –¢–µ–∫—Å—Ç—ã –ø–æ–¥—Ö–æ–¥—è—â–∏–µ –æ–±–æ–∏–º —Ä–æ–¥–∞–º ‚Üí –°–¢–û–ü (–ù–ï –ø—Ä–∏–º–µ–Ω—è—Ç—å regex!)
 * 3. REGEX FALLBACK: –¢–æ–ª—å–∫–æ –µ—Å–ª–∏ –ù–ï–¢ —à–∞–±–ª–æ–Ω–∞ –ò –º–∞—Ä–∫–µ—Ä–∞ ‚Üí regex + WARNING –≤ –ª–æ–≥–∏
 *
 * –í–ê–ñ–ù–û:
 * - LLM-–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã —É–∂–µ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω—ã —Å–∞–º–∏–º LLM –≤ –ø—Ä–æ–º–ø—Ç–µ
 * - –¢–µ–∫—Å—Ç—ã –≤ –∫–æ–¥–µ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω—ã —á–µ—Ä–µ–∑ ending() –¥–æ –≤—ã–∑–æ–≤–∞ sendToUser
 * - Regex –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –¢–û–õ–¨–ö–û –∫–∞–∫ fallback –¥–ª—è –ø—Ä–æ–ø—É—â–µ–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤
 */

import type { Telegraf } from 'telegraf';
import { getUserByChatId } from '../db';
import { adaptTextForGender } from './gender-adapter';
import { parseGenderTemplate } from './gender-template-parser';
import { botLogger } from '../logger';

/**
 * –°–ª–æ–≤–∞—Ä—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ —Å –≥–æ—Ç–æ–≤—ã–º–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –¥–ª—è –∂–µ–Ω—Å–∫–æ–≥–æ —Ä–æ–¥–∞
 *
 * –°—Ç—Ä—É–∫—Ç—É—Ä–∞:
 * - male: —Ç–µ–∫—Å—Ç –≤ –º—É–∂—Å–∫–æ–º —Ä–æ–¥–µ (–±–∞–∑–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)
 * - female: —Ç–µ–∫—Å—Ç –≤ –∂–µ–Ω—Å–∫–æ–º —Ä–æ–¥–µ (–≥–æ—Ç–æ–≤—ã–π –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
 * - string: –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –¥–ª—è –æ–±–æ–∏—Ö —Ä–æ–¥–æ–≤
 */
type FixedText =
  | { male: string; female: string }
  | string;

const FIXED_TEXTS: Record<string, FixedText> = {
  // ===== –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø =====

  'reminder_evening_task': {
    male: '! –ù–µ –∑–∞–±—É–¥—å –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ, –µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å–ø–µ–ª',
    female: '! –ù–µ –∑–∞–±—É–¥—å –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ, –µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å–ø–µ–ª–∞',
  },

  'reminder_unfinished': 'üê∏ –í–∏–∂—É, —á—Ç–æ –ª—è–≥—É—Ö–∞ –Ω–µ –ø–æ–ª—É—á–∏–ª–∞ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è. –î–∞–≤–∞–π –¥–æ–¥–µ–ª–∞–µ–º - –≤–æ–∑–≤—Ä–∞—â–∞–π—Å—è ü§ó',

  'reminder_breathing': {
    male: '–í—ã–ø–æ–ª–Ω–∏ –ø—Ä–∞–∫—Ç–∏–∫—É –∏ –Ω–∞–∂–º–∏ "–°–¥–µ–ª–∞–ª" –ø–æ—Å–ª–µ –µ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è',
    female: '–í—ã–ø–æ–ª–Ω–∏ –ø—Ä–∞–∫—Ç–∏–∫—É –∏ –Ω–∞–∂–º–∏ "–°–¥–µ–ª–∞–ª–∞" –ø–æ—Å–ª–µ –µ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è',
  },

  // ===== –ö–ù–û–ü–ö–ò –ò –ö–û–†–û–¢–ö–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø =====

  'button_finished_writing': {
    male: '–î–æ–ø–∏—Å–∞–ª? –ú–æ–∂–µ—à—å –¥–æ–ø–æ–ª–Ω–∏—Ç—å –∏ —Ç—ã–∫–∞–π –Ω–∞ –∫–Ω–æ–ø–∫—É üê∏',
    female: '–î–æ–ø–∏—Å–∞–ª–∞? –ú–æ–∂–µ—à—å –¥–æ–ø–æ–ª–Ω–∏—Ç—å –∏ —Ç—ã–∫–∞–π –Ω–∞ –∫–Ω–æ–ø–∫—É üê∏',
  },

  'before_breathing_practice': {
    male: '–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! üåü –¢–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω–∏ –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É –∏ –Ω–∞–∂–º–∏ "–°–¥–µ–ª–∞–ª" –ø–æ—Å–ª–µ –µ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è',
    female: '–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! üåü –¢–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω–∏ –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É –∏ –Ω–∞–∂–º–∏ "–°–¥–µ–ª–∞–ª–∞" –ø–æ—Å–ª–µ –µ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è',
  },

  'joy_empty_list': {
    male: '–¢—ã –µ—â–µ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–ø–∏—Å–∞–ª ü§î\n–ù–∞–ø–∏—à–∏, —á—Ç–æ —Ç–µ–±—è —Ä–∞–¥—É–µ—Ç!',
    female: '–¢—ã –µ—â–µ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–ø–∏—Å–∞–ª–∞ ü§î\n–ù–∞–ø–∏—à–∏, —á—Ç–æ —Ç–µ–±—è —Ä–∞–¥—É–µ—Ç!',
  },

  'joy_add_more': '–ù–∞–ø–∏—à–∏, —á—Ç–æ –µ—â–µ —Ö–æ—á–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å ‚ù§Ô∏è‚Äçüî•',

  'joy_menu': '–•–æ—Ä–æ—à–æ, —Ç–æ–≥–¥–∞ —á—Ç–æ —Ö–æ—á–µ—à—å —Å–¥–µ–ª–∞—Ç—å?',

  'button_practice_done': {
    male: '‚úÖ –°–¥–µ–ª–∞–ª',
    female: '‚úÖ –°–¥–µ–ª–∞–ª–∞',
  },

  // ===== DEEP WORK HANDLER =====

  // ‚ö†Ô∏è –í–ê–ñ–ù–û: –õ—è–≥—É—à–∫–∞ –≥–æ–≤–æ—Ä–∏—Ç "—è —É–≤–µ—Ä–µ–Ω" - –ú–£–ñ–°–ö–û–ô –†–û–î, –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è!
  'deep_work_no_more_examples': '–ë–æ–ª—å—à–µ –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–µ—Ç - —É–≤–µ—Ä–µ–Ω, —Ç—ã —Å–ø—Ä–∞–≤–∏—à—å—Å—è!',

  'deep_work_congrats': {
    male: '<i>–¢—ã –ø—Ä–æ–¥–µ–ª–∞–ª –æ–≥—Ä–æ–º–Ω—É—é —Ä–∞–±–æ—Ç—É! üéâ</i>\n\n' +
          '–û—Å—Ç–∞–ª–æ—Å—å –≤—Å–µ–≥–æ –ø–∞—Ä—É —à–∞–≥–æ–≤ üë£\n' +
          '<i>P.S. –ù–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π, —Å–∞–º–∞—è —Å–ª–æ–∂–Ω–∞—è —á–∞—Å—Ç—å –ø–æ–∑–∞–¥–∏\n' +
          '–ü–µ—Ä–µ–π–¥–µ–º –∫ –±–æ–ª–µ–µ –ø—Ä–∏—è—Ç–Ω–æ–π üòâ</i>',
    female: '<i>–¢—ã –ø—Ä–æ–¥–µ–ª–∞–ª–∞ –æ–≥—Ä–æ–º–Ω—É—é —Ä–∞–±–æ—Ç—É! üéâ</i>\n\n' +
            '–û—Å—Ç–∞–ª–æ—Å—å –≤—Å–µ–≥–æ –ø–∞—Ä—É —à–∞–≥–æ–≤ üë£\n' +
            '<i>P.S. –ù–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π, —Å–∞–º–∞—è —Å–ª–æ–∂–Ω–∞—è —á–∞—Å—Ç—å –ø–æ–∑–∞–¥–∏\n' +
            '–ü–µ—Ä–µ–π–¥–µ–º –∫ –±–æ–ª–µ–µ –ø—Ä–∏—è—Ç–Ω–æ–π üòâ</i>',
  },

  // ===== ONBOARDING =====

  // ‚ö†Ô∏è –í–ê–ñ–ù–û: "–Ø –±—É–¥—É —Ä–∞–¥" - –ª—è–≥—É—à–∫–∞ (–ú.–†.), –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è!
  'onboarding_wait_evening': '–û—Ç–ª–∏—á–Ω–æ! –£–≤–∏–¥–∏–º—Å—è –≤–µ—á–µ—Ä–æ–º üåô\n\n–ê –ø–æ–∫–∞ –º–æ–∂–µ—à—å –Ω–∞–ø–∏—Å–∞—Ç—å –º–Ω–µ –æ —Ç–æ–º, —á—Ç–æ —Å–µ–π—á–∞—Å —á—É–≤—Å—Ç–≤—É–µ—à—å –∏–ª–∏ —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Ç–≤–æ–µ–π –∂–∏–∑–Ω–∏. –Ø –±—É–¥—É —Ä–∞–¥ –≤—ã—Å–ª—É—à–∞—Ç—å üíö',

  // ===== PRACTICE COMPLETED (fallback —Ç–µ–∫—Å—Ç—ã) =====

  'practice_completed_1': '–¢—ã –º–æ–ª–æ–¥–µ—Ü! üåü –°–µ–≥–æ–¥–Ω—è –º—ã –æ—Ç–ª–∏—á–Ω–æ –ø–æ—Ä–∞–±–æ—Ç–∞–ª–∏ –≤–º–µ—Å—Ç–µ.',

  'practice_completed_2': '–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! üíö –¢—ã –∑–∞–±–æ—Ç–∏—à—å—Å—è –æ —Å–µ–±–µ, –∏ —ç—Ç–æ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ.',

  'practice_completed_3': '–°—É–ø–µ—Ä! ‚ú® –ö–∞–∂–¥–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –¥–µ–ª–∞–µ—Ç —Ç–µ–±—è —Å–∏–ª—å–Ω–µ–µ.',

  'practice_completed_4': {
    male: '–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ! üåà –¢—ã —Å–¥–µ–ª–∞–ª –≤–∞–∂–Ω—ã–π —à–∞–≥ –¥–ª—è —Å–≤–æ–µ–≥–æ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏—è.',
    female: '–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ! üåà –¢—ã —Å–¥–µ–ª–∞–ª–∞ –≤–∞–∂–Ω—ã–π —à–∞–≥ –¥–ª—è —Å–≤–æ–µ–≥–æ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏—è.',
  },

  'practice_completed_5': {
    male: '–¢—ã —Å–ø—Ä–∞–≤–∏–ª—Å—è! üéØ –ù–∞ —Å–µ–≥–æ–¥–Ω—è –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã.',
    female: '–¢—ã —Å–ø—Ä–∞–≤–∏–ª–∞—Å—å! üéØ –ù–∞ —Å–µ–≥–æ–¥–Ω—è –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã.',
  },

  'practice_completed_6': '–¢—ã –º–æ–ª–æ–¥–µ—Ü! üåô –ü–æ—Ä–∞ –æ—Ç–¥—ã—Ö–∞—Ç—å.',

  'practice_completed_7': {
    male: '–Ø –≥–æ—Ä–∂—É—Å—å —Ç–æ–±–æ–π! üí´ –¢—ã —Å–¥–µ–ª–∞–ª –æ—Ç–ª–∏—á–Ω—É—é —Ä–∞–±–æ—Ç—É.',
    female: '–Ø –≥–æ—Ä–∂—É—Å—å —Ç–æ–±–æ–π! üí´ –¢—ã —Å–¥–µ–ª–∞–ª–∞ –æ—Ç–ª–∏—á–Ω—É—é —Ä–∞–±–æ—Ç—É.',
  },

  'practice_completed_8': '–ü—Ä–µ–∫—Ä–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞! üéâ –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å—Å—è.',

  'practice_completed_9': '–ë—Ä–∞–≤–æ! üåø –í—Å–µ –∑–∞–¥–∞–Ω–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω—ã.',

  'practice_completed_10': {
    male: '–ó–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ! ‚≠ê –¢—ã –ø—Ä–æ—è–≤–∏–ª –∑–∞–±–æ—Ç—É –æ —Å–µ–±–µ.',
    female: '–ó–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ! ‚≠ê –¢—ã –ø—Ä–æ—è–≤–∏–ª–∞ –∑–∞–±–æ—Ç—É –æ —Å–µ–±–µ.',
  },
};

/**
 * –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏–∑ —Å–ª–æ–≤–∞—Ä—è FIXED_TEXTS —Å —É—á–µ—Ç–æ–º –ø–æ–ª–∞
 * @param key - –ö–ª—é—á —Ç–µ–∫—Å—Ç–∞ –≤ —Å–ª–æ–≤–∞—Ä–µ
 * @param gender - –ü–æ–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @returns –¢–µ–∫—Å—Ç –∏–ª–∏ null –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
 */
export function getFixedText(key: string, gender: 'male' | 'female' | 'unknown' | null): string | null {
  const text = FIXED_TEXTS[key];
  if (!text) return null;

  // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç - —Å—Ç—Ä–æ–∫–∞ (–æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –¥–ª—è –æ–±–æ–∏—Ö)
  if (typeof text === 'string') {
    return text;
  }

  // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç - –æ–±—ä–µ–∫—Ç —Å male/female
  if (gender === 'female' && text.female) {
    return text.female;
  }

  return text.male; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –º—É–∂—Å–∫–æ–π —Ä–æ–¥
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —Ç–µ–∫—Å—Ç –≤ —Å–ª–æ–≤–∞—Ä–µ FIXED_TEXTS (–ø–æ —Ç–æ—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é –∏–ª–∏ –∫–ª—é—á—É)
 * @param text - –¢–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
 * @returns –ö–ª—é—á —Ç–µ–∫—Å—Ç–∞ –≤ —Å–ª–æ–≤–∞—Ä–µ –∏–ª–∏ null
 */
function findFixedTextKey(text: string): string | null {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å –º—É–∂—Å–∫–∏–º –≤–∞—Ä–∏–∞–Ω—Ç–æ–º
  for (const [key, value] of Object.entries(FIXED_TEXTS)) {
    if (typeof value === 'string') {
      if (value === text) return key;
    } else {
      if (value.male === text) return key;
    }
  }
  return null;
}

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∞–¥–∞–ø—Ç–∞—Ü–∏–µ–π –ø–æ–¥ –ø–æ–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 *
 * –ê–†–•–ò–¢–ï–ö–¢–£–†–ê (–≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞):
 * 1. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–ª–æ–≤–∞—Ä—å FIXED_TEXTS (–≥–æ—Ç–æ–≤—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã)
 * 2. –ü–∞—Ä—Å–∏—Ç —à–∞–±–ª–æ–Ω—ã ${:–∞} ‚Üí –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω—ã ‚Üí –°–¢–û–ü
 * 3. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –º–∞—Ä–∫–µ—Ä <!-- gender:both --> ‚Üí –µ—Å–ª–∏ –Ω–∞–π–¥–µ–Ω ‚Üí –°–¢–û–ü
 * 4. FALLBACK: –ï—Å–ª–∏ –ù–ï–¢ —à–∞–±–ª–æ–Ω–∞ –ò –º–∞—Ä–∫–µ—Ä–∞ ‚Üí regex + WARNING
 *
 * @param bot - –≠–∫–∑–µ–º–ø–ª—è—Ä Telegraf –±–æ—Ç–∞
 * @param chatId - ID —á–∞—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
 * @param userId - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (–ø–æ–ª, –∏–º—è). –ï—Å–ª–∏ null/undefined - –æ—Ç–ø—Ä–∞–≤–∫–∞ –±–µ–∑ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏
 * @param text - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
 * @param options - –û–ø—Ü–∏–∏ –¥–ª—è sendMessage (reply_parameters, parse_mode –∏ —Ç.–¥.)
 * @returns Promise —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –æ—Ç–ø—Ä–∞–≤–∫–∏
 */
export async function sendToUser(
  bot: Telegraf,
  chatId: number,
  userId: number | null | undefined,
  text: string,
  options?: any
) {
  // –ï—Å–ª–∏ userId –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å (–∞–¥–º–∏–Ω—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è)
  if (!userId) {
    botLogger.debug(
      { chatId, textLength: text.length },
      '–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ (–Ω–µ—Ç userId)'
    );
    return await bot.telegram.sendMessage(chatId, text, options);
  }

  // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ chatId (–ù–ï userId!)
  // –í–ê–ñ–ù–û: getUserByChatId –ø—Ä–∏–Ω–∏–º–∞–µ—Ç chatId, –∞ –Ω–µ Telegram userId
  const user = getUserByChatId(chatId);
  const userGender = (user?.gender || 'unknown') as 'male' | 'female' | 'unknown' | null;
  const userName = user?.name || null;

  botLogger.debug(
    {
      chatId,
      userId,
      userGender,
      userName,
      textLength: text.length
    },
    '–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å –∞–¥–∞–ø—Ç–∞—Ü–∏–µ–π'
  );

  let adaptedText: string;

  // –ü–†–ò–û–†–ò–¢–ï–¢ 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–æ–≤–∞—Ä—å FIXED_TEXTS
  const fixedKey = findFixedTextKey(text);
  if (fixedKey) {
    const fixedText = getFixedText(fixedKey, userGender);
    if (fixedText) {
      adaptedText = fixedText;
      botLogger.debug({ fixedKey, userGender }, '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –∏–∑ FIXED_TEXTS');
    } else {
      // Fallback –Ω–∞ gender-adapter
      adaptedText = adaptTextForGender(text, userGender);
    }
  } else {
    // –ü–†–ò–û–†–ò–¢–ï–¢ 2: –ü–∞—Ä—Å–∏–º —à–∞–±–ª–æ–Ω—ã ${:–∞} –∏ –ø—Ä–æ–≤–µ—Ä—è–µ–º –º–∞—Ä–∫–µ—Ä <!-- gender:both -->
    const parsed = parseGenderTemplate(text, userGender);

    if (parsed.wasTemplateFound) {
      // ‚úÖ –ù–∞–π–¥–µ–Ω —à–∞–±–ª–æ–Ω –∏–ª–∏ –º–∞—Ä–∫–µ—Ä - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
      // –ù–ï –ü–†–ò–ú–ï–ù–Ø–ï–ú regex! –¢–µ–∫—Å—Ç —É–∂–µ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ —à–∞–±–ª–æ–Ω –∏–ª–∏ –ø–æ–º–µ—á–µ–Ω –∫–∞–∫ gender:both
      adaptedText = parsed.text;
      botLogger.debug(
        {
          userGender,
          substitutionsCount: parsed.substitutionsCount,
          textLength: text.length
        },
        parsed.substitutionsCount > 0
          ? '–¢–µ–∫—Å—Ç –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ —à–∞–±–ª–æ–Ω ${:–∞}'
          : '–ù–∞–π–¥–µ–Ω –º–∞—Ä–∫–µ—Ä gender:both - —Ç–µ–∫—Å—Ç –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∞–¥–∞–ø—Ç–∞—Ü–∏–∏'
      );
    } else if (userGender === 'female') {
      // –ü–†–ò–û–†–ò–¢–ï–¢ 3: FALLBACK - regex —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –ù–ï–¢ —à–∞–±–ª–æ–Ω–∞ –ò –º–∞—Ä–∫–µ—Ä–∞
      const regexAdapted = adaptTextForGender(text, userGender);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ regex –Ω–∞—à–µ–ª —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∑–∞–º–µ–Ω—É
      const hasChanges = regexAdapted !== text;

      if (hasChanges) {
        // Regex —É—Å–ø–µ—à–Ω–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–ª —Ç–µ–∫—Å—Ç
        adaptedText = regexAdapted;
        botLogger.warn(
          { textLength: text.length, textPreview: text.substring(0, 50) },
          '‚ö†Ô∏è WARNING: –¢–µ–∫—Å—Ç –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ regex fallback! –î–æ–±–∞–≤—å —à–∞–±–ª–æ–Ω ${:–∞} –≤ –∏—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª!'
        );
      } else {
        // Regex –Ω–µ –Ω–∞—à–µ–ª –∑–∞–º–µ–Ω - —Ç–µ–∫—Å—Ç –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ (–∏–ª–∏ —É–∂–µ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω, –Ω–∞–ø—Ä–∏–º–µ—Ä —á–µ—Ä–µ–∑ ending())
        adaptedText = text;
        botLogger.debug(
          { textLength: text.length },
          'Regex –Ω–µ –Ω–∞—à–µ–ª –∑–∞–º–µ–Ω - —Ç–µ–∫—Å—Ç –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –∏–ª–∏ —É–∂–µ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω'
        );
      }
    } else {
      // –î–ª—è –º—É–∂—Å–∫–æ–≥–æ —Ä–æ–¥–∞ –∏–ª–∏ unknown - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—Å—Ç –∫–∞–∫ –µ—Å—Ç—å
      adaptedText = text;
    }
  }

  // –ó–∞–º–µ–Ω—è–µ–º {userName} –µ—Å–ª–∏ –µ—Å—Ç—å –≤ —Ç–µ–∫—Å—Ç–µ
  if (userName) {
    adaptedText = adaptedText.replace(/\{userName\}/g, userName);
  }

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π API Telegram
  return await bot.telegram.sendMessage(chatId, adaptedText, options);
}
