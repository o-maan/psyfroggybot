/**
 * –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
 *
 * –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –≤–º–µ—Å—Ç–æ bot.telegram.sendMessage()
 * –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ–±—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –ø–æ–¥ –ø–æ–ª
 *
 * –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ê–î–ê–ü–¢–ê–¶–ò–ò (3 —É—Ä–æ–≤–Ω—è):
 * 1. FIXED_TEXTS: –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ (–≥–æ—Ç–æ–≤—ã–µ –≤–∞—Ä–∏–∞–Ω—Ç—ã)
 * 2. REGEX: –ë—ã—Å—Ç—Ä–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è —á–µ—Ä–µ–∑ –ø—Ä–∞–≤–∏–ª–∞ (~95% —Å–ª—É—á–∞–µ–≤, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
 * 3. LLM + –ö–ï–®: Fallback –¥–ª—è —Ä–µ–¥–∫–∏—Ö —Å–ª—É—á–∞–µ–≤, –∫–æ—Ç–æ—Ä—ã–µ regex –Ω–µ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç (–∫–µ—à 24—á)
 *
 * –í–ê–ñ–ù–û: –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–≤–µ—Ä—å –ª–æ–≥–∏ - –µ—Å–ª–∏ –≤–∏–¥–∏—à—å
 * "‚ö†Ô∏è Regex –Ω–µ –Ω–∞—à–µ–ª –∑–∞–º–µ–Ω, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω LLM fallback" - –¥–æ–±–∞–≤—å –ø—Ä–∞–≤–∏–ª–æ –≤ regex!
 */

import type { Telegraf } from 'telegraf';
import { getUserByChatId } from '../db';
import { adaptTextForGender } from './gender-adapter';
import { botLogger } from '../logger';
import { generateMessage } from '../llm';
import { cleanLLMText } from './clean-llm-text';
import { cleanLLMTextGentle, restoreFormatting, hasBasicFormatting } from './clean-llm-text-gentle';

/**
 * –ö–µ—à –¥–ª—è –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ (LLM + –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ 24 —á–∞—Å–∞)
 * –§–æ—Ä–º–∞—Ç –∫–ª—é—á–∞: "gender_—Ç–µ–∫—Å—Ç"
 */
const genderCache = new Map<string, { text: string; timestamp: number }>();
const CACHE_TTL = 24 * 60 * 60 * 1000; // 24 —á–∞—Å–∞

/**
 * –°–ª–æ–≤–∞—Ä—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ —Å –≥–æ—Ç–æ–≤—ã–º–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –¥–ª—è –∂–µ–Ω—Å–∫–æ–≥–æ —Ä–æ–¥–∞
 *
 * –°—Ç—Ä—É–∫—Ç—É—Ä–∞:
 * - male: —Ç–µ–∫—Å—Ç –≤ –º—É–∂—Å–∫–æ–º —Ä–æ–¥–µ (–±–∞–∑–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)
 * - female: —Ç–µ–∫—Å—Ç –≤ –∂–µ–Ω—Å–∫–æ–º —Ä–æ–¥–µ (–≥–æ—Ç–æ–≤—ã–π –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
 * - string: –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –¥–ª—è –æ–±–æ–∏—Ö —Ä–æ–¥–æ–≤
 *
 * –í–ê–ñ–ù–û: –≠—Ç–∏ —Ç–µ–∫—Å—Ç—ã –≤—Å–µ —Ä–∞–≤–Ω–æ –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ gender-adapter –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
 */
type FixedText =
  | { male: string; female: string }
  | string;

const FIXED_TEXTS: Record<string, FixedText> = {
  // ===== –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø =====

  'reminder_evening_task': {
    male: '! –ù–µ –∑–∞–±—É–¥—å –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ, –µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å–ø–µ–ª',
    female: '! –ù–µ –∑–∞–±—É–¥—å –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ, –µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å–ø–µ–ª–∞',
  },

  'reminder_unfinished': 'üê∏ –í–∏–∂—É, —á—Ç–æ –ª—è–≥—É—Ö–∞ –Ω–µ –ø–æ–ª—É—á–∏–ª–∞ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è. –î–∞–≤–∞–π –¥–æ–¥–µ–ª–∞–µ–º - –≤–æ–∑–≤—Ä–∞—â–∞–π—Å—è ü§ó',

  'reminder_breathing': {
    male: '–í—ã–ø–æ–ª–Ω–∏ –ø—Ä–∞–∫—Ç–∏–∫—É –∏ –Ω–∞–∂–º–∏ "–°–¥–µ–ª–∞–ª" –ø–æ—Å–ª–µ –µ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è',
    female: '–í—ã–ø–æ–ª–Ω–∏ –ø—Ä–∞–∫—Ç–∏–∫—É –∏ –Ω–∞–∂–º–∏ "–°–¥–µ–ª–∞–ª–∞" –ø–æ—Å–ª–µ –µ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è',
  },

  // ===== –ö–ù–û–ü–ö–ò –ò –ö–û–†–û–¢–ö–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø =====

  'button_finished_writing': {
    male: '–î–æ–ø–∏—Å–∞–ª? –ú–æ–∂–µ—à—å –¥–æ–ø–æ–ª–Ω–∏—Ç—å –∏ —Ç—ã–∫–∞–π –Ω–∞ –∫–Ω–æ–ø–∫—É üê∏',
    female: '–î–æ–ø–∏—Å–∞–ª–∞? –ú–æ–∂–µ—à—å –¥–æ–ø–æ–ª–Ω–∏—Ç—å –∏ —Ç—ã–∫–∞–π –Ω–∞ –∫–Ω–æ–ø–∫—É üê∏',
  },

  'before_breathing_practice': {
    male: '–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! üåü –¢–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω–∏ –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É –∏ –Ω–∞–∂–º–∏ "–°–¥–µ–ª–∞–ª" –ø–æ—Å–ª–µ –µ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è',
    female: '–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! üåü –¢–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω–∏ –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É –∏ –Ω–∞–∂–º–∏ "–°–¥–µ–ª–∞–ª–∞" –ø–æ—Å–ª–µ –µ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è',
  },

  'joy_empty_list': {
    male: '–¢—ã –µ—â–µ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–ø–∏—Å–∞–ª ü§î\n–ù–∞–ø–∏—à–∏, —á—Ç–æ —Ç–µ–±—è —Ä–∞–¥—É–µ—Ç!',
    female: '–¢—ã –µ—â–µ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–ø–∏—Å–∞–ª–∞ ü§î\n–ù–∞–ø–∏—à–∏, —á—Ç–æ —Ç–µ–±—è —Ä–∞–¥—É–µ—Ç!',
  },

  'joy_add_more': '–ù–∞–ø–∏—à–∏, —á—Ç–æ –µ—â–µ —Ö–æ—á–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å ‚ù§Ô∏è‚Äçüî•',

  'joy_menu': '–•–æ—Ä–æ—à–æ, —Ç–æ–≥–¥–∞ —á—Ç–æ —Ö–æ—á–µ—à—å —Å–¥–µ–ª–∞—Ç—å?',

  // ===== DEEP WORK HANDLER =====

  // ‚ö†Ô∏è –í–ê–ñ–ù–û: –õ—è–≥—É—à–∫–∞ –≥–æ–≤–æ—Ä–∏—Ç "—è —É–≤–µ—Ä–µ–Ω" - –ú–£–ñ–°–ö–û–ô –†–û–î, –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è!
  'deep_work_no_more_examples': '–ë–æ–ª—å—à–µ –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–µ—Ç - —É–≤–µ—Ä–µ–Ω, —Ç—ã —Å–ø—Ä–∞–≤–∏—à—å—Å—è!',

  'deep_work_congrats': {
    male: '<i>–¢—ã –ø—Ä–æ–¥–µ–ª–∞–ª –æ–≥—Ä–æ–º–Ω—É—é —Ä–∞–±–æ—Ç—É! üéâ</i>\n\n' +
          '–û—Å—Ç–∞–ª–æ—Å—å –≤—Å–µ–≥–æ –ø–∞—Ä—É —à–∞–≥–æ–≤ üë£\n' +
          '<i>P.S. –ù–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π, —Å–∞–º–∞—è —Å–ª–æ–∂–Ω–∞—è —á–∞—Å—Ç—å –ø–æ–∑–∞–¥–∏\n' +
          '–ü–µ—Ä–µ–π–¥–µ–º –∫ –±–æ–ª–µ–µ –ø—Ä–∏—è—Ç–Ω–æ–π üòâ</i>',
    female: '<i>–¢—ã –ø—Ä–æ–¥–µ–ª–∞–ª–∞ –æ–≥—Ä–æ–º–Ω—É—é —Ä–∞–±–æ—Ç—É! üéâ</i>\n\n' +
            '–û—Å—Ç–∞–ª–æ—Å—å –≤—Å–µ–≥–æ –ø–∞—Ä—É —à–∞–≥–æ–≤ üë£\n' +
            '<i>P.S. –ù–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π, —Å–∞–º–∞—è —Å–ª–æ–∂–Ω–∞—è —á–∞—Å—Ç—å –ø–æ–∑–∞–¥–∏\n' +
            '–ü–µ—Ä–µ–π–¥–µ–º –∫ –±–æ–ª–µ–µ –ø—Ä–∏—è—Ç–Ω–æ–π üòâ</i>',
  },

  // ===== ONBOARDING =====

  // ‚ö†Ô∏è –í–ê–ñ–ù–û: "–Ø –±—É–¥—É —Ä–∞–¥" - –ª—è–≥—É—à–∫–∞ (–ú.–†.), –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è!
  'onboarding_wait_evening': '–û—Ç–ª–∏—á–Ω–æ! –£–≤–∏–¥–∏–º—Å—è –≤–µ—á–µ—Ä–æ–º üåô\n\n–ê –ø–æ–∫–∞ –º–æ–∂–µ—à—å –Ω–∞–ø–∏—Å–∞—Ç—å –º–Ω–µ –æ —Ç–æ–º, —á—Ç–æ —Å–µ–π—á–∞—Å —á—É–≤—Å—Ç–≤—É–µ—à—å –∏–ª–∏ —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Ç–≤–æ–µ–π –∂–∏–∑–Ω–∏. –Ø –±—É–¥—É —Ä–∞–¥ –≤—ã—Å–ª—É—à–∞—Ç—å üíö',

  // ===== PRACTICE COMPLETED (fallback —Ç–µ–∫—Å—Ç—ã) =====

  'practice_completed_1': '–¢—ã –º–æ–ª–æ–¥–µ—Ü! üåü –°–µ–≥–æ–¥–Ω—è –º—ã –æ—Ç–ª–∏—á–Ω–æ –ø–æ—Ä–∞–±–æ—Ç–∞–ª–∏ –≤–º–µ—Å—Ç–µ.',

  'practice_completed_2': '–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! üíö –¢—ã –∑–∞–±–æ—Ç–∏—à—å—Å—è –æ —Å–µ–±–µ, –∏ —ç—Ç–æ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ.',

  'practice_completed_3': '–°—É–ø–µ—Ä! ‚ú® –ö–∞–∂–¥–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –¥–µ–ª–∞–µ—Ç —Ç–µ–±—è —Å–∏–ª—å–Ω–µ–µ.',

  'practice_completed_4': {
    male: '–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ! üåà –¢—ã —Å–¥–µ–ª–∞–ª –≤–∞–∂–Ω—ã–π —à–∞–≥ –¥–ª—è —Å–≤–æ–µ–≥–æ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏—è.',
    female: '–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ! üåà –¢—ã —Å–¥–µ–ª–∞–ª–∞ –≤–∞–∂–Ω—ã–π —à–∞–≥ –¥–ª—è —Å–≤–æ–µ–≥–æ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏—è.',
  },

  'practice_completed_5': {
    male: '–¢—ã —Å–ø—Ä–∞–≤–∏–ª—Å—è! üéØ –ù–∞ —Å–µ–≥–æ–¥–Ω—è –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã.',
    female: '–¢—ã —Å–ø—Ä–∞–≤–∏–ª–∞—Å—å! üéØ –ù–∞ —Å–µ–≥–æ–¥–Ω—è –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã.',
  },

  'practice_completed_6': '–¢—ã –º–æ–ª–æ–¥–µ—Ü! üåô –ü–æ—Ä–∞ –æ—Ç–¥—ã—Ö–∞—Ç—å.',

  'practice_completed_7': {
    male: '–Ø –≥–æ—Ä–∂—É—Å—å —Ç–æ–±–æ–π! üí´ –¢—ã —Å–¥–µ–ª–∞–ª –æ—Ç–ª–∏—á–Ω—É—é —Ä–∞–±–æ—Ç—É.',
    female: '–Ø –≥–æ—Ä–∂—É—Å—å —Ç–æ–±–æ–π! üí´ –¢—ã —Å–¥–µ–ª–∞–ª–∞ –æ—Ç–ª–∏—á–Ω—É—é —Ä–∞–±–æ—Ç—É.',
  },

  'practice_completed_8': '–ü—Ä–µ–∫—Ä–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞! üéâ –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å—Å—è.',

  'practice_completed_9': '–ë—Ä–∞–≤–æ! üåø –í—Å–µ –∑–∞–¥–∞–Ω–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω—ã.',

  'practice_completed_10': {
    male: '–ó–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ! ‚≠ê –¢—ã –ø—Ä–æ—è–≤–∏–ª –∑–∞–±–æ—Ç—É –æ —Å–µ–±–µ.',
    female: '–ó–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ! ‚≠ê –¢—ã –ø—Ä–æ—è–≤–∏–ª–∞ –∑–∞–±–æ—Ç—É –æ —Å–µ–±–µ.',
  },
};

/**
 * –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏–∑ —Å–ª–æ–≤–∞—Ä—è FIXED_TEXTS —Å —É—á–µ—Ç–æ–º –ø–æ–ª–∞
 * @param key - –ö–ª—é—á —Ç–µ–∫—Å—Ç–∞ –≤ —Å–ª–æ–≤–∞—Ä–µ
 * @param gender - –ü–æ–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @returns –¢–µ–∫—Å—Ç –∏–ª–∏ null –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
 */
function getFixedText(key: string, gender: 'male' | 'female' | 'unknown' | null): string | null {
  const text = FIXED_TEXTS[key];
  if (!text) return null;

  // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç - —Å—Ç—Ä–æ–∫–∞ (–æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –¥–ª—è –æ–±–æ–∏—Ö)
  if (typeof text === 'string') {
    return text;
  }

  // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç - –æ–±—ä–µ–∫—Ç —Å male/female
  if (gender === 'female' && text.female) {
    return text.female;
  }

  return text.male; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –º—É–∂—Å–∫–æ–π —Ä–æ–¥
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —Ç–µ–∫—Å—Ç –≤ —Å–ª–æ–≤–∞—Ä–µ FIXED_TEXTS (–ø–æ —Ç–æ—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é –∏–ª–∏ –∫–ª—é—á—É)
 * @param text - –¢–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
 * @returns –ö–ª—é—á —Ç–µ–∫—Å—Ç–∞ –≤ —Å–ª–æ–≤–∞—Ä–µ –∏–ª–∏ null
 */
function findFixedTextKey(text: string): string | null {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å –º—É–∂—Å–∫–∏–º –≤–∞—Ä–∏–∞–Ω—Ç–æ–º
  for (const [key, value] of Object.entries(FIXED_TEXTS)) {
    if (typeof value === 'string') {
      if (value === text) return key;
    } else {
      if (value.male === text) return key;
    }
  }
  return null;
}

/**
 * –ù–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç —Ç–µ–∫—Å—Ç –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è (—É–¥–∞–ª—è–µ—Ç –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã, –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫)
 *
 * @param text - –ò—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
 * @returns –ù–æ—Ä–º–∞–ª–∏–∑–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è
 */
function normalizeTextForComparison(text: string): string {
  return text
    .replace(/\s+/g, ' ') // –í—Å–µ –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –ø—Ä–æ–±–µ–ª–æ–≤/–ø–µ—Ä–µ–Ω–æ—Å–æ–≤ –≤ –æ–¥–∏–Ω –ø—Ä–æ–±–µ–ª
    .trim();
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –∏–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—å –¥–≤—É—Ö —Ç–µ–∫—Å—Ç–æ–≤ (–∏–≥–Ω–æ—Ä–∏—Ä—É—è —Ä–∞–∑–ª–∏—á–∏—è –≤ –ø—Ä–æ–±–µ–ª–∞—Ö –∏ –ø–µ—Ä–µ–Ω–æ—Å–∞—Ö —Å—Ç—Ä–æ–∫)
 *
 * @param text1 - –ü–µ—Ä–≤—ã–π —Ç–µ–∫—Å—Ç
 * @param text2 - –í—Ç–æ—Ä–æ–π —Ç–µ–∫—Å—Ç
 * @returns true –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç—ã –∏–¥–µ–Ω—Ç–∏—á–Ω—ã (–∏–≥–Ω–æ—Ä–∏—Ä—É—è —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
 */
function areTextsIdentical(text1: string, text2: string): boolean {
  return normalizeTextForComparison(text1) === normalizeTextForComparison(text2);
}

/**
 * –ê–¥–∞–ø—Ç–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –ø–æ–¥ –∂–µ–Ω—Å–∫–∏–π —Ä–æ–¥ —á–µ—Ä–µ–∑ LLM (DeepSeek-R1)
 *
 * ‚ö†Ô∏è –ò–°–ü–û–õ–¨–ó–£–ï–¢–°–Ø –¢–û–õ–¨–ö–û –ö–ê–ö FALLBACK, –∫–æ–≥–¥–∞ regex –Ω–µ –Ω–∞—à–µ–ª –∑–∞–º–µ–Ω!
 * –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ - regex (–±—ã—Å—Ç—Ä–µ–µ, —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ)
 *
 * LLM –≤—ã–∑—ã–≤–∞–µ—Ç—Å—è –≤ —Ä–µ–¥–∫–∏—Ö —Å–ª—É—á–∞—è—Ö:
 * - –°–ª–æ–∂–Ω—ã–µ –≥—Ä–∞–º–º–∞—Ç–∏—á–µ—Å–∫–∏–µ –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏, –Ω–µ –ø–æ–∫—Ä—ã—Ç—ã–µ regex –ø—Ä–∞–≤–∏–ª–∞–º–∏
 * - –ù–æ–≤—ã–µ —Ç–µ–∫—Å—Ç—ã, –¥–ª—è –∫–æ—Ç–æ—Ä—ã—Ö –µ—â–µ –Ω–µ –¥–æ–±–∞–≤–ª–µ–Ω—ã –ø—Ä–∞–≤–∏–ª–∞
 *
 * –ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è LLM:
 * 1. –ú–µ–Ω—è–µ—Ç –¢–û–õ–¨–ö–û –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (—Ç—ã —Å–¥–µ–ª–∞–ª ‚Üí —Ç—ã —Å–¥–µ–ª–∞–ª–∞)
 * 2. –ù–ï –º–µ–Ω—è–µ—Ç —Ä–µ—á—å –ª—è–≥—É—à–∫–∏-–ø—Å–∏—Ö–æ–ª–æ–≥–∞ (—è —Ä–∞–¥ ‚Üí —è —Ä–∞–¥, –ù–ï "—è —Ä–∞–¥–∞")
 * 3. –õ—è–≥—É—à–∫–∞ –í–°–ï–ì–î–ê –º—É–∂—Å–∫–æ–≥–æ —Ä–æ–¥–∞
 * 4. –ú–µ–Ω—è–µ—Ç –≥–ª–∞–≥–æ–ª—ã –ø—Ä–æ—à–µ–¥—à–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏: -–ª/-–∞–ª/-–∏–ª/-–µ–ª ‚Üí -–ª–∞/-–∞–ª–∞/-–∏–ª–∞/-–µ–ª–∞
 * 5. –ú–µ–Ω—è–µ—Ç –∫—Ä–∞—Ç–∫–∏–µ –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã–µ: -–µ–Ω/-–æ–Ω ‚Üí -–Ω–∞
 * 6. –°–û–•–†–ê–ù–Ø–ï–¢ HTML —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ (<b>, <i> –∏ —Ç.–¥.)
 * 7. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¢–û–õ–¨–ö–û –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π
 *
 * @param text - –¢–µ–∫—Å—Ç –≤ –º—É–∂—Å–∫–æ–º —Ä–æ–¥–µ
 * @returns –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–ª–∏ null –ø—Ä–∏ –æ—à–∏–±–∫–µ (–∏–ª–∏ –µ—Å–ª–∏ —Ç–µ–∫—Å—Ç –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∞–¥–∞–ø—Ç–∞—Ü–∏–∏)
 *
 * @example
 * await adaptTextWithLLM("–¢—ã —Å–ø—Ä–∞–≤–∏–ª—Å—è! –Ø —É–≤–µ—Ä–µ–Ω –≤ —Ç–µ–±–µ")
 * // => "–¢—ã —Å–ø—Ä–∞–≤–∏–ª–∞—Å—å! –Ø —É–≤–µ—Ä–µ–Ω –≤ —Ç–µ–±–µ"
 */
async function adaptTextWithLLM(text: string): Promise<string | null> {
  try {
    const prompt = `–ê–¥–∞–ø—Ç–∏—Ä—É–π —Ç–µ–∫—Å—Ç –ø–æ–¥ –∂–µ–Ω—Å–∫–∏–π —Ä–æ–¥.

‚ö†Ô∏è –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û ‚ö†Ô∏è:
- –ó–ê–ü–†–ï–©–ï–ù–û —É–¥–∞–ª—è—Ç—å emoji! –°–æ—Ö—Ä–∞–Ω—è–π –í–°–ï emoji (üê∏, üíö, üéØ –∏ —Ç.–¥.) –¢–û–ß–ù–û –Ω–∞ —Ç–µ—Ö –∂–µ –º–µ—Å—Ç–∞—Ö!
- –ó–ê–ü–†–ï–©–ï–ù–û —É–¥–∞–ª—è—Ç—å –¥–≤–æ–π–Ω—ã–µ –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫ \\n\\n! –°–æ—Ö—Ä–∞–Ω—è–π –∏—Ö –¢–û–ß–ù–û –∫–∞–∫ –≤ –æ—Ä–∏–≥–∏–Ω–∞–ª–µ!
- –ó–ê–ü–†–ï–©–ï–ù–û —É–¥–∞–ª—è—Ç—å HTML —Ç–µ–≥–∏! –°–æ—Ö—Ä–∞–Ω—è–π –≤—Å–µ <b>, <i>, <code>, <pre> –∏ —Ç.–¥.!

–ü–†–ê–í–ò–õ–ê:
1. –ú–µ–Ω—è–π –¢–û–õ–¨–ö–û –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (—Ç—ã —Å–¥–µ–ª–∞–ª ‚Üí —Ç—ã —Å–¥–µ–ª–∞–ª–∞, —Ç—ã —Å–ø—Ä–∞–≤–∏–ª—Å—è ‚Üí —Ç—ã —Å–ø—Ä–∞–≤–∏–ª–∞—Å—å)
2. –ù–ï –º–µ–Ω—è–π –æ–±—Ä–∞—â–µ–Ω–∏—è –æ—Ç –ª–∏—Ü–∞ –ª—è–≥—É—à–∫–∏-–ø—Å–∏—Ö–æ–ª–æ–≥–∞ (—è —Ä–∞–¥ ‚Üí —è —Ä–∞–¥, –ù–ï "—è —Ä–∞–¥–∞" | —è —É–≤–µ—Ä–µ–Ω ‚Üí —è —É–≤–µ—Ä–µ–Ω, –ù–ï "—è —É–≤–µ—Ä–µ–Ω–∞")
3. –õ—è–≥—É—à–∫–∞ –í–°–ï–ì–î–ê –º—É–∂—Å–∫–æ–≥–æ —Ä–æ–¥–∞
4. –ú–µ–Ω—è–π –≥–ª–∞–≥–æ–ª—ã –ø—Ä–æ—à–µ–¥—à–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏: -–ª/-–∞–ª/-–∏–ª/-–µ–ª ‚Üí -–ª–∞/-–∞–ª–∞/-–∏–ª–∞/-–µ–ª–∞
5. –ú–µ–Ω—è–π –∫—Ä–∞—Ç–∫–∏–µ –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã–µ: –≥–æ—Ç–æ–≤‚Üí–≥–æ—Ç–æ–≤–∞, —Ä–∞–¥‚Üí—Ä–∞–¥–∞ (–ù–ï —Ç—Ä–æ–≥–∞–π —Å—É—â–µ—Å—Ç–≤–∏—Ç–µ–ª—å–Ω—ã–µ —Ç–∏–ø–∞ "–º–æ–ª–æ–¥–µ—Ü"!)
6. –ù–ï –î–û–ë–ê–í–õ–Ø–ô –Ω–æ–≤—ã–µ —Å–ª–æ–≤–∞ (–¥–æ—Ä–æ–≥–∞—è, –º–∏–ª–∞—è –∏ —Ç.–¥.) - –º–µ–Ω—è–π –¢–û–õ–¨–ö–û –æ–∫–æ–Ω—á–∞–Ω–∏—è —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö —Å–ª–æ–≤!
7. –ï—Å–ª–∏ –≤ —Ç–µ–∫—Å—Ç–µ –ù–ï–¢ —Å–ª–æ–≤ —Ç—Ä–µ–±—É—é—â–∏—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è - –≤–µ—Ä–Ω–∏ —Ç–µ–∫—Å—Ç –ë–ï–ó –ò–ó–ú–ï–ù–ï–ù–ò–ô
8. –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏ –∫–∞–≤—ã—á–µ–∫

–¢–µ–∫—Å—Ç: "${text}"

–ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:`;

    const response = await generateMessage(prompt);

    if (response === 'HF_JSON_ERROR' || !response) {
      return null;
    }

    // GENTLE cleaning - —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç HTML —Ç–µ–≥–∏, emoji, –ø–µ—Ä–µ–Ω–æ—Å—ã —Å—Ç—Ä–æ–∫
    let cleaned = cleanLLMTextGentle(response);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–µ –ø—É—Å—Ç–æ–π –∏ –Ω–µ —Å–ª–∏—à–∫–æ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –ø–æ –¥–ª–∏–Ω–µ
    if (cleaned.length === 0 || cleaned.length > text.length * 2) {
      botLogger.warn({ originalLength: text.length, adaptedLength: cleaned.length }, 'LLM –≤–µ—Ä–Ω—É–ª –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç');
      return null;
    }

    // –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ LLM –¥–µ–π—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ –Ω–∞—à–µ–ª —á—Ç–æ –º–µ–Ω—è—Ç—å
    // –ï—Å–ª–∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏–¥–µ–Ω—Ç–∏—á–µ–Ω –æ—Ä–∏–≥–∏–Ω–∞–ª—É (–∏–≥–Ω–æ—Ä–∏—Ä—É—è –ø—Ä–æ–±–µ–ª—ã/–ø–µ—Ä–µ–Ω–æ—Å—ã) - —Ç–µ–∫—Å—Ç –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∞–¥–∞–ø—Ç–∞—Ü–∏–∏
    if (areTextsIdentical(cleaned, text)) {
      botLogger.info({ textLength: text.length }, '–¢–µ–∫—Å—Ç –Ω–µ —Ç—Ä–µ–±—É–µ—Ç –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ - LLM –Ω–µ –Ω–∞—à–µ–ª –∏–∑–º–µ–Ω–µ–Ω–∏–π');
      return null; // –í–µ—Ä–Ω–µ–º null —á—Ç–æ–±—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç (–±–µ–∑ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è!)
    }

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ—Ö—Ä–∞–Ω–Ω–æ—Å—Ç—å –±–∞–∑–æ–≤–æ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (HTML —Ç–µ–≥–∏, emoji)
    if (!hasBasicFormatting(cleaned, text)) {
      botLogger.warn({ textLength: text.length }, 'LLM –ø–æ—Ç–µ—Ä—è–ª —Ñ–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ - –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∏–∑ –æ—Ä–∏–≥–∏–Ω–∞–ª–∞');
      cleaned = restoreFormatting(cleaned, text);
    }

    return cleaned;
  } catch (error) {
    botLogger.error({ error, text: text.substring(0, 50) }, '–û—à–∏–±–∫–∞ LLM –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞');
    return null;
  }
}

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∞–¥–∞–ø—Ç–∞—Ü–∏–µ–π –ø–æ–¥ –ø–æ–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 *
 * –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
 * 1. –ü–æ–ª—É—á–∞–µ—Ç –ø–æ–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î (–µ—Å–ª–∏ userId –ø–µ—Ä–µ–¥–∞–Ω)
 * 2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–ª–æ–≤–∞—Ä—å FIXED_TEXTS (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
 * 3. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ - –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç —á–µ—Ä–µ–∑ gender-adapter (fallback)
 * 4. –ó–∞–º–µ–Ω—è–µ—Ç {userName} –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–µ –∏–º—è
 * 5. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram API
 *
 * @param bot - –≠–∫–∑–µ–º–ø–ª—è—Ä Telegraf –±–æ—Ç–∞
 * @param chatId - ID —á–∞—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
 * @param userId - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (–ø–æ–ª, –∏–º—è). –ï—Å–ª–∏ null/undefined - –æ—Ç–ø—Ä–∞–≤–∫–∞ –±–µ–∑ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏
 * @param text - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
 * @param options - –û–ø—Ü–∏–∏ –¥–ª—è sendMessage (reply_parameters, parse_mode –∏ —Ç.–¥.)
 * @returns Promise —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –æ—Ç–ø—Ä–∞–≤–∫–∏
 */
export async function sendToUser(
  bot: Telegraf,
  chatId: number,
  userId: number | null | undefined,
  text: string,
  options?: any
) {
  // –ï—Å–ª–∏ userId –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å (–∞–¥–º–∏–Ω—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è)
  if (!userId) {
    botLogger.debug(
      { chatId, textLength: text.length },
      '–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ (–Ω–µ—Ç userId)'
    );
    return await bot.telegram.sendMessage(chatId, text, options);
  }

  // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –ø–æ chatId (–ù–ï userId!)
  // –í–ê–ñ–ù–û: getUserByChatId –ø—Ä–∏–Ω–∏–º–∞–µ—Ç chatId, –∞ –Ω–µ Telegram userId
  const user = getUserByChatId(chatId);
  const userGender = (user?.gender || 'unknown') as 'male' | 'female' | 'unknown' | null;
  const userName = user?.name || null;

  botLogger.debug(
    {
      chatId,
      userId,
      userGender,
      userName,
      textLength: text.length
    },
    '–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å –∞–¥–∞–ø—Ç–∞—Ü–∏–µ–π'
  );

  let adaptedText: string;

  // –ü–†–ò–û–†–ò–¢–ï–¢ 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–æ–≤–∞—Ä—å FIXED_TEXTS
  const fixedKey = findFixedTextKey(text);
  if (fixedKey) {
    const fixedText = getFixedText(fixedKey, userGender);
    if (fixedText) {
      adaptedText = fixedText;
      botLogger.debug({ fixedKey, userGender }, '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –∏–∑ FIXED_TEXTS');
    } else {
      // Fallback –Ω–∞ gender-adapter
      adaptedText = adaptTextForGender(text, userGender);
    }
  } else if (userGender === 'female') {
    // –ü–†–ò–û–†–ò–¢–ï–¢ 2: –°–Ω–∞—á–∞–ª–∞ –ø—Ä–æ–±—É–µ–º regex –∞–¥–∞–ø—Ç–∞—Ü–∏—é
    const regexAdapted = adaptTextForGender(text, userGender);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ regex –Ω–∞—à–µ–ª —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É –∑–∞–º–µ–Ω—É
    const hasChanges = regexAdapted !== text;

    if (hasChanges) {
      // Regex —É—Å–ø–µ—à–Ω–æ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–ª —Ç–µ–∫—Å—Ç - –∏—Å–ø–æ–ª—å–∑—É–µ–º –µ–≥–æ
      adaptedText = regexAdapted;
      botLogger.debug({ textLength: text.length }, '–¢–µ–∫—Å—Ç –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ regex');
    } else {
      // –ü–†–ò–û–†–ò–¢–ï–¢ 3: LLM –∞–¥–∞–ø—Ç–∞—Ü–∏—è —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ regex –Ω–µ –Ω–∞—à–µ–ª –∑–∞–º–µ–Ω (fallback)
      // –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï –¥–ª—è —Ä–µ–¥–∫–∏—Ö —Å–ª—É—á–∞–µ–≤, –∫–æ—Ç–æ—Ä—ã–µ regex –Ω–µ –ø–æ–∫—Ä—ã–≤–∞–µ—Ç
      const cacheKey = `female_${text}`;
      const cached = genderCache.get(cacheKey);

      // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à (TTL = 24 —á–∞—Å–∞)
      if (cached && (Date.now() - cached.timestamp) < CACHE_TTL) {
        adaptedText = cached.text;
        botLogger.debug({ textLength: text.length }, '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–∑ LLM');
      } else {
        // –ü—ã—Ç–∞–µ–º—Å—è –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ LLM (DeepSeek-R1)
        const llmAdapted = await adaptTextWithLLM(text);

        if (llmAdapted) {
          adaptedText = llmAdapted;
          // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à –Ω–∞ 24 —á–∞—Å–∞
          genderCache.set(cacheKey, { text: llmAdapted, timestamp: Date.now() });
          botLogger.warn({ textLength: text.length }, '‚ö†Ô∏è Regex –Ω–µ –Ω–∞—à–µ–ª –∑–∞–º–µ–Ω, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω LLM fallback (–ø—Ä–æ–≤–µ—Ä—å –Ω—É–∂–Ω–æ –ª–∏ –¥–æ–±–∞–≤–∏—Ç—å –ø—Ä–∞–≤–∏–ª–æ –≤ regex)');
        } else {
          // LLM —Ç–æ–∂–µ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª - –∏—Å–ø–æ–ª—å–∑—É–µ–º –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç
          adaptedText = text;
          botLogger.warn({ textLength: text.length }, '–ù–∏ regex, –Ω–∏ LLM –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª–∏ - –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è –æ—Ä–∏–≥–∏–Ω–∞–ª—å–Ω—ã–π —Ç–µ–∫—Å—Ç');
        }
      }
    }
  } else {
    // –î–ª—è –º—É–∂—Å–∫–æ–≥–æ —Ä–æ–¥–∞ –∏–ª–∏ unknown - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—Å—Ç –∫–∞–∫ –µ—Å—Ç—å
    // (regex –∞–¥–∞–ø—Ç–µ—Ä —É–∂–µ –Ω–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è–µ—Ç –¥–ª—è male/unknown)
    adaptedText = adaptTextForGender(text, userGender);
  }

  // –ó–∞–º–µ–Ω—è–µ–º {userName} –µ—Å–ª–∏ –µ—Å—Ç—å –≤ —Ç–µ–∫—Å—Ç–µ
  if (userName) {
    adaptedText = adaptedText.replace(/\{userName\}/g, userName);
  }

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π API Telegram
  return await bot.telegram.sendMessage(chatId, adaptedText, options);
}
