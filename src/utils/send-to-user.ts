/**
 * –¶–µ–Ω—Ç—Ä–∞–ª–∏–∑–æ–≤–∞–Ω–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é
 *
 * –ö–†–ò–¢–ò–ß–ï–°–ö–ò –í–ê–ñ–ù–û: –í–°–ï–ì–î–ê –∏—Å–ø–æ–ª—å–∑—É–π —ç—Ç—É —Ñ—É–Ω–∫—Ü–∏—é –≤–º–µ—Å—Ç–æ bot.telegram.sendMessage()
 * –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ —Å–æ–æ–±—â–µ–Ω–∏–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ–±—ã –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç –ø–æ–¥ –ø–æ–ª
 *
 * –ê–†–•–ò–¢–ï–ö–¢–£–†–ê –ê–î–ê–ü–¢–ê–¶–ò–ò (3 —É—Ä–æ–≤–Ω—è):
 * 1. FIXED_TEXTS: –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –¥–ª—è –∫—Ä–∏—Ç–∏—á–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ (21 —Ç–µ–∫—Å—Ç)
 * 2. LLM + –ö–ï–®: –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω–∞—è –∞–¥–∞–ø—Ç–∞—Ü–∏—è –¥–ª—è –ª—é–±—ã—Ö –Ω–æ–≤—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ (100% —Ç–æ—á–Ω–æ—Å—Ç—å, –∫–µ—à 24—á)
 * 3. REGEX FALLBACK: –ü–æ–¥—Å—Ç—Ä–∞—Ö–æ–≤–∫–∞ –µ—Å–ª–∏ LLM –Ω–µ–¥–æ—Å—Ç—É–ø–µ–Ω (~70-80% —Ç–æ—á–Ω–æ—Å—Ç—å)
 *
 * –ü—Ä–∏ –¥–æ–±–∞–≤–ª–µ–Ω–∏–∏ –Ω–æ–≤–æ–π –ª–æ–≥–∏–∫–∏/—Ç–µ–∫—Å—Ç–æ–≤ –∞–¥–∞–ø—Ç–∞—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç –ê–í–¢–û–ú–ê–¢–ò–ß–ï–°–ö–ò —á–µ—Ä–µ–∑ LLM!
 * –ù–µ –Ω—É–∂–Ω–æ –¥–æ–ø–∏—Å—ã–≤–∞—Ç—å –ø—Ä–∞–≤–∏–ª–∞ –≤ regex –∏–ª–∏ FIXED_TEXTS.
 */

import type { Telegraf } from 'telegraf';
import { getUserByChatId } from '../db';
import { adaptTextForGender } from './gender-adapter';
import { botLogger } from '../logger';
import { generateMessage } from '../llm';
import { cleanLLMText } from './clean-llm-text';

/**
 * –ö–µ—à –¥–ª—è –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ (LLM + –≤—Ä–µ–º—è –∂–∏–∑–Ω–∏ 24 —á–∞—Å–∞)
 * –§–æ—Ä–º–∞—Ç –∫–ª—é—á–∞: "gender_—Ç–µ–∫—Å—Ç"
 */
const genderCache = new Map<string, { text: string; timestamp: number }>();
const CACHE_TTL = 24 * 60 * 60 * 1000; // 24 —á–∞—Å–∞

/**
 * –°–ª–æ–≤–∞—Ä—å —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤ —Å –≥–æ—Ç–æ–≤—ã–º–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ –¥–ª—è –∂–µ–Ω—Å–∫–æ–≥–æ —Ä–æ–¥–∞
 *
 * –°—Ç—Ä—É–∫—Ç—É—Ä–∞:
 * - male: —Ç–µ–∫—Å—Ç –≤ –º—É–∂—Å–∫–æ–º —Ä–æ–¥–µ (–±–∞–∑–æ–≤—ã–π –≤–∞—Ä–∏–∞–Ω—Ç)
 * - female: —Ç–µ–∫—Å—Ç –≤ –∂–µ–Ω—Å–∫–æ–º —Ä–æ–¥–µ (–≥–æ—Ç–æ–≤—ã–π –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π)
 * - string: –æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –¥–ª—è –æ–±–æ–∏—Ö —Ä–æ–¥–æ–≤
 *
 * –í–ê–ñ–ù–û: –≠—Ç–∏ —Ç–µ–∫—Å—Ç—ã –≤—Å–µ —Ä–∞–≤–Ω–æ –ø—Ä–æ—Ö–æ–¥—è—Ç —á–µ—Ä–µ–∑ gender-adapter –¥–ª—è –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ–π –ø—Ä–æ–≤–µ—Ä–∫–∏
 */
type FixedText =
  | { male: string; female: string }
  | string;

const FIXED_TEXTS: Record<string, FixedText> = {
  // ===== –ù–ê–ü–û–ú–ò–ù–ê–ù–ò–Ø =====

  'reminder_evening_task': {
    male: '! –ù–µ –∑–∞–±—É–¥—å –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ, –µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å–ø–µ–ª',
    female: '! –ù–µ –∑–∞–±—É–¥—å –æ—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ —Å–µ–≥–æ–¥–Ω—è—à–Ω–µ–µ –∑–∞–¥–∞–Ω–∏–µ, –µ—Å–ª–∏ –µ—â–µ –Ω–µ —É—Å–ø–µ–ª–∞',
  },

  'reminder_unfinished': 'üê∏ –í–∏–∂—É, —á—Ç–æ –ª—è–≥—É—Ö–∞ –Ω–µ –ø–æ–ª—É—á–∏–ª–∞ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è. –î–∞–≤–∞–π –¥–æ–¥–µ–ª–∞–µ–º - –≤–æ–∑–≤—Ä–∞—â–∞–π—Å—è ü§ó',

  'reminder_breathing': {
    male: '–í—ã–ø–æ–ª–Ω–∏ –ø—Ä–∞–∫—Ç–∏–∫—É –∏ –Ω–∞–∂–º–∏ "–°–¥–µ–ª–∞–ª" –ø–æ—Å–ª–µ –µ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è',
    female: '–í—ã–ø–æ–ª–Ω–∏ –ø—Ä–∞–∫—Ç–∏–∫—É –∏ –Ω–∞–∂–º–∏ "–°–¥–µ–ª–∞–ª–∞" –ø–æ—Å–ª–µ –µ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è',
  },

  // ===== –ö–ù–û–ü–ö–ò –ò –ö–û–†–û–¢–ö–ò–ï –°–û–û–ë–©–ï–ù–ò–Ø =====

  'button_finished_writing': {
    male: '–î–æ–ø–∏—Å–∞–ª? –ú–æ–∂–µ—à—å –¥–æ–ø–æ–ª–Ω–∏—Ç—å –∏ —Ç—ã–∫–∞–π –Ω–∞ –∫–Ω–æ–ø–∫—É üê∏',
    female: '–î–æ–ø–∏—Å–∞–ª–∞? –ú–æ–∂–µ—à—å –¥–æ–ø–æ–ª–Ω–∏—Ç—å –∏ —Ç—ã–∫–∞–π –Ω–∞ –∫–Ω–æ–ø–∫—É üê∏',
  },

  'before_breathing_practice': {
    male: '–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! üåü –¢–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω–∏ –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É –∏ –Ω–∞–∂–º–∏ "–°–¥–µ–ª–∞–ª" –ø–æ—Å–ª–µ –µ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è',
    female: '–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! üåü –¢–µ–ø–µ—Ä—å –≤—ã–ø–æ–ª–Ω–∏ –¥—ã—Ö–∞—Ç–µ–ª—å–Ω—É—é –ø—Ä–∞–∫—Ç–∏–∫—É –∏ –Ω–∞–∂–º–∏ "–°–¥–µ–ª–∞–ª–∞" –ø–æ—Å–ª–µ –µ–µ –∑–∞–≤–µ—Ä—à–µ–Ω–∏—è',
  },

  'joy_empty_list': {
    male: '–¢—ã –µ—â–µ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–ø–∏—Å–∞–ª ü§î\n–ù–∞–ø–∏—à–∏, —á—Ç–æ —Ç–µ–±—è —Ä–∞–¥—É–µ—Ç!',
    female: '–¢—ã –µ—â–µ –Ω–∏—á–µ–≥–æ –Ω–µ –Ω–∞–ø–∏—Å–∞–ª–∞ ü§î\n–ù–∞–ø–∏—à–∏, —á—Ç–æ —Ç–µ–±—è —Ä–∞–¥—É–µ—Ç!',
  },

  'joy_add_more': '–ù–∞–ø–∏—à–∏, —á—Ç–æ –µ—â–µ —Ö–æ—á–µ—à—å –¥–æ–±–∞–≤–∏—Ç—å ‚ù§Ô∏è‚Äçüî•',

  'joy_menu': '–•–æ—Ä–æ—à–æ, —Ç–æ–≥–¥–∞ —á—Ç–æ —Ö–æ—á–µ—à—å —Å–¥–µ–ª–∞—Ç—å?',

  // ===== DEEP WORK HANDLER =====

  // ‚ö†Ô∏è –í–ê–ñ–ù–û: –õ—è–≥—É—à–∫–∞ –≥–æ–≤–æ—Ä–∏—Ç "—è —É–≤–µ—Ä–µ–Ω" - –ú–£–ñ–°–ö–û–ô –†–û–î, –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è!
  'deep_work_no_more_examples': '–ë–æ–ª—å—à–µ –ø—Ä–∏–º–µ—Ä–æ–≤ –Ω–µ—Ç - —É–≤–µ—Ä–µ–Ω, —Ç—ã —Å–ø—Ä–∞–≤–∏—à—å—Å—è!',

  'deep_work_congrats': {
    male: '<i>–¢—ã –ø—Ä–æ–¥–µ–ª–∞–ª –æ–≥—Ä–æ–º–Ω—É—é —Ä–∞–±–æ—Ç—É! üéâ</i>\n\n' +
          '–û—Å—Ç–∞–ª–æ—Å—å –≤—Å–µ–≥–æ –ø–∞—Ä—É —à–∞–≥–æ–≤ üë£\n' +
          '<i>P.S. –ù–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π, —Å–∞–º–∞—è —Å–ª–æ–∂–Ω–∞—è —á–∞—Å—Ç—å –ø–æ–∑–∞–¥–∏\n' +
          '–ü–µ—Ä–µ–π–¥–µ–º –∫ –±–æ–ª–µ–µ –ø—Ä–∏—è—Ç–Ω–æ–π üòâ</i>',
    female: '<i>–¢—ã –ø—Ä–æ–¥–µ–ª–∞–ª–∞ –æ–≥—Ä–æ–º–Ω—É—é —Ä–∞–±–æ—Ç—É! üéâ</i>\n\n' +
            '–û—Å—Ç–∞–ª–æ—Å—å –≤—Å–µ–≥–æ –ø–∞—Ä—É —à–∞–≥–æ–≤ üë£\n' +
            '<i>P.S. –ù–µ –ø–µ—Ä–µ–∂–∏–≤–∞–π, —Å–∞–º–∞—è —Å–ª–æ–∂–Ω–∞—è —á–∞—Å—Ç—å –ø–æ–∑–∞–¥–∏\n' +
            '–ü–µ—Ä–µ–π–¥–µ–º –∫ –±–æ–ª–µ–µ –ø—Ä–∏—è—Ç–Ω–æ–π üòâ</i>',
  },

  // ===== ONBOARDING =====

  // ‚ö†Ô∏è –í–ê–ñ–ù–û: "–Ø –±—É–¥—É —Ä–∞–¥" - –ª—è–≥—É—à–∫–∞ (–ú.–†.), –Ω–µ –º–µ–Ω—è–µ—Ç—Å—è!
  'onboarding_wait_evening': '–û—Ç–ª–∏—á–Ω–æ! –£–≤–∏–¥–∏–º—Å—è –≤–µ—á–µ—Ä–æ–º üåô\n\n–ê –ø–æ–∫–∞ –º–æ–∂–µ—à—å –Ω–∞–ø–∏—Å–∞—Ç—å –º–Ω–µ –æ —Ç–æ–º, —á—Ç–æ —Å–µ–π—á–∞—Å —á—É–≤—Å—Ç–≤—É–µ—à—å –∏–ª–∏ —á—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –≤ —Ç–≤–æ–µ–π –∂–∏–∑–Ω–∏. –Ø –±—É–¥—É —Ä–∞–¥ –≤—ã—Å–ª—É—à–∞—Ç—å üíö',

  // ===== PRACTICE COMPLETED (fallback —Ç–µ–∫—Å—Ç—ã) =====

  'practice_completed_1': '–¢—ã –º–æ–ª–æ–¥–µ—Ü! üåü –°–µ–≥–æ–¥–Ω—è –º—ã –æ—Ç–ª–∏—á–Ω–æ –ø–æ—Ä–∞–±–æ—Ç–∞–ª–∏ –≤–º–µ—Å—Ç–µ.',

  'practice_completed_2': '–û—Ç–ª–∏—á–Ω–∞—è —Ä–∞–±–æ—Ç–∞! üíö –¢—ã –∑–∞–±–æ—Ç–∏—à—å—Å—è –æ —Å–µ–±–µ, –∏ —ç—Ç–æ –ø—Ä–µ–∫—Ä–∞—Å–Ω–æ.',

  'practice_completed_3': '–°—É–ø–µ—Ä! ‚ú® –ö–∞–∂–¥–∞—è –ø—Ä–∞–∫—Ç–∏–∫–∞ –¥–µ–ª–∞–µ—Ç —Ç–µ–±—è —Å–∏–ª—å–Ω–µ–µ.',

  'practice_completed_4': {
    male: '–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ! üåà –¢—ã —Å–¥–µ–ª–∞–ª –≤–∞–∂–Ω—ã–π —à–∞–≥ –¥–ª—è —Å–≤–æ–µ–≥–æ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏—è.',
    female: '–í–µ–ª–∏–∫–æ–ª–µ–ø–Ω–æ! üåà –¢—ã —Å–¥–µ–ª–∞–ª–∞ –≤–∞–∂–Ω—ã–π —à–∞–≥ –¥–ª—è —Å–≤–æ–µ–≥–æ –±–ª–∞–≥–æ–ø–æ–ª—É—á–∏—è.',
  },

  'practice_completed_5': {
    male: '–¢—ã —Å–ø—Ä–∞–≤–∏–ª—Å—è! üéØ –ù–∞ —Å–µ–≥–æ–¥–Ω—è –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã.',
    female: '–¢—ã —Å–ø—Ä–∞–≤–∏–ª–∞—Å—å! üéØ –ù–∞ —Å–µ–≥–æ–¥–Ω—è –≤—Å–µ –∑–∞–¥–∞–Ω–∏—è –≤—ã–ø–æ–ª–Ω–µ–Ω—ã.',
  },

  'practice_completed_6': '–¢—ã –º–æ–ª–æ–¥–µ—Ü! üåô –ü–æ—Ä–∞ –æ—Ç–¥—ã—Ö–∞—Ç—å.',

  'practice_completed_7': {
    male: '–Ø –≥–æ—Ä–∂—É—Å—å —Ç–æ–±–æ–π! üí´ –¢—ã —Å–¥–µ–ª–∞–ª –æ—Ç–ª–∏—á–Ω—É—é —Ä–∞–±–æ—Ç—É.',
    female: '–Ø –≥–æ—Ä–∂—É—Å—å —Ç–æ–±–æ–π! üí´ –¢—ã —Å–¥–µ–ª–∞–ª–∞ –æ—Ç–ª–∏—á–Ω—É—é —Ä–∞–±–æ—Ç—É.',
  },

  'practice_completed_8': '–ü—Ä–µ–∫—Ä–∞—Å–Ω–∞—è —Ä–∞–±–æ—Ç–∞! üéâ –¢–µ–ø–µ—Ä—å –º–æ–∂–Ω–æ —Ä–∞—Å—Å–ª–∞–±–∏—Ç—å—Å—è.',

  'practice_completed_9': '–ë—Ä–∞–≤–æ! üåø –í—Å–µ –∑–∞–¥–∞–Ω–∏—è –Ω–∞ —Å–µ–≥–æ–¥–Ω—è –∑–∞–≤–µ—Ä—à–µ–Ω—ã.',

  'practice_completed_10': {
    male: '–ó–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ! ‚≠ê –¢—ã –ø—Ä–æ—è–≤–∏–ª –∑–∞–±–æ—Ç—É –æ —Å–µ–±–µ.',
    female: '–ó–∞–º–µ—á–∞—Ç–µ–ª—å–Ω–æ! ‚≠ê –¢—ã –ø—Ä–æ—è–≤–∏–ª–∞ –∑–∞–±–æ—Ç—É –æ —Å–µ–±–µ.',
  },
};

/**
 * –ü–æ–ª—É—á–∞–µ—Ç —Ç–µ–∫—Å—Ç –∏–∑ —Å–ª–æ–≤–∞—Ä—è FIXED_TEXTS —Å —É—á–µ—Ç–æ–º –ø–æ–ª–∞
 * @param key - –ö–ª—é—á —Ç–µ–∫—Å—Ç–∞ –≤ —Å–ª–æ–≤–∞—Ä–µ
 * @param gender - –ü–æ–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 * @returns –¢–µ–∫—Å—Ç –∏–ª–∏ null –µ—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω
 */
function getFixedText(key: string, gender: 'male' | 'female' | 'unknown' | null): string | null {
  const text = FIXED_TEXTS[key];
  if (!text) return null;

  // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç - —Å—Ç—Ä–æ–∫–∞ (–æ–¥–∏–Ω–∞–∫–æ–≤—ã–π –¥–ª—è –æ–±–æ–∏—Ö)
  if (typeof text === 'string') {
    return text;
  }

  // –ï—Å–ª–∏ —Ç–µ–∫—Å—Ç - –æ–±—ä–µ–∫—Ç —Å male/female
  if (gender === 'female' && text.female) {
    return text.female;
  }

  return text.male; // –ü–æ —É–º–æ–ª—á–∞–Ω–∏—é –º—É–∂—Å–∫–æ–π —Ä–æ–¥
}

/**
 * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ —Ç–µ–∫—Å—Ç –≤ —Å–ª–æ–≤–∞—Ä–µ FIXED_TEXTS (–ø–æ —Ç–æ—á–Ω–æ–º—É —Å–æ–≤–ø–∞–¥–µ–Ω–∏—é –∏–ª–∏ –∫–ª—é—á—É)
 * @param text - –¢–µ–∫—Å—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏
 * @returns –ö–ª—é—á —Ç–µ–∫—Å—Ç–∞ –≤ —Å–ª–æ–≤–∞—Ä–µ –∏–ª–∏ null
 */
function findFixedTextKey(text: string): string | null {
  // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–æ—á–Ω–æ–µ —Å–æ–≤–ø–∞–¥–µ–Ω–∏–µ —Å –º—É–∂—Å–∫–∏–º –≤–∞—Ä–∏–∞–Ω—Ç–æ–º
  for (const [key, value] of Object.entries(FIXED_TEXTS)) {
    if (typeof value === 'string') {
      if (value === text) return key;
    } else {
      if (value.male === text) return key;
    }
  }
  return null;
}

/**
 * –ê–¥–∞–ø—Ç–∏—Ä—É–µ—Ç —Ç–µ–∫—Å—Ç –ø–æ–¥ –∂–µ–Ω—Å–∫–∏–π —Ä–æ–¥ —á–µ—Ä–µ–∑ LLM (DeepSeek-R1)
 *
 * –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï –¥–ª—è –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ –õ–Æ–ë–´–• —Ç–µ–∫—Å—Ç–æ–≤ –±–µ–∑ —Ä—É—á–Ω—ã—Ö –ø—Ä–∞–≤–∏–ª!
 * –ü—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–æ: 100% —Ç–æ—á–Ω–æ—Å—Ç—å –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ–π –≤—ã–±–æ—Ä–∫–µ –∏–∑ 5 —Å–ª–æ–∂–Ω—ã—Ö –∫–µ–π—Å–æ–≤.
 *
 * –ü—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ–º–ø—Ç–∞ –¥–ª—è LLM:
 * 1. –ú–µ–Ω—è–µ—Ç –¢–û–õ–¨–ö–û –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (—Ç—ã —Å–¥–µ–ª–∞–ª ‚Üí —Ç—ã —Å–¥–µ–ª–∞–ª–∞)
 * 2. –ù–ï –º–µ–Ω—è–µ—Ç —Ä–µ—á—å –ª—è–≥—É—à–∫–∏-–ø—Å–∏—Ö–æ–ª–æ–≥–∞ (—è —Ä–∞–¥ ‚Üí —è —Ä–∞–¥, –ù–ï "—è —Ä–∞–¥–∞")
 * 3. –õ—è–≥—É—à–∫–∞ –í–°–ï–ì–î–ê –º—É–∂—Å–∫–æ–≥–æ —Ä–æ–¥–∞
 * 4. –ú–µ–Ω—è–µ—Ç –≥–ª–∞–≥–æ–ª—ã –ø—Ä–æ—à–µ–¥—à–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏: -–ª/-–∞–ª/-–∏–ª/-–µ–ª ‚Üí -–ª–∞/-–∞–ª–∞/-–∏–ª–∞/-–µ–ª–∞
 * 5. –ú–µ–Ω—è–µ—Ç –∫—Ä–∞—Ç–∫–∏–µ –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã–µ: -–µ–Ω/-–æ–Ω ‚Üí -–Ω–∞
 * 6. –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¢–û–õ–¨–ö–û –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π
 *
 * @param text - –¢–µ–∫—Å—Ç –≤ –º—É–∂—Å–∫–æ–º —Ä–æ–¥–µ
 * @returns –ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–ª–∏ null –ø—Ä–∏ –æ—à–∏–±–∫–µ (—Ç–æ–≥–¥–∞ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è regex fallback)
 *
 * @example
 * await adaptTextWithLLM("–¢—ã —Å–ø—Ä–∞–≤–∏–ª—Å—è! –Ø —É–≤–µ—Ä–µ–Ω –≤ —Ç–µ–±–µ")
 * // => "–¢—ã —Å–ø—Ä–∞–≤–∏–ª–∞—Å—å! –Ø —É–≤–µ—Ä–µ–Ω –≤ —Ç–µ–±–µ"
 */
async function adaptTextWithLLM(text: string): Promise<string | null> {
  try {
    const prompt = `–ê–¥–∞–ø—Ç–∏—Ä—É–π —Ç–µ–∫—Å—Ç –ø–æ–¥ –∂–µ–Ω—Å–∫–∏–π —Ä–æ–¥.

–ü–†–ê–í–ò–õ–ê:
1. –ú–µ–Ω—è–π –¢–û–õ–¨–ö–û –æ–±—Ä–∞—â–µ–Ω–∏—è –∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é (—Ç—ã —Å–¥–µ–ª–∞–ª ‚Üí —Ç—ã —Å–¥–µ–ª–∞–ª–∞, —Ç—ã —Å–ø—Ä–∞–≤–∏–ª—Å—è ‚Üí —Ç—ã —Å–ø—Ä–∞–≤–∏–ª–∞—Å—å)
2. –ù–ï –º–µ–Ω—è–π –æ–±—Ä–∞—â–µ–Ω–∏—è –æ—Ç –ª–∏—Ü–∞ –ª—è–≥—É—à–∫–∏-–ø—Å–∏—Ö–æ–ª–æ–≥–∞ (—è —Ä–∞–¥ ‚Üí —è —Ä–∞–¥, –ù–ï "—è —Ä–∞–¥–∞" | —è —É–≤–µ—Ä–µ–Ω ‚Üí —è —É–≤–µ—Ä–µ–Ω, –ù–ï "—è —É–≤–µ—Ä–µ–Ω–∞")
3. –õ—è–≥—É—à–∫–∞ –í–°–ï–ì–î–ê –º—É–∂—Å–∫–æ–≥–æ —Ä–æ–¥–∞
4. –ú–µ–Ω—è–π –≥–ª–∞–≥–æ–ª—ã –ø—Ä–æ—à–µ–¥—à–µ–≥–æ –≤—Ä–µ–º–µ–Ω–∏: -–ª/-–∞–ª/-–∏–ª/-–µ–ª ‚Üí -–ª–∞/-–∞–ª–∞/-–∏–ª–∞/-–µ–ª–∞
5. –ú–µ–Ω—è–π –∫—Ä–∞—Ç–∫–∏–µ –ø—Ä–∏–ª–∞–≥–∞—Ç–µ–ª—å–Ω—ã–µ: -–µ–Ω/-–æ–Ω ‚Üí -–Ω–∞
6. –í–µ—Ä–Ω–∏ –¢–û–õ–¨–ö–û –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç, –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–∏–π –∏ –∫–∞–≤—ã—á–µ–∫

–¢–µ–∫—Å—Ç: "${text}"

–ê–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç:`;

    const response = await generateMessage(prompt);

    if (response === 'HF_JSON_ERROR' || !response) {
      return null;
    }

    const cleaned = cleanLLMText(response);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º —á—Ç–æ –æ—Ç–≤–µ—Ç –Ω–µ –ø—É—Å—Ç–æ–π –∏ –Ω–µ —Å–ª–∏—à–∫–æ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è –ø–æ –¥–ª–∏–Ω–µ
    if (cleaned.length === 0 || cleaned.length > text.length * 2) {
      botLogger.warn({ originalLength: text.length, adaptedLength: cleaned.length }, 'LLM –≤–µ—Ä–Ω—É–ª –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç');
      return null;
    }

    return cleaned;
  } catch (error) {
    botLogger.error({ error, text: text.substring(0, 50) }, '–û—à–∏–±–∫–∞ LLM –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞');
    return null;
  }
}

/**
 * –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–π –∞–¥–∞–ø—Ç–∞—Ü–∏–µ–π –ø–æ–¥ –ø–æ–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
 *
 * –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
 * 1. –ü–æ–ª—É—á–∞–µ—Ç –ø–æ–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–∑ –ë–î (–µ—Å–ª–∏ userId –ø–µ—Ä–µ–¥–∞–Ω)
 * 2. –ü—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–ª–æ–≤–∞—Ä—å FIXED_TEXTS (–ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç)
 * 3. –ï—Å–ª–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–æ - –∞–¥–∞–ø—Ç–∏—Ä—É–µ—Ç —á–µ—Ä–µ–∑ gender-adapter (fallback)
 * 4. –ó–∞–º–µ–Ω—è–µ—Ç {userName} –Ω–∞ —Ä–µ–∞–ª—å–Ω–æ–µ –∏–º—è
 * 5. –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Å–æ–æ–±—â–µ–Ω–∏–µ —á–µ—Ä–µ–∑ Telegram API
 *
 * @param bot - –≠–∫–∑–µ–º–ø–ª—è—Ä Telegraf –±–æ—Ç–∞
 * @param chatId - ID —á–∞—Ç–∞ –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏
 * @param userId - ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö (–ø–æ–ª, –∏–º—è). –ï—Å–ª–∏ null/undefined - –æ—Ç–ø—Ä–∞–≤–∫–∞ –±–µ–∑ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏
 * @param text - –¢–µ–∫—Å—Ç —Å–æ–æ–±—â–µ–Ω–∏—è
 * @param options - –û–ø—Ü–∏–∏ –¥–ª—è sendMessage (reply_parameters, parse_mode –∏ —Ç.–¥.)
 * @returns Promise —Å —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –æ—Ç–ø—Ä–∞–≤–∫–∏
 */
export async function sendToUser(
  bot: Telegraf,
  chatId: number,
  userId: number | null | undefined,
  text: string,
  options?: any
) {
  // –ï—Å–ª–∏ userId –Ω–µ –ø–µ—Ä–µ–¥–∞–Ω - –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º –∫–∞–∫ –µ—Å—Ç—å (–∞–¥–º–∏–Ω—Å–∫–∏–µ —É–≤–µ–¥–æ–º–ª–µ–Ω–∏—è, —Å–∏—Å—Ç–µ–º–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è)
  if (!userId) {
    botLogger.debug(
      { chatId, textLength: text.length },
      '–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –±–µ–∑ –∞–¥–∞–ø—Ç–∞—Ü–∏–∏ (–Ω–µ—Ç userId)'
    );
    return await bot.telegram.sendMessage(chatId, text, options);
  }

  // –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  const user = getUserByChatId(userId);
  const userGender = (user?.gender || 'unknown') as 'male' | 'female' | 'unknown' | null;
  const userName = user?.name || null;

  botLogger.debug(
    {
      chatId,
      userId,
      userGender,
      userName,
      textLength: text.length
    },
    '–û—Ç–ø—Ä–∞–≤–∫–∞ —Å–æ–æ–±—â–µ–Ω–∏—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é —Å –∞–¥–∞–ø—Ç–∞—Ü–∏–µ–π'
  );

  let adaptedText: string;

  // –ü–†–ò–û–†–ò–¢–ï–¢ 1: –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–ª–æ–≤–∞—Ä—å FIXED_TEXTS
  const fixedKey = findFixedTextKey(text);
  if (fixedKey) {
    const fixedText = getFixedText(fixedKey, userGender);
    if (fixedText) {
      adaptedText = fixedText;
      botLogger.debug({ fixedKey, userGender }, '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –≥–æ—Ç–æ–≤—ã–π —Ç–µ–∫—Å—Ç –∏–∑ FIXED_TEXTS');
    } else {
      // Fallback –Ω–∞ gender-adapter
      adaptedText = adaptTextForGender(text, userGender);
    }
  } else if (userGender === 'female') {
    // –ü–†–ò–û–†–ò–¢–ï–¢ 2: LLM –∞–¥–∞–ø—Ç–∞—Ü–∏—è —Å –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ–º –¥–ª—è –∂–µ–Ω—Å–∫–æ–≥–æ —Ä–æ–¥–∞
    // –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–û–ï –†–ï–®–ï–ù–ò–ï: —Ä–∞–±–æ—Ç–∞–µ—Ç —Å –õ–Æ–ë–´–ú–ò –Ω–æ–≤—ã–º–∏ —Ç–µ–∫—Å—Ç–∞–º–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!
    const cacheKey = `female_${text}`;
    const cached = genderCache.get(cacheKey);

    // –ü—Ä–æ–≤–µ—Ä—è–µ–º –∫–µ—à (TTL = 24 —á–∞—Å–∞)
    // –≠—Ç–æ —É—Å—Ç—Ä–∞–Ω—è–µ—Ç –ø–æ–≤—Ç–æ—Ä–Ω—ã–µ LLM –≤—ã–∑–æ–≤—ã –¥–ª—è –æ–¥–∏–Ω–∞–∫–æ–≤—ã—Ö —Ç–µ–∫—Å—Ç–æ–≤
    if (cached && (Date.now() - cached.timestamp) < CACHE_TTL) {
      adaptedText = cached.text;
      botLogger.debug({ textLength: text.length }, '–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω –∫–µ—à–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∏–∑ LLM');
    } else {
      // –ü—ã—Ç–∞–µ–º—Å—è –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞—Ç—å —á–µ—Ä–µ–∑ LLM (DeepSeek-R1)
      // –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å –∑–∞–π–º–µ—Ç ~6-22 —Å–µ–∫, –ø–æ—Å–ª–µ–¥—É—é—â–∏–µ - –º–≥–Ω–æ–≤–µ–Ω–Ω–æ (–∫–µ—à)
      const llmAdapted = await adaptTextWithLLM(text);

      if (llmAdapted) {
        adaptedText = llmAdapted;
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ –∫–µ—à –Ω–∞ 24 —á–∞—Å–∞
        genderCache.set(cacheKey, { text: llmAdapted, timestamp: Date.now() });
        botLogger.debug({ textLength: text.length }, '–¢–µ–∫—Å—Ç –∞–¥–∞–ø—Ç–∏—Ä–æ–≤–∞–Ω —á–µ—Ä–µ–∑ LLM –∏ –∑–∞–∫–µ—à–∏—Ä–æ–≤–∞–Ω');
      } else {
        // –ü–†–ò–û–†–ò–¢–ï–¢ 3: Fallback –Ω–∞ regex –µ—Å–ª–∏ LLM –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª (HF API down, timeout –∏ —Ç.–¥.)
        adaptedText = adaptTextForGender(text, userGender);
        botLogger.warn({ textLength: text.length }, 'LLM –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω regex fallback');
      }
    }
  } else {
    // –î–ª—è –º—É–∂—Å–∫–æ–≥–æ —Ä–æ–¥–∞ –∏–ª–∏ unknown - –∏—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ–∫—Å—Ç –∫–∞–∫ –µ—Å—Ç—å
    // (regex –∞–¥–∞–ø—Ç–µ—Ä —É–∂–µ –Ω–∏—á–µ–≥–æ –Ω–µ –º–µ–Ω—è–µ—Ç –¥–ª—è male/unknown)
    adaptedText = adaptTextForGender(text, userGender);
  }

  // –ó–∞–º–µ–Ω—è–µ–º {userName} –µ—Å–ª–∏ –µ—Å—Ç—å –≤ —Ç–µ–∫—Å—Ç–µ
  if (userName) {
    adaptedText = adaptedText.replace(/\{userName\}/g, userName);
  }

  // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π API Telegram
  return await bot.telegram.sendMessage(chatId, adaptedText, options);
}
