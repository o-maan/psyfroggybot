/**
 * Утилита для адаптации текста под пол пользователя
 *
 * ВАЖНО: Лягушка ВСЕГДА мужского рода ("я рад", "я готов")
 * Меняются только обращения к пользователю ("ты сделал" → "ты сделала")
 */

/**
 * Адаптирует текст для женского пола
 * Заменяет окончания глаголов и прилагательных в обращениях к пользователю
 *
 * @param text - Исходный текст (написан для мужского рода)
 * @param gender - Пол пользователя ('male' | 'female' | 'unknown')
 * @returns Адаптированный текст
 */
export function adaptTextForGender(text: string, gender: 'male' | 'female' | 'unknown' | null): string {
  // Для мужского пола и unknown оставляем текст как есть
  if (gender !== 'female') {
    return text;
  }

  // Список замен ТОЛЬКО для обращений к пользователю (с "ты")
  // НЕ трогаем фразы от лица лягушки ("я рад", "я готов")
  // ВАЖНО: \b не работает с кириллицей! Используем пробелы и конец строки
  const replacements: Array<[RegExp, string | ((...args: any[]) => string)]> = [
    // ===== УНИВЕРСАЛЬНЫЕ ПРАВИЛА ДЛЯ ВСЕХ ГЛАГОЛОВ =====
    // ВАЖНО: Порядок имеет значение! Специфичные правила ПЕРЕД универсальными

    // 1. КРАТКИЕ ПРИЛАГАТЕЛЬНЫЕ (САМОЕ ПЕРВОЕ! ПЕРЕД "был/стал", чтобы "ты был готов" работало)
    [/(ты|Ты) (не )?готов(?=\s|$|[,!?.;])/g, (match, ty, neg) => `${ty} ${neg || ''}готова`],
    [/(ты|Ты) (не )?рад(?=\s|$|[,!?.;])/g, (match, ty, neg) => `${ty} ${neg || ''}рада`],
    [/(ты|Ты) (не )?должен(?=\s|$|[,!?.;])/g, (match, ty, neg) => `${ty} ${neg || ''}должна`],
    [/(ты|Ты) (не )?обязан(?=\s|$|[,!?.;])/g, (match, ty, neg) => `${ty} ${neg || ''}обязана`],
    [/(ты|Ты) (не )?уверен(?=\s|$|[,!?.;])/g, (match, ty, neg) => `${ty} ${neg || ''}уверена`],
    [/(ты|Ты) (не )?прав(?=\s|$|[,!?.;])/g, (match, ty, neg) => `${ty} ${neg || ''}права`],
    [/(ты|Ты) (не )?согласен(?=\s|$|[,!?.;])/g, (match, ty, neg) => `${ty} ${neg || ''}согласна`],
    [/(ты|Ты) (не )?доволен(?=\s|$|[,!?.;])/g, (match, ty, neg) => `${ty} ${neg || ''}довольна`],
    [/(ты|Ты) (не )?свободен(?=\s|$|[,!?.;])/g, (match, ty, neg) => `${ty} ${neg || ''}свободна`],
    [/(ты|Ты) (не )?занят(?=\s|$|[,!?.;])/g, (match, ty, neg) => `${ty} ${neg || ''}занята`],
    [/(ты|Ты) (не )?устал(?=\s|$|[,!?.;])/g, (match, ty, neg) => `${ty} ${neg || ''}устала`],
    [/(ты|Ты) (не )?спокоен(?=\s|$|[,!?.;])/g, (match, ty, neg) => `${ty} ${neg || ''}спокойна`],
    [/(ты|Ты) (не )?счастлив(?=\s|$|[,!?.;])/g, (match, ty, neg) => `${ty} ${neg || ''}счастлива`],
    [/(ты|Ты) (не )?здоров(?=\s|$|[,!?.;])/g, (match, ty, neg) => `${ty} ${neg || ''}здорова`],
    [/(ты|Ты) (не )?болен(?=\s|$|[,!?.;])/g, (match, ty, neg) => `${ty} ${neg || ''}больна`],
    [/(ты|Ты) (не )?виноват(?=\s|$|[,!?.;])/g, (match, ty, neg) => `${ty} ${neg || ''}виновата`],

    // 2. СПЕЦИАЛЬНЫЕ глаголы на -ог/-ёг → -огла/-ёгла
    [/(ты|Ты) (не )?смог(?=\s|$|[,!?.;])/g, (match, ty, neg) => `${ty} ${neg || ''}смогла`],
    [/(ты|Ты) (не )?мог(?=\s|$|[,!?.;])/g, (match, ty, neg) => `${ty} ${neg || ''}могла`],

    // 3. Глаголы на -шел → -шла (ПЕРЕД -ел, иначе пришел станет пришела!)
    [/(ты|Ты) (не )?([а-яё]+)шел(?=\s|$|[,!?.;])/g, (match, ty, neg, verb) => `${ty} ${neg || ''}${verb}шла`],
    // Примеры: пришел→пришла, нашел→нашла, ушел→ушла

    // 4. Специальные случаи: был, стал, пропал и т.д.
    [/(ты|Ты) (не )?был(?=\s|$|[,!?.;])/g, (match, ty, neg) => `${ty} ${neg || ''}была`],
    [/(ты|Ты) (не )?стал(?=\s|$|[,!?.;])/g, (match, ty, neg) => `${ty} ${neg || ''}стала`],
    [/(ты|Ты) (не )?пропал(?=\s|$|[,!?.;])/g, (match, ty, neg) => `${ty} ${neg || ''}пропала`],
    // НЕ добавляем здесь "дописал" и "пропал" без "ты" - они обрабатываются в секции 11

    // 4. УНИВЕРСАЛЬНЫЕ возвратные глаголы на -ся (ПЕРЕД обычными, чтобы не сломать)
    [/(ты|Ты) (не )?([а-яё]+)ился(?=\s|$|[,!?.;])/g, (match, ty, neg, verb) => `${ty} ${neg || ''}${verb}илась`],
    [/(ты|Ты) (не )?([а-яё]+)ался(?=\s|$|[,!?.;])/g, (match, ty, neg, verb) => `${ty} ${neg || ''}${verb}алась`],
    [/(ты|Ты) (не )?([а-яё]+)ялся(?=\s|$|[,!?.;])/g, (match, ty, neg, verb) => `${ty} ${neg || ''}${verb}ялась`],
    // Примеры: справился→справилась, поделился→поделилась, занимался→занималась

    // 5. Глаголы на -ул → -ула
    [/(ты|Ты) (не )?([а-яё]+)ул(?=\s|$|[,!?.;])/g, (match, ty, neg, verb) => `${ty} ${neg || ''}${verb}ула`],
    // Примеры: вернул→вернула, заглянул→заглянула

    // 6. УНИВЕРСАЛЬНЫЕ глаголы прошедшего времени на -ял → -яла
    [/(ты|Ты) (не )?([а-яё]+)ял(?=\s|$|[,!?.;])/g, (match, ty, neg, verb) => `${ty} ${neg || ''}${verb}яла`],
    // Примеры: понял→поняла, стоял→стояла

    // 7. УНИВЕРСАЛЬНЫЕ глаголы прошедшего времени на -ил → -ила
    [/(ты|Ты) (не )?([а-яё]+)ил(?=\s|$|[,!?.;])/g, (match, ty, neg, verb) => `${ty} ${neg || ''}${verb}ила`],
    // Примеры: закончил→закончила, заметил→заметила

    // 8. УНИВЕРСАЛЬНЫЕ глаголы прошедшего времени на -ел → -ела
    [/(ты|Ты) (не )?([а-яё]+)ел(?=\s|$|[,!?.;])/g, (match, ty, neg, verb) => `${ty} ${neg || ''}${verb}ела`],
    // Примеры: увидел→увидела, захотел→захотела

    // 9. УНИВЕРСАЛЬНЫЕ глаголы прошедшего времени на -ал → -ала
    [/(ты|Ты) (не )?([а-яё]+)ал(?=\s|$|[,!?.;])/g, (match, ty, neg, verb) => `${ty} ${neg || ''}${verb}ала`],
    // Примеры: сделал→сделала, написал→написала, испытал→испытала

    // 10. УНИВЕРСАЛЬНЫЕ: глаголы БЕЗ "ты" (для случаев типа "если не успел", кнопок, вопросов)
    // ВАЖНО: НЕ используем ^ (начало строки), чтобы работало в середине предложения
    [/([а-яё]+)ывал(?=\s|$|[,!?.;?])/gi, '$1ывала'], // испытывал→испытывала, чувствовал→чувствовала
    [/([а-яё]+)ивал(?=\s|$|[,!?.;?])/gi, '$1ивала'], // говорил→говорила

    // Глаголы БЕЗ "ты" с отрицанием (не ответил, еще не успел, пока не написал)
    [/(не |еще не |пока не |так и не )([а-яё]+)ил(?=\s|$|[,!?.;?])/gi, (match, prefix, verb) => `${prefix}${verb}ила`], // "не ответил" → "не ответила"
    [/(не |еще не |пока не |так и не )([а-яё]+)ел(?=\s|$|[,!?.;?])/gi, (match, prefix, verb) => `${prefix}${verb}ела`], // "не успел" → "не успела"
    [/(не |еще не |пока не |так и не )([а-яё]+)ал(?=\s|$|[,!?.;?])/gi, (match, prefix, verb) => `${prefix}${verb}ала`], // "пока не написал" → "пока не написала"

    // Глаголы в вопросах БЕЗ "ты" (что еще ощутил, подробно рассказал, не побоялся)
    // ВАЖНО: идут ПОСЛЕ "ты" правил, чтобы не конфликтовать
    [/(что|еще|так|очень|подробно|хорошо|отлично)\s+([а-яё]+)ил(?=\s|$|[,!?.;?])/gi, (match, prefix, verb) => `${prefix} ${verb}ила`], // "что ощутил" → "что ощутила"
    [/(что|еще|так|очень|подробно|хорошо|отлично)\s+([а-яё]+)ал(?=\s|$|[,!?.;?])/gi, (match, prefix, verb) => `${prefix} ${verb}ала`], // "подробно рассказал" → "подробно рассказала"
    [/(что|еще|так|очень|подробно|хорошо|отлично)\s+([а-яё]+)ел(?=\s|$|[,!?.;?])/gi, (match, prefix, verb) => `${prefix} ${verb}ела`], // "еще успел" → "еще успела"

    // С заглавной буквы (для начала предложений)
    [/([А-ЯЁ])([а-яё]+)ал(?=\s|$|[,!?.;?])/g, (match, first, rest) => `${first}${rest}ала`], // Испытал→Испытала
    [/([А-ЯЁ])([а-яё]+)ил(?=\s|$|[,!?.;?])/g, (match, first, rest) => `${first}${rest}ила`], // Ответил→Ответила
    [/([А-ЯЁ])([а-яё]+)ел(?=\s|$|[,!?.;?])/g, (match, first, rest) => `${first}${rest}ела`], // Успел→Успела

    // 11. Глаголы в вопросах и кнопках (без "ты")
    // Важно: эти правила идут ПОСЛЕ "ты" правил, чтобы не конфликтовать
    // НЕ используем \b (не работает с кириллицей)
    [/(^|\s)([Вв]се|[Нн]е) описал(?=\s|$|[,!?.;?])/g, (match, prefix, word) => `${prefix}${word} описала`], // "Все описал" → "Все описала"
    [/Дописал(?=\s|$|[,!?.;?])/g, 'Дописала'], // "Дописал" → "Дописала" (заглавная)
    [/дописал(?=\s|$|[,!?.;?])/g, 'дописала'], // "дописал" → "дописала" (строчная)
    [/Сделал(?=\s|$|[,!?.;?])/g, 'Сделала'], // "Сделал" → "Сделала" (заглавная)
    [/сделал(?=\s|$|[,!?.;?])/g, 'сделала'], // "сделал" → "сделала" (строчная)
    [/Описал(?=\s|$|[,!?.;?☑️])/g, 'Описала'], // "Описал" → "Описала" (в кнопках, заглавная)
    [/описал(?=\s|$|[,!?.;?☑️])/g, 'описала'], // "описал" → "описала" (строчная)


    // ===== ПРИЧАСТИЯ =====
    // Универсальное правило для причастий на -ший → -шая
    [/(ты|Ты) ([а-яё]+)ший(?=\s|$|[,!?.;])/g, (match, ty, verb) => `${ty} ${verb}шая`],
    // Примеры: уставший→уставшая, занятый→занятая, готовый→готовая

    // Универсальное правило для причастий на -вший → -вшая
    [/(ты|Ты) ([а-яё]+)вший(?=\s|$|[,!?.;])/g, (match, ty, verb) => `${ty} ${verb}вшая`],

    // Универсальное правило для причастий на -ый → -ая
    [/(ты|Ты) ([а-яё]+)ый(?=\s|$|[,!?.;])/g, (match, ty, verb) => `${ty} ${verb}ая`],
    // Примеры: занятый→занятая, готовый→готовая
  ];

  let result = text;

  // Применяем все замены
  for (const [pattern, replacement] of replacements) {
    if (typeof replacement === 'string') {
      result = result.replace(pattern, replacement);
    } else {
      result = result.replace(pattern, replacement as any);
    }
  }

  return result;
}
